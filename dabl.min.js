(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(h){if(typeof h=="undefined"){h={}}var f,g=this.prototype,e,c;a=true;f=new this();a=false;for(e in h){f[e]=typeof h[e]=="function"&&typeof g[e]=="function"&&b.test(h[e])?(function(i,j){return function(){var l=this._super,k;this._super=g[i];k=j.apply(this,arguments);this._super=l;return k}})(e,h[e]):h[e]}function d(){if(!a&&this.init){this.init.apply(this,arguments)}}for(c in this){if(this.hasOwnProperty(c)){d[c]=this[c]}}d.prototype=f;d.prototype.constructor=d;d.extend=arguments.callee;return d}})();function _sPad(a){a=a+"";return a.length==2?a:"0"+a}Adapter=Class.extend({_db:null,_dbFile:null,init:function Adapter(a){this._dbFile=a;if(typeof Titanium=="undefined"){this._db={execute:function(){return null}};return}this._db=Titanium.Database.open(a)},execute:function(h,g){if(!g&&h instanceof QueryStatement){h=h.setConnection(this);return h.bindAndExecute()}var a=g?this._db.execute(h,g):this._db.execute(h),d=[],f,c,b,e;d.rowsAffected=this._db.rowsAffected;if(null===a){return d}while(a.isValidRow()){f={};for(c=0,b=a.getFieldCount();c<b;++c){e=a.getFieldName(c);f[e]=a.field(c)}d.push(f);a.next()}a.close();return d},count:function(c,b){c="SELECT COUNT(0) AS rCount FROM ("+c+") AS a";var a=this.execute(c,b);return parseInt(a[0].rCount,10)},transaction:function(a){a.apply(this);a.apply(this)},lastInsertId:function(){return this._db.lastInsertRowId},formatDate:function(a){if(!(a instanceof Date)){a=new Date(a)}return a.getFullYear()+"-"+_sPad(a.getMonth()+1)+"-"+_sPad(a.getDate())},formatDateTime:function(a){if(!(a instanceof Date)){a=new Date(a)}return this.formatDate(a)+" "+_sPad(a.getHours())+":"+_sPad(a.getMinutes())+":"+_sPad(a.getSeconds())},quoteIdentifier:function(a){return a},applyLimit:function(c,b,a){if(a>0){c=c+"\nLIMIT "+a+(b>0?" OFFSET "+b:"")}else{if(b>0){c=c+"\nLIMIT -1 OFFSET "+b}}return c},prepareInput:function(c){if(c instanceof Array){c=c.slice(0);for(var b=0,a=c.length;b<a;++b){c[b]=this.prepareInput(c[b])}return c}if(c===true||c===false){return c?1:0}if(c===null||typeof c=="undefined"){return"NULL"}if(parseInt(c,10)===c){return c}if(c instanceof Date){if(c.getSeconds()==0&&c.getMinutes()==0&&c.getHours()==0){c=this.formatDate(c)}else{c=this.formatDateTime(c)}}return this.quote(c)},quote:function(a){return"'"+a.replace("'","''")+"'"}});Adapter.connections={};Adapter.addConnection=function(a){this.connections[a]=new this(a)};Adapter.getConnection=function(a){if(!a){for(a in this.connections){return this.connections[a]}}else{if(a in this.connections){return this.connections[a]}}return new this(a)};Adapter.execute=function(){var a=this.getConnection();return a.execute.apply(a,arguments)};Adapter.transaction=function(){var a=this.getConnection();return a.transaction.apply(a,arguments)};Adapter.count=function(){var a=this.getConnection();return a.count.apply(a,arguments)};function Condition(d,c,b,a){this._conds=[];if(arguments.length!=0){this.addAnd.apply(this,arguments)}}Condition.QUOTE_LEFT=1;Condition.QUOTE_RIGHT=2;Condition.QUOTE_BOTH=3;Condition.QUOTE_NONE=4;Condition.prototype={_conds:null,_processCondition:function(c,j,b,a){switch(arguments.length){case 0:return null;break;case 1:if(c instanceof QueryStatement){return c}case 2:b=Query.EQUAL;case 3:a=Condition.QUOTE_RIGHT}var g=new QueryStatement,k,d,h,i,e;if(c instanceof Condition){k=c.getQueryStatement();if(!k){return null}k.setString("("+k.getString()+")");return k}if(a==Condition.QUOTE_LEFT||a==Condition.QUOTE_BOTH){g.addParam(c);c="?"}d=j instanceof Array||(j instanceof Query&&1!==j.getLimit());if(j instanceof Query){if(!j.getTable()){throw new Error("right does not have a table, so it cannot be nested.")}k=j.getQuery();if(!k){return null}j="("+k.getString()+")";g.addParams(k._params);if(a!=Condition.QUOTE_LEFT){a=Condition.QUOTE_NONE}}if(d){if(j instanceof Array&&2==j.length&&b==Query.BETWEEN){g.setString(c+" "+b+" ? AND ?");g.addParams(j);return g}switch(b){case Query.IN:case Query.EQUAL:b=Query.IN;break;case Query.NOT_IN:case Query.NOT_EQUAL:case Query.ALT_NOT_EQUAL:b=Query.NOT_IN;break;default:throw new Error(b+" unknown for comparing an array.")}if(j instanceof Array&&0==j.length){if(b==Query.IN){g.setString("(0 = 1)");return g}else{if(b==Query.NOT_IN){return null}}}else{if(a==Condition.QUOTE_RIGHT||a==Condition.QUOTE_BOTH){g.addParams(j);var f="(";for(i=0,e=j.length;i<e;++i){if(0<i){f+=","}f+="?"}j=f+")"}}}else{if(null===j&&(b==Query.NOT_EQUAL||b==Query.ALT_NOT_EQUAL)){b=Query.IS_NOT_NULL}else{if(null===j&&b==Query.EQUAL){b=Query.IS_NULL}}if(b==Query.IS_NULL||b==Query.IS_NOT_NULL){j=null}else{if(a==Condition.QUOTE_RIGHT||a==Condition.QUOTE_BOTH){g.addParam(j);j="?"}}}g.setString(c+" "+b+" "+j);return g},add:function(d,c,b,a){return this.addAnd.apply(this,arguments)},addAnd:function(e,d,b,a){var c,f;if(e.constructor===Object){for(c in e){this.addAnd(c,e[c])}return this}f=this._processCondition.apply(this,arguments);if(null!==f){f.sep="AND";this._conds.push(f)}return this},addOr:function(e,d,b,a){var c,f;if(e.constructor===Object){for(c in e){this.addOr(c,e[c])}return this}f=this._processCondition.apply(this,arguments);if(null!==f){f.sep="OR";this._conds.push(f)}return this},getQueryStatement:function(){if(0==this._conds.length){return null}var f=new QueryStatement,c="",b,e,d=this._conds,a=d.length;for(b=0;b<a;++b){e=d[b];c+="\n\t";if(0!=b){c+=((1==b&&d[0].sep=="OR")?"OR":e.sep)+" "}c+=e.getString();f.addParams(e._params)}f.setString(c);return f},toString:function(){return this.getQueryStatement().toString()}};function Query(b,a){this._columns=[];this._joins=[];this._orders=[];this._groups=[];this._where=new Condition;if(b){this.setTable(b,a)}return this}Query.ACTION_COUNT="COUNT";Query.ACTION_DELETE="DELETE";Query.ACTION_SELECT="SELECT";Query.EQUAL="=";Query.NOT_EQUAL="<>";Query.ALT_NOT_EQUAL="!=";Query.GREATER_THAN=">";Query.LESS_THAN="<";Query.GREATER_EQUAL=">=";Query.LESS_EQUAL="<=";Query.LIKE="LIKE";Query.NOT_LIKE="NOT LIKE";Query.CUSTOM="CUSTOM";Query.DISTINCT="DISTINCT";Query.IN="IN";Query.NOT_IN="NOT IN";Query.ALL="ALL";Query.IS_NULL="IS NULL";Query.IS_NOT_NULL="IS NOT NULL";Query.BETWEEN="BETWEEN";Query.CUSTOM_EQUAL="CUSTOM_EQUAL";Query.ILIKE="ILIKE";Query.NOT_ILIKE="NOT ILIKE";Query.JOIN="JOIN";Query.LEFT_JOIN="LEFT JOIN";Query.RIGHT_JOIN="RIGHT JOIN";Query.INNER_JOIN="INNER JOIN";Query.OUTER_JOIN="OUTER JOIN";Query.BINARY_AND="&";Query.BINARY_OR="|";Query.ASC="ASC";Query.DESC="DESC";Query.prototype={_action:Query.ACTION_SELECT,_columns:null,_table:null,_tableAlias:null,_extraTables:null,_joins:null,_where:null,_orders:null,_groups:null,_having:null,_limit:null,_offset:0,_distinct:false,setDistinct:function(a){if(typeof a=="undefined"){a=true}this._distinct=a==true},setAction:function(a){this._action=a;return this},getAction:function(){return this._action},addColumn:function(a){this._columns.push(a);return this},setColumns:function(a){this._columns=a.slice(0);return this},getColumns:function(){return this._columns},setGroups:function(a){this._groups=a;return this},getGroups:function(){return this._groups},setTable:function(b,a){if(b instanceof Query){if(!a){throw new Error("The nested query must have an alias.")}}if(a){this.setAlias(a)}this._table=b;return this},getTable:function(){return this._table},setAlias:function(a){this._tableAlias=a;return this},getAlias:function(){return this._tableAlias},addTable:function(a,b){if(a instanceof Query){if(!b){throw new Error("The nested query must have an alias.")}}else{if(typeof b=="undefined"){b=a}}if(this._extraTables==null){this._extraTables={}}this._extraTables[b]=a;return this},setWhere:function(a){this._where=a;return this},getWhere:function(){return this._where},addJoin:function(b,a,c){if(b instanceof QueryJoin){this._joins.push(b);return this}if(null===a){if(c==Query.JOIN||c==Query.INNER_JOIN){this.addTable(b);return this}a="1 = 1"}this._joins.push(new QueryJoin(b,a,c));return this},join:function(b,a,c){return this.addJoin(b,a,c)},innerJoin:function(b,a){return this.addJoin(b,a,Query.INNER_JOIN)},leftJoin:function(b,a){return this.addJoin(b,a,Query.LEFT_JOIN)},rightJoin:function(b,a){return this.addJoin(b,a,Query.RIGHT_JOIN)},outerJoin:function(b,a){return this.addJoin(b,a,Query.OUTER_JOIN)},getJoins:function(){return this._joins},setJoins:function(a){this._joins=a},addAnd:function(c,d,b,a){this._where.addAnd.apply(this._where,arguments);return this},add:function(c,d,b,a){return this.addAnd.apply(this,arguments)},andNot:function(a,b){return this.addAnd(a,b,Query.NOT_EQUAL)},andLike:function(a,b){return this.addAnd(a,b,Query.LIKE)},andNotLike:function(a,b){return this.addAnd(a,b,Query.NOT_LIKE)},andGreater:function(a,b){return this.addAnd(a,b,Query.GREATER_THAN)},andGreaterEqual:function(a,b){return this.addAnd(a,b,Query.GREATER_EQUAL)},andLess:function(a,b){return this.addAnd(a,b,Query.LESS_THAN)},andLessEqual:function(a,b){return this.addAnd(a,b,Query.LESS_EQUAL)},andNull:function(a){return this.addAnd(a,null)},andNotNull:function(a){return this.addAnd(a,null,Query.NOT_EQUAL)},andBetween:function(a,c,b){return this.addAnd(a,[c,b],Query.BETWEEN)},addOr:function(c,d,b,a){this._where.addOr.apply(this._where,arguments);return this},orNot:function(a,b){return this.addOr(a,b,Query.NOT_EQUAL)},orLike:function(a,b){return this.addOr(a,b,Query.LIKE)},orNotLike:function(a,b){return this.addOr(a,b,Query.NOT_LIKE)},orGreater:function(a,b){return this.addOr(a,b,Query.GREATER_THAN)},orGreaterEqual:function(a,b){return this.addOr(a,b,Query.GREATER_EQUAL)},orLess:function(a,b){return this.addOr(a,b,Query.LESS_THAN)},orLessEqual:function(a,b){return this.addOr(a,b,Query.LESS_EQUAL)},orNull:function(a){return this.addOr(a,null)},orNotNull:function(a){return this.addOr(a,null,Query.NOT_EQUAL)},orBetween:function(a,c,b){return this.addOr(a,[c,b],Query.BETWEEN)},groupBy:function(a){this._groups.push(a);return this},setHaving:function(a){this._having=a;return this},getHaving:function(){return this._having},orderBy:function(b,a){if(null!==a&&typeof a!="undefined"){a=a.toUpperCase();if(a!=Query.ASC&&a!=Query.DESC){throw new Error(a+" is not a valid sorting direction.")}b=b+" "+a}this._orders.push(b);return this},setLimit:function(a){a=parseInt(a);if(isNaN(a)){throw new Error("Not a number")}this._limit=a;return this},getLimit:function(){return this._limit},setOffset:function(a){a=parseInt(a);if(isNaN(a)){throw new Error("Not a number")}this._offset=a;return this},getQuery:function(d){if(!d){d=new Adapter}var i=new QueryStatement(d),b,g,c,k,f,a,h,j,e;b="";switch(this._action.toUpperCase()){default:case Query.ACTION_COUNT:case Query.ACTION_SELECT:g=this.getColumnsClause(d);i.addParams(g._params);b+="SELECT "+g.getString();break;case Query.ACTION_DELETE:b+="DELETE";break}c=this.getTablesClause(d);i.addParams(c._params);b+="\nFROM "+c.getString();if(this._joins.length!=0){for(k=0,f=this._joins.length;k<f;++k){a=this._joins[k],h=a.getQueryStatement(d);b+="\n\t"+h.getString();i.addParams(h._params)}}j=this.getWhereClause();if(null!==j){b+="\nWHERE "+j.getString();i.addParams(j._params)}if(this._groups.length!=0){b+="\nGROUP BY "+this._groups.join(", ")}if(null!==this.getHaving()){e=this.getHaving().getQueryStatement();if(e){b+="\nHAVING "+e.getString();i.addParams(e._params)}}if(this._action!=Query.ACTION_COUNT&&this._orders.length!=0){b+="\nORDER BY "+this._orders.join(", ")}if(null!==this._limit){if(d){b=d.applyLimit(b,this._offset,this._limit)}else{b+="\nLIMIT "+(this._offset?this._offset+", ":"")+this._limit}}if(this._action==Query.ACTION_COUNT&&this.needsComplexCount()){b="SELECT count(0)\nFROM ("+b+") a"}i.setString(b);return i},getTablesClause:function(d){var j=this.getTable(),f,e,c,h,a,i,g,b;if(!j){throw new Error("No table specified.")}f=new QueryStatement(d),e=this.getAlias();if(j instanceof Query){c=j.getQuery(d),a="("+c.getString()+")"}else{c=null;a=j}switch(this._action.toUpperCase()){case Query.ACTION_COUNT:case Query.ACTION_SELECT:if(null!==c){f.addParams(c._params)}if(e){a=a+" AS "+e}if(this._extraTables!=null){for(h in this._extraTables){i=this._extraTables[h];if(i instanceof Query){g=i.getQuery(d),b="("+g.getString()+") AS "+h;f.addParams(g._params)}else{b=i;if(h!=i){b=b+" AS "+h}}a=a+", "+b}}f.setString(a);break;case Query.ACTION_DELETE:if(null!==c){f.addParams(c._params)}if(e){a=a+" AS "+e}f.setString(a);break;default:break}return f},hasAggregates:function(){if(this._groups.length!=0){return true}for(var b=0,a=this._columns.length;b<a;++b){if(this._columns[b].indexOf("(")!=-1){return true}}return false},needsComplexCount:function(){return this.hasAggregates()||null!==this._having||this._distinct},getColumnsClause:function(a){var j=this.getTable(),b,g=new QueryStatement(a),e=this.getAlias(),c=this._action.toUpperCase(),h,f,i,d;if(c==Query.ACTION_DELETE){return g}if(!j){throw new Error("No table specified.")}if(c==Query.ACTION_COUNT){if(!this.needsComplexCount()){g.setString("count(0)");return g}if(this._groups.length!=0){g.setString(this._groups.join(", "));return g}if(!this._distinct&&null===this.getHaving()&&this._columns.length!=0){i=[];for(h=0,f=this._columns.length;h<f;++h){b=this._columns[h];if(b.indexOf("(")==-1){continue}i.push(b)}if(i.length!=0){g.setString(i.join(", "));return g}}}if(this._columns.length!=0){d=this._columns.join(", ")}else{if(e){d=e+".*"}else{d=j+".*"}}if(this._distinct){d="DISTINCT "+d}g.setString(d);return g},getWhereClause:function(a){return this._where.getQueryStatement()},toString:function(){if(!this.getTable()){this.setTable("{UNSPECIFIED-TABLE}")}return this.getQuery().toString()},doCount:function(a){if(!this.getTable()){throw new Error("No table specified.")}this.setAction(Query.ACTION_COUNT);return parseInt(this.getQuery(a).bindAndExecute()[0],10)},doDelete:function(a){if(!this.getTable()){throw new Error("No table specified.")}this.setAction(Query.ACTION_DELETE);return this.getQuery(a).bindAndExecute().rowsAffected},doSelect:function(a){if(!this.getTable()){throw new Error("No table specified.")}this.setAction(Query.ACTION_SELECT);return this.getQuery(a).bindAndExecute()}};var isIdent=/^\w+\.\w+$/;QueryJoin=function QueryJoin(b,a,c){if(arguments.length<3){c=Query.JOIN}if(!(b instanceof Query)&&!(a instanceof Condition)&&isIdent.test(a)&&isIdent.test(b)){this._isLikePropel=true;this._leftColumn=b;this._rightColumn=a;this.setTable(a.substring(0,a.indexOf(".")));this.setJoinType(c);return}this.setTable(b).setOnClause(a).setJoinType(c)};QueryJoin.prototype={_table:null,_alias:null,_onClause:null,_isLikePropel:false,_leftColumn:null,_rightColumn:null,_joinType:Query.JOIN,toString:function(){if(!this.getTable()){this.setTable("{UNSPECIFIED-TABLE}")}return this.getQueryStatement().toString()},setTable:function(b){var c=b.lastIndexOf(" "),a=b.toUpperCase().lastIndexOf(" AS ");if(a!=c-3){a=-1}if(c!=-1){this.setAlias(b.substr(c+1));b=b.substring(0,a===-1?c:a)}this._table=b;return this},setAlias:function(a){this._alias=a;return this},setOnClause:function(a){this._isLikePropel=false;this._onClause=a;return this},setJoinType:function(a){this._joinType=a;return this},getQueryStatement:function(f){var e,d=this._table,b=this._onClause,g=this._joinType,c=this._alias,a;if(d instanceof Query){e=d.getQuery(f);d="("+e.getString()+")";e.setString("")}else{e=new QueryStatement(f)}if(c){d+=" AS "+c}if(this._isLikePropel){b=this._leftColumn+" = "+this._rightColumn}else{if(null===b){b="1 = 1"}else{if(b instanceof Condition){a=b.getQueryStatement();b=a.getString();e.addParams(a.getParams())}}}if(""!==b){b="ON ("+b+")"}e.setString(g+" "+d+" "+b);return e},getTable:function(){return this._table},getAlias:function(){return this._alias},getOnClause:function(){if(this._isLikePropel){return this._leftColumn+" = "+this._rightColumn}return this._onClause},getJoinType:function(){return this._joinType}};function QueryStatement(a){this._params=[];if(a){this._conn=a}}QueryStatement.embedParams=function(e,h,f){if(f){h=f.prepareInput(h)}var g="?";if(e.split(g).length-1!=h.length){throw new Error("The number of occurances of "+g+" do not match the number of _params.")}if(h.length==0){return e}var b=e.length,c=g.length,a,d;for(a=h.length-1;a>=0;--a){d=h[a];b=e.lastIndexOf(g,b);if(b==-1){throw new Error("The number of occurances of "+g+" do not match the number of _params.")}e=e.substring(0,b)+d+e.substr(b+c)}return e};QueryStatement.prototype={_queryString:"",_params:null,_conn:null,setConnection:function(a){this._conn=a},getConnection:function(){return this._conn},setString:function(a){this._queryString=a},getString:function(){return this._queryString},addParams:function(a){this._params=this._params.concat(a)},setParams:function(a){this._params=a.slice(0)},addParam:function(a){this._params.push(a)},getParams:function(){return this._params.slice(0)},toString:function(){return QueryStatement.embedParams(this._queryString,this._params.slice(0),this._conn)},bindAndExecute:function(){var a=this._conn;a=a||Adapter.getConnection();return a.execute(this._queryString,this._params)}};function addGetterAndSetter(a,b,c){a.__defineGetter__(b,function(){var d=this["_"+b];return typeof d=="undefined"?null:d});a.__defineSetter__(b,function(d){d=this.coerceColumnValue(b,d,c);if(this["_"+b]===d){return}this._modifiedColumns[b]=b;this["_"+b]=d})}Model=Class.extend({_modifiedColumns:{},_isNew:true,_validationErrors:[],init:function Model(){this._modifiedColumns={};this._validationErrors=[]},toString:function(){return this.constructor.name+":"+this.getPrimaryKeyValues().join("-")},copy:function(){var d=new this.constructor,c=this.constructor._primaryKeys,b,a,e;d.fromArray(this.toArray());for(b=0,a=c.length;b<a;++b){e=c[b];d[e]=null}return d},isModified:function(){return this.getModifiedColumns().length!=0},isColumnModified:function(a){var b,c;for(b in this._modifiedColumns){c=this._modifiedColumns[b];if(a.toLowerCase()==c.toLowerCase()){return true}}return false},getModifiedColumns:function(){return this._modifiedColumns},coerceColumnValue:function(b,g,e){if(null===e){e=this.constructor.getColumnType(b)}var d=Model.isTemporalType(e),c=Model.isNumericType(e),f,a;if(c||d){if(""===g){g=null}else{if(null!==g){if(c){if(Model.isIntegerType(e)){f=parseInt(g,10);if(typeof g=="undefined"||f.toString()!=g.toString()){throw new Error(g+" is not a valid integer")}g=f}else{a=parseFloat(g,10);if(typeof g=="undefined"||a.toString()!=g.toString()){throw new Error(g+" is not a valid float")}}}else{if(d){g=Model.coerceTemporalValue(g,e,this.constructor.getConnection())}}}}}return g},resetModified:function(){this._modifiedColumns={};return this},fromArray:function(a){for(var b in this.constructor._columns){if(!(b in a)){continue}this[b]=a[b]}return this},toArray:function(){var b={},a;for(a in this.constructor._columns){b[a]=this["_"+a]}return b},hasPrimaryKeyValues:function(){var c=this.constructor._primaryKeys,b,a,d;if(c.length==0){return false}for(b=0,a=c.length;b<a;++b){d=c[b];if(this["_"+d]===null){return false}}return true},getPrimaryKeyValues:function(){var c=[],d=this.constructor._primaryKeys,b,a,e;for(b=0,a=d.length;b<a;++b){e=d[b];c.push(this["_"+e])}return c},validate:function(){this._validationErrors=[];return true},getValidationErrors:function(){return this._validationErrors},destroy:function(){var d=this.constructor._primaryKeys,g=new Query,c,b,f,e,a;if(d.length==0){throw new Error("This table has no primary keys")}for(c=0,b=d.length;c<b;++c){f=d[c];e=this["_"+f];if(e===null){throw new Error("Cannot delete using NULL primary key.")}g.addAnd(f,e)}g.setTable(this.constructor.getTableName());a=this.constructor.doDelete(g,false);return a},save:function(){if(!this.validate()){throw new Error("Cannot save "+this.constructor.getClassName()+" with validation errors.")}if(this.constructor._primaryKeys.length==0){throw new Error("Cannot save without primary keys")}if(this.isNew()&&this.constructor.hasColumn("created")&&!this.isColumnModified("created")){this.created=CURRENT_TIMESTAMP}if((this.isNew()||this.isModified())&&this.constructor.hasColumn("updated")&&!this.isColumnModified("updated")){this.updated=CURRENT_TIMESTAMP}if(this.isNew()){return this.insert()}return this.update()},archive:function(){if(!this.constructor.hasColumn("archived")){throw new Error('Cannot call archive on models without "archived" column')}if(null!==this.archived&&typeof this.archived!="undefined"){throw new Error("This "+this.constructor.getClassName()+" is already archived.")}this.archived=CURRENT_TIMESTAMP;return this.save()},isNew:function(){return this._isNew},setNew:function(a){this._isNew=(a==true);return this},insert:function(){var b=this.constructor.getConnection(),d=this.constructor.getPrimaryKey(),h=this.constructor.getTableName(),c,g,i,f,e={},a;for(c in this.constructor._columns){g=this["_"+c];if((g===null||typeof g=="undefined")&&!this.isColumnModified(c)){continue}e[c]=g}i=this.constructor.insert(h,e,b);f=i.rowsAffected;if(d&&this.constructor.isAutoIncrement()){a=b.lastInsertId();if(null!==a){this[d]=a}}this.resetModified();this.setNew(false);return f},update:function(e){if(typeof e=="object"){this.fromaArray(e)}if(this.constructor._primaryKeys.length==0){throw new Error("This table has no primary keys")}var c=this.constructor.getConnection(),n=c.quoteIdentifier(this.constructor.getTableName()),f=[],m=[],k=[],j=new QueryStatement(c),b=this.constructor._primaryKeys,i=this.getModifiedColumns(),l,g,o,d,h,a,p;for(l=0,g=i.length;l<g;++l){o=i[l];f.push(c.quoteIdentifier(o)+" = ?");m.push(this["_"+o])}if(f.length==0){return 0}for(l=0,g=b.length;l<g;++l){d=b[l],h=this["_"+d];if(h===null||typeof h=="undefined"){throw new Error("Cannot update with NULL primary key.")}k.push(c.quoteIdentifier(d)+" = ?");m.push(h)}a="UPDATE "+n+" SET "+f.join(", ")+" WHERE "+k.join(" AND ");j.setString(a);j.setParams(m);p=j.bindAndExecute();this.resetModified();return p.rowsAffected}});Model.COLUMN_TYPE_TEXT="TEXT";Model.COLUMN_TYPE_NUMERIC="NUMERIC";Model.COLUMN_TYPE_INTEGER="INTEGER";Model.COLUMN_TYPE_BLOB="BLOB";Model.COLUMN_TYPE_DATE="DATE";Model.COLUMN_TYPE_TIME="TIME";Model.COLUMN_TYPE_TIMESTAMP="TIMESTAMP";Model.COLUMN_TYPES={TEXT:Model.COLUMN_TYPE_TEXT,NUMERIC:Model.COLUMN_TYPE_NUMERIC,INTEGER:Model.COLUMN_TYPE_INTEGER,BLOB:Model.COLUMN_TYPE_BLOB,DATE:Model.COLUMN_TYPE_DATE,TIME:Model.COLUMN_TYPE_TIME,TIMESTAMP:Model.COLUMN_TYPE_TIMESTAMP};Model.TEXT_TYPES={TEXT:Model.COLUMN_TYPE_TEXT,DATE:Model.COLUMN_TYPE_DATE,TIME:Model.COLUMN_TYPE_TIME,TIMESTAMP:Model.COLUMN_TYPE_TIMESTAMP};Model.INTEGER_TYPES={INTEGER:Model.COLUMN_TYPE_INTEGER};Model.BLOB_TYPES={BLOB:Model.COLUMN_TYPE_BLOB};Model.TEMPORAL_TYPES={DATE:Model.COLUMN_TYPE_DATE,TIME:Model.COLUMN_TYPE_TIME,TIMESTAMP:Model.COLUMN_TYPE_TIMESTAMP};Model.NUMERIC_TYPES={INTEGER:Model.COLUMN_TYPE_INTEGER,NUMERIC:Model.COLUMN_TYPE_NUMERIC};Model.isColumnType=function(a){return(a in Model.COLUMN_TYPES)};Model.isTemporalType=function(a){return(a in this.TEMPORAL_TYPES)};Model.isTextType=function(a){return(a in this.TEXT_TYPES)};Model.isNumericType=function(a){return(a in this.NUMERIC_TYPES)};Model.isIntegerType=function(a){return(a in this.INTEGER_TYPES)};Model.isBlobType=function(a){return(a in Model.BLOB_TYPES)};Model.insert=function(i,d,b){var e=[],j=[],g=[],f=new QueryStatement(b),c,h,a;for(c in d){h=d[c];e.push(c);j.push(h);g.push("?")}a="INSERT INTO "+i+" ("+e.join(",")+") VALUES ("+g.join(",")+") ";f.setString(a);f.setParams(j);return f.bindAndExecute()};Model.fromResult=function(b){var e=[],d,a,c,f,g;for(d=0,a=b.length;d<a;++d){c=new this,f=b[d];for(g in f){c[g]=f[g]}c.setNew(false);e.push(c)}return e};Model.coerceTemporalValue=function(d,c){var a,b;if(d instanceof Array){for(a=0,len=d;a<len;++a){d[a]=this.coerceTemporalValue(d[a],c)}return d}b=new Date(d);if(isNaN(b.getTime())){throw new Error(d+" is not a valid date")}return b};Model._table=null;Model._primaryKeys=null;Model._isAutoIncrement=true;Model._columns=null;Model._connectionName="default_connection";Model.getConnection=function(){return Adapter.getConnection(this._connectionName)};Model.getTableName=function(){return this._table};Model.getColumns=function(){return this._columns.slice(0)};Model.getColumnType=function(a){return this._columns[a]};Model.hasColumn=function(a){a=a.toLowerCase();for(var b in this._columns){if(b.toLowerCase()==a){return true}}return false};Model.getPrimaryKeys=function(){return this._primaryKeys.slice(0)};Model.getPrimaryKey=function(){return this._primaryKeys.length==1?this._primaryKeys[0]:null};Model.isAutoIncrement=function(){return this._isAutoIncrement};Model.retrieveByPK=function(a){return this.retrieveByPKs(a)};Model.retrieveByPKs=function(){var c=this._primaryKeys,f=new Query,b,a,e,d;for(b=0,a=c.length;b<a;++b){e=c[b],d=arguments[b];if(d===null||typeof d=="undefined"){return null}f.add(e,d)}return this.doSelect(f,true).shift()};Model.retrieveByColumn=function(c,b){var a=new Query().add(c,b).setLimit(1);return this.doSelect(a).shift()};Model.findBy=Model.retrieveByColumn;Model.fetchSingle=function(a){return this.fetch(a).shift()};Model.fetch=function(b){var a=this.getConnection().query(b);return this.fromResult(a)};Model.getAll=function(a){var b=this.getConnection(),c=b.quoteIdentifier(this.getTableName());return this.fetch("SELECT * FROM "+c+" "+a)};Model.doCount=function(b){b=b||new Query;var a=this.getConnection();if(!b.getTable()||this.getTableName()!=b.getTable()){b.setTable(this.getTableName())}return b.doCount(a)};Model.doDelete=function(a){if(!a.getTable()||this.getTableName()!=a.getTable()){a.setTable(this.getTableName())}return a.doDelete(this.getConnection())};Model.doSelect=function(a){return this.fromResult(this.doSelectRS(a))};Model.doSelectRS=function(a){a=a||new Query;if(!a.getTable()||this.getTableName()!=a.getTable()){a.setTable(this.getTableName())}return a.doSelect(this.getConnection())};Model.models={};Model.create=function(c){var d,e,b,a,f;if(typeof c.connectionName=="undefined"){d=Adapter.getConnection();if(!d){throw new Error("No database specified or found.")}c.connectionName=d._dbFile}if(typeof c.table=="undefined"){throw new Error("Must provide a table when exending Model")}if(typeof c.columns=="undefined"){throw new Error("Must provide columns when exending Model")}if(typeof c.primaryKeys=="undefined"){throw new Error("Must provide primaryKeys when exending Model")}e=this.extend(c.instancePrototype);for(b in c.columns){a=c.columns[b]=c.columns[b].toUpperCase();if(!Model.isColumnType(a)){throw new Error(a+" is not a valide DABL/SQLite column type")}addGetterAndSetter(e.prototype,b,a)}for(f in c){switch(f){case"connectionName":case"table":case"columns":case"primaryKeys":e["_"+f]=c[f];break;default:e[f]=c[f];break}}Model.models[c.table]=e;return e};Migration={};Migration.schema=Model.create({table:"schema_definitions",primaryKeys:["id"],columns:{id:"INTEGER",table_name:"TEXT",column_names:"TEXT",column_types:"TEXT"}});Migration.migrate=function(d){if(!d){d={}}var c,f={},b,a,e;if(d.refresh){for(c in Model.models){Adapter.execute("DROP TABLE IF EXISTS "+c)}Migration.setupSchema(true)}else{Migration.setupSchema()}if(Migration.migrations){f=Migration.migrations}if(f[1]&&f[1].constructor===Object){b=Migration.currentSchemaVersion();a=Infinity;if(d.number!==null&&typeof d.number!="undefined"){a=d.number}else{if(typeof d==="number"){a=d}}e=b;do{if(e===a){return}else{if(e<a){e+=1;if(f[e]!==null&&typeof f[e]!="undefined"){f[e].up()}else{break}}else{f[e].down();e-=1}}Migration.updateSchemaVersion(e)}while(f[e])}else{}};Migration.setupSchema=function(a){var b;Migration.createTable("schema_migrations",{version:"TEXT"});if(Adapter.count("SELECT * FROM schema_migrations")===0){b="INSERT INTO schema_migrations (version) VALUES(0)";Adapter.execute(b)}if(a&&Adapter.count("SELECT * FROM schema_migrations")===1){b="UPDATE schema_migrations set version = 0";Adapter.execute(b)}Migration.createTable("schema_definitions",{id:"INTEGER",table_name:"TEXT",column_names:"TEXT",column_types:"TEXT"})};Migration.writeSchema=function(c,h){if(c==="schema_definitions"||c==="schema_migrations"){return}var f=[],b=[],a,g,d,e;for(a in h){f.push(a);b.push(h[a])}g=f.join();d=f.join();e=Migration.schema.findBy("table_name",c);if(e){e.column_names=g;e.column_types=d;e.save()}else{e=new Migration.schema;e.fromArray({table_name:c,column_names:g,column_types:d});e.save()}};Migration.readSchema=function(c){if(c==="schema_definitions"||c==="schema_migrations"){return null}var f=Migration.schema.findBy("table_name",c),b=f.column_names.split(","),h=f.column_types.split(","),g={},e,a=b.length,d;for(e=0;e<a;++e){d=b[e];g[d]=h[e]}return g};Migration.currentSchemaVersion=function(){var a="SELECT version FROM schema_migrations LIMIT 1";return parseInt(Adapter.execute(a)[0].version,10)};Migration.updateSchemaVersion=function(a){var b="UPDATE schema_migrations SET version = "+a;Adapter.execute(b)};Migration.modifyColumn=function(b,a,c){if(!c){throw new Error("MIGRATION_EXCEPTION: Not a valid column modification")}var g=Migration.readSchema(b),e={},d,f;for(d in g){f=g[d];switch(c.modification){case"remove":if(d!==a){e[d]=f}break;case"rename":if(d!==a){e[d]=f}else{e[c.newName]=f}break;case"change":if(d!==a){e[d]=f}else{e[d]=c.newType}break;default:throw ("MIGRATION_EXCEPTION: Not a valid column modification")}}Adapter.transaction(function(){var k=Adapter.execute("SELECT * FROM "+b);if(k.length!=0){throw new Error("Modify column not quite ready yet...")}Migration.dropTable(b);Migration.createTable(b,e);for(var l=0,h=k.length;l<h;++l){var j=k[l];switch(c.modification){case"remove":delete j[a];Model.insert(b,j,Adapter.getConnection());break;case"rename":j[c.newName]=j[a];delete j[a];Model.insert(b,j,Adapter.getConnection());break;case"change":Model.insert(b,j,Adapter.getConnection());break;default:throw ("MIGRATION_EXCEPTION: Not a valid column modification")}}})};Migration.createTable=function(a,b){if(!a||!b){return}var e="CREATE TABLE IF NOT EXISTS "+a,c,d;if(b){e+="(";for(c in b){d=b[c];if(c==="id"){e+="id INTEGER PRIMARY KEY AUTOINCREMENT, "}else{e+=(c+" "+d.toString().toUpperCase()+", ")}}e=e.substr(0,e.length-2);e+=")";Adapter.execute(e)}Migration.writeSchema(a,b)};Migration.dropTable=function(a){var c="DROP TABLE IF EXISTS "+a,b;Adapter.execute(c);b=Migration.schema.findBy("table_name",a);b.destroy()};Migration.renameTable=function(b,a){var d="ALTER TABLE "+b+" RENAME TO "+a,c;Adapter.execute(d);c=Migration.schema.findBy("table_name",b);c.table_name=a;c.save()};Migration.addColumn=function(c,b,a){var e="ALTER TABLE "+c+" ADD COLUMN "+b+" "+a.toUpperCase(),d;Adapter.execute(e);d=Migration.readSchema(c);d[b]=a;Migration.writeSchema(c,d)};Migration.removeColumn=function(b,a){Migration.modifyColumn(b,a,{modification:"remove"})};Migration.renameColumn=function(b,a,d){var c={modification:"rename",newName:d};Migration.modifyColumn(b,a,c)};Migration.changeColumn=function(b,a,d){var c={modification:"change",newType:d};Migration.modifyColumn(b,a,c)};Migration.addIndex=function(b,a){var c="CREATE INDEX IF NOT EXISTS "+b+"_"+a+"_index ON "+b+" ("+a+")";Adapter.execute(c)};Migration.removeIndex=function(b,a){var c="DROP INDEX IF EXISTS "+b+"_"+a+"_index";Adapter.execute(c)};