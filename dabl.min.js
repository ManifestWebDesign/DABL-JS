(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(h){var g=this.prototype;if(typeof h=="undefined"){h={}}a=true;var f=new this();a=false;for(var e in h){f[e]=typeof h[e]=="function"&&typeof g[e]=="function"&&b.test(h[e])?(function(i,j){return function(){var l=this._super;this._super=g[i];var k=j.apply(this,arguments);this._super=l;return k}})(e,h[e]):h[e]}function d(){if(!a&&this.init){this.init.apply(this,arguments)}}for(var c in this){if(this.hasOwnProperty(c)){d[c]=this[c]}}d.prototype=f;d.prototype.constructor=d;d.extend=arguments.callee;return d}})();function _sPad(a){a=a+"";return a.length==2?a:"0"+a}Adapter=Class.extend({_db:null,_dbFile:null,init:function Adapter(a){this._dbFile=a;this._db=Titanium.Database.open(a)},execute:function(h,g){if(!g&&h instanceof QueryStatement){h=h.setConnection(this);return h.bindAndExecute()}Ti.API.info("SQL: "+h);var a=g?this._db.execute(h,g):this._db.execute(h),d=[];d.rowsAffected=this._db.rowsAffected;if(null===a){return d}while(a.isValidRow()){var f={};for(var c=0,b=a.getFieldCount();c<b;++c){var e=a.getFieldName(c);f[e]=a.field(c)}d.push(f);a.next()}a.close();return d},count:function(c,b){c="SELECT COUNT(0) AS rCount FROM ("+c+") AS a";var a=this.execute(c,b);return parseInt(a[0].rCount,10)},transaction:function(a){a.apply(this);a.apply(this)},lastInsertId:function(){return this._db.lastInsertRowId},formatDate:function(a){if(!(a instanceof Date)){a=new Date(a)}return a.getFullYear()+"-"+_sPad(a.getMonth()+1)+"-"+_sPad(a.getDate())},formatDateTime:function(a){if(!(a instanceof Date)){a=new Date(a)}return this.formatDate(a)+" "+_sPad(a.getHours())+":"+_sPad(a.getMinutes())+":"+_sPad(a.getSeconds())},quoteIdentifier:function(c){if(c instanceof Array){for(var b=0,a=c.length;b<a;b++){c[b]=this.quoteIdentifier(c[b])}return c}if(c.indexOf("[")!=-1||c.indexOf(" ")!=-1||c.indexOf("(")!=-1||c.indexOf("*")!=-1){return c}return"["+c.replace(".","].[")+"]"},applyLimit:function(c,b,a){if(a>0){c=c+"\nLIMIT "+a+(b>0?" OFFSET "+b:"")}else{if(b>0){c=c+"\nLIMIT -1 OFFSET "+b}}return c},prepareInput:function(c){if(c instanceof Array){c=c.slice(0);for(var b=0,a=c.length;b<a;b++){c[b]=this.prepareInput(c[b])}return c}if(c===true||c===false){return c?1:0}if(c===null||typeof c=="undefined"){return"NULL"}if(parseInt(c,10)===c){return c}if(c instanceof Date){if(c.getSeconds()==0&&c.getMinutes()==0&&c.getHours()==0){c=this.formatDate(c)}else{c=this.formatDateTime(c)}}return this.quote(c)},quote:function(a){return"'"+a.replace("'","''")+"'"}});Adapter.connections={};Adapter.addConnection=function(a){this.connections[a]=new this(a)};Adapter.getConnection=function(a){if(!a){for(a in this.connections){return this.connections[a]}}else{if(a in this.connections){return this.connections[a]}}return new this(a)};Adapter.execute=function(){var a=this.getConnection();return a.execute.apply(a,arguments)};Adapter.transaction=function(){var a=this.getConnection();return a.transaction.apply(a,arguments)};Adapter.count=function(){var a=this.getConnection();return a.count.apply(a,arguments)};function Condition(d,c,b,a){this._ands=[];this._ors=[];if(typeof d!="undefined"){this.addAnd.apply(this,arguments)}}Condition.QUOTE_LEFT=1;Condition.QUOTE_RIGHT=2;Condition.QUOTE_BOTH=3;Condition.QUOTE_NONE=4;Condition.prototype={_ands:null,_ors:null,_processCondition:function(d,i,c,a){if(typeof c=="undefined"){c=Query.EQUAL}if(typeof d=="undefined"){return null}if(arguments.length==1&&d instanceof QueryStatement){return d}var f=new QueryStatement,j,e;if(d instanceof Condition){j=d.getQueryStatement();if(!j){return null}j.setString("("+j.getString()+")");return j}if(typeof a=="undefined"){if(parseInt(c,10)===c){a=c;c=Query.EQUAL}else{a=Condition.QUOTE_RIGHT}}if(a==Condition.QUOTE_LEFT||a==Condition.QUOTE_BOTH){f.addParam(d);d=QueryStatement.PARAM}else{f.addIdentifier(d);d=QueryStatement.IDENTIFIER}e=false;if(i instanceof Array||(i instanceof Query&&i.getLimit()!==1)){e=true}if(i instanceof Query){if(!i.getTable()){throw new Error("right does not have a table, so it cannot be nested.")}j=i.getQuery();if(!j){return null}i="("+j.getString()+")";f.addParams(j.getParams());f.addIdentifiers(j.getIdentifiers());if(a!=Condition.QUOTE_LEFT){a=Condition.QUOTE_NONE}}if(e){if(i instanceof Array&&i.length==2&&c==Query.BETWEEN){f.setString(d+" "+c+" "+QueryStatement.PARAM+" AND "+QueryStatement.PARAM);f.addParams(i);return f}switch(c){case Query.IN:case Query.EQUAL:c=Query.IN;break;case Query.NOT_IN:case Query.NOT_EQUAL:case Query.ALT_NOT_EQUAL:c=Query.NOT_IN;break;default:throw new Error(c+" unknown for comparing an array.")}if(i instanceof Array&&!i){if(c==Query.IN){f.setString("(0 = 1)");f.setParams([]);f.setIdentifiers([]);return f}else{if(c==Query.NOT_IN){return null}}}if(a==Condition.QUOTE_RIGHT||a==Condition.QUOTE_BOTH){f.addParams(i);var g=[];for(var h=0,b=i.length;h<b;h++){g.push(QueryStatement.PARAM)}i="("+g.join(",")+")"}}else{if(i===null&&(c==Query.NOT_EQUAL||c==Query.ALT_NOT_EQUAL)){c=Query.IS_NOT_NULL}else{if(i===null&&c==Query.EQUAL){c=Query.IS_NULL}}if(c==Query.IS_NULL||c==Query.IS_NOT_NULL){i=null}else{if(a==Condition.QUOTE_RIGHT||a==Condition.QUOTE_BOTH){f.addParam(i);i=QueryStatement.PARAM}}}f.setString(d+" "+c+" "+i);return f},add:function(d,c,b,a){return this.addAnd.apply(this,arguments)},addAnd:function(e,d,b,a){if(typeof e=="object"){for(var c in e){this.addAnd(c,e[c])}return this}var f=this._processCondition.apply(this,arguments);if(f){this._ands.push(f)}return this},getAnds:function(){return this._ands.slice(0)},addOr:function(e,d,b,a){if(typeof e=="object"){for(var c in e){this.addOr(c,e[c])}return this}var f=this._processCondition.apply(this,arguments);if(f){this._ors.push(f)}return this},getOrs:function(){return this._ors.slice()},getQueryStatement:function(){var f=new QueryStatement,d="",j=[],i=[];for(var g=0,b=this._ands.length;g<b;g++){var k=this._ands[g];j.push(k.getString());f.addParams(k.getParams());f.addIdentifiers(k.getIdentifiers())}if(j.length>0){AND=j.join("\n\tAND ")}for(var h=0,e=this._ors.length;h<e;h++){var c=this._ors[h];i.push(c.getString());f.addParams(c.getParams());f.addIdentifiers(c.getIdentifiers())}if(i.length>0){OR=i.join("\n\tOR ")}if(j.length>0||i.length>0){if(j.length>0&&i.length>0){d+="\n\t"+AND+"\n\tOR "+OR}else{if(j.length>0){d+="\n\t"+AND}else{d+="\n\t"+OR}}f.setString(d);return f}return null},toString:function(){return this.getQueryStatement().toString()}};function Query(b,a){this._columns=[];this._joins=[];this._orders=[];this._groups=[];this._where=new Condition;if(b){this.setTable(b,a)}return this}Query.ACTION_COUNT="COUNT";Query.ACTION_DELETE="DELETE";Query.ACTION_SELECT="SELECT";Query.EQUAL="=";Query.NOT_EQUAL="<>";Query.ALT_NOT_EQUAL="!=";Query.GREATER_THAN=">";Query.LESS_THAN="<";Query.GREATER_EQUAL=">=";Query.LESS_EQUAL="<=";Query.LIKE="LIKE";Query.NOT_LIKE="NOT LIKE";Query.CUSTOM="CUSTOM";Query.DISTINCT="DISTINCT";Query.IN="IN";Query.NOT_IN="NOT IN";Query.ALL="ALL";Query.IS_NULL="IS NULL";Query.IS_NOT_NULL="IS NOT NULL";Query.BETWEEN="BETWEEN";Query.CUSTOM_EQUAL="CUSTOM_EQUAL";Query.ILIKE="ILIKE";Query.NOT_ILIKE="NOT ILIKE";Query.JOIN="JOIN";Query.LEFT_JOIN="LEFT JOIN";Query.RIGHT_JOIN="RIGHT JOIN";Query.INNER_JOIN="INNER JOIN";Query.OUTER_JOIN="OUTER JOIN";Query.BINARY_AND="&";Query.BINARY_OR="|";Query.ASC="ASC";Query.DESC="DESC";Query.prototype={_action:Query.ACTION_SELECT,_columns:null,_table:null,_tableAlias:null,_extraTables:null,_joins:null,_where:null,_orders:null,_groups:null,_having:null,_limit:null,_offset:0,_distinct:false,setDistinct:function(a){if(typeof a=="undefined"){a=true}this._distinct=a==true},setAction:function(a){this._action=a;return this},getAction:function(){return this._action},addColumn:function(a){this._columns.push(a);return this},setColumns:function(a){this._columns=a.slice(0);return this},getColumns:function(){return this._columns},setGroups:function(a){this._groups=a;return this},getGroups:function(){return this._groups},setTable:function(b,a){if(b instanceof Query){if(!a){throw new Error("The nested query must have an alias.")}}if(a){this.setAlias(a)}this._table=b;return this},getTable:function(){return this._table},setAlias:function(a){this._tableAlias=a;return this},getAlias:function(){return this._tableAlias},addTable:function(a,b){if(a instanceof Query){if(!b){throw new Error("The nested query must have an alias.")}}else{if(typeof b=="undefined"){b=a}}if(this._extraTables==null){this._extraTables={}}this._extraTables[b]=a;return this},setWhere:function(a){this._where=a;return this},getWhere:function(){return this._where},addJoin:function(b,a,c){if(b instanceof QueryJoin){this._joins.push(b);return this}if(null===a){if(c==Query.JOIN||c==Query.INNER_JOIN){this.addTable(b);return this}a="1 = 1"}this._joins.push(new QueryJoin(b,a,c));return this},join:function(b,a,c){return this.addJoin(b,a,c)},innerJoin:function(b,a){return this.addJoin(b,a,Query.INNER_JOIN)},leftJoin:function(b,a){return this.addJoin(b,a,Query.LEFT_JOIN)},rightJoin:function(b,a){return this.addJoin(b,a,Query.RIGHT_JOIN)},outerJoin:function(b,a){return this.addJoin(b,a,Query.OUTER_JOIN)},getJoins:function(){return this._joins},setJoins:function(a){this._joins=a},addAnd:function(c,d,b,a){this._where.addAnd.apply(this._where,arguments);return this},add:function(c,d,b,a){return this.addAnd.apply(this,arguments)},andNot:function(a,b){return this.addAnd(a,b,Query.NOT_EQUAL)},andLike:function(a,b){return this.addAnd(a,b,Query.LIKE)},andNotLike:function(a,b){return this.addAnd(a,b,Query.NOT_LIKE)},andGreater:function(a,b){return this.addAnd(a,b,Query.GREATER_THAN)},andGreaterEqual:function(a,b){return this.addAnd(a,b,Query.GREATER_EQUAL)},andLess:function(a,b){return this.addAnd(a,b,Query.LESS_THAN)},andLessEqual:function(a,b){return this.addAnd(a,b,Query.LESS_EQUAL)},andNull:function(a){return this.addAnd(a,null)},andNotNull:function(a){return this.addAnd(a,null,Query.NOT_EQUAL)},andBetween:function(a,c,b){return this.addAnd(a,[c,b],Query.BETWEEN)},addOr:function(c,d,b,a){this._where.addOr.apply(this._where,arguments);return this},orNot:function(a,b){return this.addOr(a,b,Query.NOT_EQUAL)},orLike:function(a,b){return this.addOr(a,b,Query.LIKE)},orNotLike:function(a,b){return this.addOr(a,b,Query.NOT_LIKE)},orGreater:function(a,b){return this.addOr(a,b,Query.GREATER_THAN)},orGreaterEqual:function(a,b){return this.addOr(a,b,Query.GREATER_EQUAL)},orLess:function(a,b){return this.addOr(a,b,Query.LESS_THAN)},orLessEqual:function(a,b){return this.addOr(a,b,Query.LESS_EQUAL)},orNull:function(a){return this.addOr(a,null)},orNotNull:function(a){return this.addOr(a,null,Query.NOT_EQUAL)},orBetween:function(a,c,b){return this.addOr(a,[c,b],Query.BETWEEN)},groupBy:function(a){this._groups.push(a);return this},setHaving:function(a){this._having=a;return this},getHaving:function(){return this._having},orderBy:function(b,a){if(null!==a&&typeof a!="undefined"){a=a.toUpperCase();if(a!=Query.ASC&&a!=Query.DESC){throw new Error(a+" is not a valid sorting direction.")}b=b+" "+a}this._orders.push(b);return this},setLimit:function(a){a=parseInt(a);if(isNaN(a)){throw new Error("Not a number")}this._limit=a;return this},getLimit:function(){return this._limit},setOffset:function(a){a=parseInt(a);if(isNaN(a)){throw new Error("Not a number")}this._offset=a;return this},getQuery:function(e){if(!e){e=new Adapter}var k=new QueryStatement(e);var c="";switch(this._action.toUpperCase()){default:case Query.ACTION_COUNT:case Query.ACTION_SELECT:var i=this.getColumnsClause(e);k.addIdentifiers(i.getIdentifiers());k.addParams(i.getParams());c=c+"SELECT "+i.getString();break;case Query.ACTION_DELETE:c=c+"DELETE";break}var d=this.getTablesClause(e);k.addIdentifiers(d.getIdentifiers());k.addParams(d.getParams());c=c+"\nFROM "+d.getString();if(this._joins.length>0){for(var g=0,m=this._joins.length;g<m;g++){var b=this._joins[g],f=b.getQueryStatement(e);c=c+"\n\t"+f.getString();k.addParams(f.getParams());k.addIdentifiers(f.getIdentifiers())}}var a=this.getWhereClause();if(a){c=c+"\nWHERE "+a.getString();k.addParams(a.getParams());k.addIdentifiers(a.getIdentifiers())}if(this._groups.length>0){var l=this.getGroupByClause();k.addIdentifiers(l.getIdentifiers());k.addParams(l.getParams());c=c+l.getString()}if(null!==this.getHaving()){var h=this.getHaving().getQueryStatement();if(h){c=c+"\nHAVING "+h.getString();k.addParams(h.getParams());k.addIdentifiers(h.getIdentifiers())}}if(this._action!=Query.ACTION_COUNT&&this._orders.length>0){l=this.getOrderByClause();k.addIdentifiers(l.getIdentifiers());k.addParams(l.getParams());c=c+l.getString()}if(this._limit){if(e){c=e.applyLimit(c,this._offset,this._limit)}else{c=c+"\nLIMIT "+(this._offset?this._offset+", ":"")+this._limit}}if(this.needsComplexCount()&&this._action==Query.ACTION_COUNT){c="SELECT count(0)\nFROM ("+c+") a"}k.setString(c);return k},getTablesClause:function(d){var j=this.getTable();if(!j){throw new Error("No table specified.")}var g=new QueryStatement(d),f=this.getAlias();if(j instanceof Query){var c=j.getQuery(d),a="("+c.getString()+")"}else{c=null}switch(this._action.toUpperCase()){case Query.ACTION_COUNT:case Query.ACTION_SELECT:if(null!==c){g.addIdentifiers(c.getIdentifiers());g.addParams(c.getParams())}else{if(j.indexOf(" ")===-1){g.addIdentifier(j);a=QueryStatement.IDENTIFIER}else{a=j}}if(f){a=a+" AS "+f}if(this._extraTables!=null){for(var h in this._extraTables){var i=this._extraTables[h];if(i instanceof Query){var e=i.getQuery(d),b="("+e.getString()+") AS "+h;g.addParams(e.getParams());g.addIdentifiers(e.getIdentifiers())}else{b=i;if(b.indexOf(" ")==-1){b=QueryStatement.IDENTIFIER;g.addIdentifier(i)}if(h!=i){b=b+" AS "+h}}a=a+", "+b}}g.setString(a);break;case Query.ACTION_DELETE:if(null!==c){g.addIdentifiers(c.getIdentifiers());g.addParams(c.getParams())}else{if(j.indexOf(" ")==-1){g.addIdentifier(j);a=QueryStatement.IDENTIFIER}else{a=j}}if(f){a=a+" AS "+f}g.setString(a);break;default:break}return g},hasAggregates:function(){if(this._groups.length>0){return true}for(var b=0,a=this._columns.length;b<a;b++){if(this._columns[b].indexOf("(")!=-1){return true}}return false},needsComplexCount:function(){return this.hasAggregates()||null!==this._having||this._distinct},getColumnsClause:function(e){var o=this.getTable(),g;if(!o){throw new Error("No table specified.")}var k=new QueryStatement(e),i=this.getAlias(),h=this._action.toUpperCase();if(h==Query.ACTION_DELETE){return k}if(h==Query.ACTION_COUNT){if(!this.needsComplexCount()){k.setString("count(0)");return k}if(this._groups.length>0){var b=this._groups.slice(0);for(var m=0,a=b.length;m<a;m++){k.addIdentifier(b[m]);b[m]=QueryStatement.IDENTIFIER}k.setString(b.join(", "));return k}if(!this._distinct&&null===this.getHaving()&&this._columns.length>0){var n=[];for(var j=0,l=this._columns.length;j<l;j++){g=this._columns[j];if(g.indexOf("(")==-1){continue}k.addIdentifier(g);n.push(QueryStatement.IDENTIFIER)}if(n){k.setString(n.join(", "));return k}}}var d;if(this._columns.length>0){var f=this._columns.slice(0);for(var j=0,l=f.length;j<l;j++){k.addIdentifier(f[j]);f[j]=QueryStatement.IDENTIFIER}d=f.join(", ")}else{if(i){d=i+".*"}else{d=QueryStatement.IDENTIFIER+".*";k.addIdentifier(o)}}if(this._distinct){d="DISTINCT "+d}k.setString(d);return k},getWhereClause:function(a){return this.getWhere().getQueryStatement()},getOrderByClause:function(f){var e=new QueryStatement(f),d=this._orders.slice(0);for(var c=0,b=d.length;c<b;c++){var a=d[c],g=a.split(" ");if(g.length>1){e.addIdentifier(g[0]);g[0]=QueryStatement.IDENTIFIER}d[c]=g.join(" ")}e.setString("\nORDER BY "+d.join(", "));return e},getGroupByClause:function(e){var d=new QueryStatement(e);if(this._groups.length>0){var c=this._groups.slice(0);for(var b=0,a=c.length;b<a;b++){d.addIdentifier(c[b]);c[b]=QueryStatement.IDENTIFIER}d.setString("\nGROUP BY "+c.join(", "))}return d},toString:function(){if(!this.getTable()){this.setTable("{UNSPECIFIED-TABLE}")}return this.getQuery().toString()},doCount:function(a){if(!this.getTable()){throw new Error("No table specified.")}this.setAction(Query.ACTION_COUNT);return parseInt(this.getQuery(a).bindAndExecute()[0],10)},doDelete:function(a){if(!this.getTable()){throw new Error("No table specified.")}this.setAction(Query.ACTION_DELETE);return this.getQuery(a).bindAndExecute().rowsAffected},doSelect:function(a){if(!this.getTable()){throw new Error("No table specified.")}this.setAction(Query.ACTION_SELECT);return this.getQuery(a).bindAndExecute()}};function QueryJoin(b,a,c){if(typeof c=="undefined"){c=Query.JOIN}if(!(b instanceof Query)&&!(a instanceof Condition)&&a.indexOf("=")===-1&&a.indexOf(" ")===-1&&a.indexOf("(")===-1&&a.indexOf(".")!==-1&&a.indexOf(".")==a.lastIndexOf(".")&&b.indexOf(" ")===-1&&b.indexOf("=")===-1&&b.indexOf("(")===-1&&b.indexOf(".")!==-1&&b.indexOf(".")==b.lastIndexOf(".")){this._isLikePropel=true;this._leftColumn=b;this._rightColumn=a;this.setTable(this._rightColumn.split(".").shift());this.setJoinType(c);return}this.setTable(b).setOnClause(a).setJoinType(c)}QueryJoin.prototype={_table:null,_alias:null,_onClause:null,_isLikePropel:false,_leftColumn:null,_rightColumn:null,_joinType:Query.JOIN,toString:function(){if(!this.getTable()){this.setTable("{UNSPECIFIED-TABLE}")}return this.getQueryStatement().toString()},setTable:function(b){var c=b.lastIndexOf(" "),a=b.toUpperCase().lastIndexOf(" AS ");if(a!=c-3){a=-1}if(c!=-1){this.setAlias(b.substr(c+1));b=b.substring(0,a===-1?c:a)}this._table=b;return this},setAlias:function(a){this._alias=a;return this},setOnClause:function(a){this._isLikePropel=false;this._onClause=a;return this},setJoinType:function(a){this._joinType=a;return this},getQueryStatement:function(f){var e=new QueryStatement(f),d=this._table,b=this._onClause,h=this._joinType,c=this._alias;if(d instanceof Query){var g=d.getQuery(f);d="("+g.getString()+")";e.addParams(g.getParams());e.addIdentifiers(g.getIdentifiers())}else{e.addIdentifier(d);d=QueryStatement.IDENTIFIER}if(c){d+=" AS "+c}if(this._isLikePropel){e.addIdentifiers([this._leftColumn,this._rightColumn]);b=QueryStatement.IDENTIFIER+" = "+QueryStatement.IDENTIFIER}else{if(null===b){b="1 = 1"}else{if(b instanceof Condition){var a=b.getQueryStatement();b=a.getString();e.addParams(a.getParams());e.addIdentifiers(a.getIdentifiers())}}}if(""!==b){b="ON ("+b+")"}e.setString(h+" "+d+" "+b);return e},getTable:function(){return this._table},getAlias:function(){return this._alias},getOnClause:function(){if(this._isLikePropel){return this._leftColumn+" = "+this._rightColumn}return this._onClause},getJoinType:function(){return this._joinType}};function QueryStatement(a){this._params=[];this._identifiers=[];if(a){this.setConnection(a)}}QueryStatement.IDENTIFIER="[?]";QueryStatement.PARAM="?";QueryStatement.embed=function(e,g,f){if(e.split(f).length-1!=g.length){throw new Error("The number of occurances of "+f+" do not match the number of _identifiers.")}if(g.length==0){return e}var b=e.length;var c=f.length;for(var a=g.length-1;a>=0;--a){var d=g[a];b=e.lastIndexOf(f,b);if(b==-1){throw new Error("The number of occurances of "+f+" do not match the number of _identifiers.")}e=e.substring(0,b)+d+e.substr(b+c)}return e};QueryStatement.embedIdentifiers=function(a,c,b){if(b){c=b.quoteIdentifier(c)}return this.embed(a,c,this.IDENTIFIER)};QueryStatement.embedParams=function(b,a,c){if(c){a=c.prepareInput(a)}return this.embed(b,a,this.PARAM)};QueryStatement.prototype={_queryString:"",_params:null,_identifiers:null,connection:null,setConnection:function(a){this.connection=a},getConnection:function(){return this.connection},setString:function(a){this._queryString=a},getString:function(){return this._queryString},addParams:function(a){this._params=this._params.concat(a)},setParams:function(a){this._params=a.slice(0)},addParam:function(a){this._params.push(a)},getParams:function(){return this._params.slice(0)},addIdentifiers:function(a){this._identifiers=this._identifiers.concat(a)},setIdentifiers:function(a){this._identifiers=a.slice(0)},addIdentifier:function(a){this._identifiers.push(a)},getIdentifiers:function(){return this._identifiers.slice(0)},toString:function(){var a=QueryStatement.embedIdentifiers(this._queryString,this._identifiers.slice(0),this.connection);return QueryStatement.embedParams(a,this._params.slice(0),this.connection)},bindAndExecute:function(){var b=this.getConnection(),a=QueryStatement.embedIdentifiers(this._queryString,this._identifiers,b),c=this.getParams();b=b||Adapter.getConnection();return b.execute(a,c)}};function addGetterAndSetter(a,b,c){a.__defineGetter__(b,function(){var d=this["_"+b];return typeof d=="undefined"?null:d});a.__defineSetter__(b,function(d){d=this.coerceColumnValue(b,d,c);if(this["_"+b]===d){return}this._modifiedColumns[b]=b;this["_"+b]=d})}Model=Class.extend({_modifiedColumns:{},_isNew:true,_validationErrors:[],init:function Model(){this._modifiedColumns={};this._validationErrors=[]},toString:function(){return this.constructor.name+":"+this.getPrimaryKeyValues().join("-")},copy:function(){var d=new this.constructor;d.fromArray(this.toArray());var c=this.constructor._primaryKeys;for(var b=0,a=c.length;b<a;++b){var e=c[b];d[e]=null}return d},isModified:function(){return this.getModifiedColumns().length>0},isColumnModified:function(a){for(var b in this._modifiedColumns){var c=this._modifiedColumns[b];if(a.toLowerCase()==c.toLowerCase()){return true}}return false},getModifiedColumns:function(){return this._modifiedColumns},coerceColumnValue:function(b,g,e){if(null===e){e=this.constructor.getColumnType(b)}var d=Model.isTemporalType(e),c=Model.isNumericType(e);if(c||d){if(""===g){g=null}else{if(null!==g){if(c){if(Model.isIntegerType(e)){var f=parseInt(g,10);if(typeof g=="undefined"||f.toString()!=g.toString()){throw new Error(g+" is not a valid integer")}g=f}else{var a=parseFloat(g,10);if(typeof g=="undefined"||a.toString()!=g.toString()){throw new Error(g+" is not a valid float")}}}else{if(d){g=Model.coerceTemporalValue(g,e,this.constructor.getConnection())}}}}}return g},resetModified:function(){this._modifiedColumns={};return this},fromArray:function(a){for(var b in this.constructor._columns){if(!(b in a)){continue}this[b]=a[b]}return this},toArray:function(){var b={};for(var a in this.constructor._columns){b[a]=this["_"+a]}return b},hasPrimaryKeyValues:function(){var c=this.constructor._primaryKeys;if(c.length==0){return false}for(var b=0,a=c.length;b<a;++b){var d=c[b];if(this["_"+d]===null){return false}}return true},getPrimaryKeyValues:function(){var c=[],d=this.constructor._primaryKeys;for(var b=0,a=d.length;b<a;++b){var e=d[b];c.push(this["_"+e])}return c},validate:function(){this._validationErrors=[];return true},getValidationErrors:function(){return this._validationErrors},destroy:function(){var d=this.constructor._primaryKeys,g=new Query;if(d.length==0){throw new Error("This table has no primary keys")}for(var c=0,b=d.length;c<b;++c){var f=d[c];var e=this["_"+f];if(e===null){throw new Error("Cannot delete using NULL primary key.")}g.addAnd(f,e)}g.setTable(this.constructor.getTableName());var a=this.constructor.doDelete(g,false);return a},save:function(){if(!this.validate()){throw new Error("Cannot save "+this.constructor.getClassName()+" with validation errors.")}if(this.constructor._primaryKeys.length==0){throw new Error("Cannot save without primary keys")}if(this.isNew()&&this.constructor.hasColumn("Created")&&!this.isColumnModified("Created")){this.setCreated(CURRENT_TIMESTAMP)}if((this.isNew()||this.isModified())&&this.constructor.hasColumn("Updated")&&!this.isColumnModified("Updated")){this.setUpdated(CURRENT_TIMESTAMP)}if(this.isNew()){return this.insert()}return this._update()},archive:function(){if(!this.constructor.hasColumn("Archived")){throw new Error('Cannot call archive on models without "Archived" column')}if(null!==this.getArchived()){throw new Error("This "+this.constructor.getClassName()+" is already archived.")}this.setArchived(CURRENT_TIMESTAMP);return this.save()},isNew:function(){return this._isNew},setNew:function(a){this._isNew=(a==true);return this},insert:function(){var c=this.constructor.getConnection(),e=this.constructor.getPrimaryKey(),f=[],k=[],i=[],l=c.quoteIdentifier(this.constructor.getTableName()),h=new QueryStatement(c);for(var d in this.constructor._columns){var j=this["_"+d];if((j===null||typeof j=="undefined")&&!this.isColumnModified(d)){continue}f.push(c.quoteIdentifier(d));k.push(j);i.push("?")}var a="INSERT INTO "+l+" ("+f.join(", ")+") VALUES ("+i.join(", ")+") ";h.setString(a);h.setParams(k);var m=h.bindAndExecute();var g=m.rowsAffected;if(e&&this.constructor.isAutoIncrement()){var b=c.lastInsertId();if(null!==b){this[e]=b}}this.resetModified();this.setNew(false);return g},_update:function(){if(this.constructor._primaryKeys.length==0){throw new Error("This table has no primary keys")}var c=this.constructor.getConnection(),m=c.quoteIdentifier(this.constructor.getTableName()),e=[],l=[],j=[],i=new QueryStatement(c),b=this.constructor._primaryKeys,h=this.getModifiedColumns();for(var k=0,f=h.length;k<f;++k){var n=h[k];e.push(c.quoteIdentifier(n)+" = ?");l.push(this["_"+n])}if(e.length==0){return 0}for(k=0,f=b.length;k<f;++k){var d=b[k],g=this["_"+d];if(g===null||typeof g=="undefined"){throw new Error("Cannot update with NULL primary key.")}j.push(c.quoteIdentifier(d)+" = ?");l.push(g)}var a="UPDATE "+m+" SET "+e.join(", ")+" WHERE "+j.join(" AND ");i.setString(a);i.setParams(l);var o=i.bindAndExecute();this.resetModified();return o.rowsAffected}});Model.COLUMN_TYPE_TEXT="TEXT";Model.COLUMN_TYPE_NUMERIC="NUMERIC";Model.COLUMN_TYPE_INTEGER="INTEGER";Model.COLUMN_TYPE_BLOB="BLOB";Model.COLUMN_TYPE_DATE="DATE";Model.COLUMN_TYPE_TIME="TIME";Model.COLUMN_TYPE_TIMESTAMP="TIMESTAMP";Model.COLUMN_TYPES={TEXT:Model.COLUMN_TYPE_TEXT,NUMERIC:Model.COLUMN_TYPE_NUMERIC,INTEGER:Model.COLUMN_TYPE_INTEGER,BLOB:Model.COLUMN_TYPE_BLOB,DATE:Model.COLUMN_TYPE_DATE,TIME:Model.COLUMN_TYPE_TIME,TIMESTAMP:Model.COLUMN_TYPE_TIMESTAMP};Model.TEXT_TYPES={TEXT:Model.COLUMN_TYPE_TEXT,DATE:Model.COLUMN_TYPE_DATE,TIME:Model.COLUMN_TYPE_TIME,TIMESTAMP:Model.COLUMN_TYPE_TIMESTAMP};Model.INTEGER_TYPES={INTEGER:Model.COLUMN_TYPE_INTEGER};Model.BLOB_TYPES={BLOB:Model.COLUMN_TYPE_BLOB};Model.TEMPORAL_TYPES={DATE:Model.COLUMN_TYPE_DATE,TIME:Model.COLUMN_TYPE_TIME,TIMESTAMP:Model.COLUMN_TYPE_TIMESTAMP};Model.NUMERIC_TYPES={INTEGER:Model.COLUMN_TYPE_INTEGER,NUMERIC:Model.COLUMN_TYPE_NUMERIC};Model.isColumnType=function(a){return(a in Model.COLUMN_TYPES)};Model.isTemporalType=function(a){return(a in this.TEMPORAL_TYPES)};Model.isTextType=function(a){return(a in this.TEXT_TYPES)};Model.isNumericType=function(a){return(a in this.NUMERIC_TYPES)};Model.isIntegerType=function(a){return(a in this.INTEGER_TYPES)};Model.isBlobType=function(a){return(a in Model.BLOB_TYPES)};Model.fromResult=function(b){var e=[];for(var d=0,a=b.length;d<a;++d){var c=new this,f=b[d];for(var g in f){c[g]=f[g]}c.setNew(false);e.push(c)}return e};Model.coerceTemporalValue=function(e,d){if(e instanceof Array){for(var b=0,a=e;b<a;++b){e[b]=this.coerceTemporalValue(e[b],d)}return e}var c=new Date(e);if(isNaN(c.getTime())){throw new Error(e+" is not a valid date")}return c};Model._table=null;Model._primaryKeys=null;Model._isAutoIncrement=true;Model._columns=null;Model._connectionName="default_connection";Model.getConnection=function(){return Adapter.getConnection(this._connectionName)};Model.getTableName=function(){return this._table};Model.getColumns=function(){return this._columns.slice(0)};Model.getColumnType=function(a){return this._columns[a]};Model.hasColumn=function(a){a=a.toLowerCase();for(var b in this._columns){if(b.toLowerCase()==a){return true}}return false};Model.getPrimaryKeys=function(){return this._primaryKeys.slice(0)};Model.getPrimaryKey=function(){return this._primaryKeys.length==1?this._primaryKeys[0]:null};Model.isAutoIncrement=function(){return this._isAutoIncrement};Model.retrieveByPK=function(a){return this.retrieveByPKs(a)};Model.retrieveByPKs=function(){var c=this._primaryKeys,f=new Query;for(var b=0,a=c.length;b<a;++b){var e=c[b],d=arguments[b];if(d===null||typeof d=="undefined"){return null}f.add(e,d)}return this.doSelect(f,true).shift()};Model.retrieveByColumn=function(c,b){var a=new Query().add(c,b).setLimit(1);return this.doSelect(a).shift()};Model.findBy=Model.retrieveByColumn;Model.fetchSingle=function(a){return this.fetch(a).shift()};Model.fetch=function(c){var b=this.getConnection();var a=b.query(c);return this.fromResult(a)};Model.getAll=function(a){var b=this.getConnection(),c=b.quoteIdentifier(this.getTableName());return this.fetch("SELECT * FROM "+c+" "+a)};Model.doCount=function(b){b=b||new Query;var a=this.getConnection();if(!b.getTable()||this.getTableName()!=b.getTable()){b.setTable(this.getTableName())}return b.doCount(a)};Model.doDelete=function(c){var b=this.getConnection();if(!c.getTable()||this.getTableName()!=c.getTable()){c.setTable(this.getTableName())}var a=c.doDelete(b);return a};Model.doSelect=function(a){return this.fromResult(this.doSelectRS(a))};Model.doSelectRS=function(b){b=b||new Query;var a=this.getConnection();if(!b.getTable()||this.getTableName()!=b.getTable()){b.setTable(this.getTableName())}return b.doSelect(a)};Model.models={};Model.create=function(c){if(typeof c.connectionName=="undefined"){var d=Adapter.getConnection();if(!d){throw new Error("No database specified or found.")}c.connectionName=d._dbFile}if(typeof c.table=="undefined"){throw new Error("Must provide a table when exending Model")}if(typeof c.columns=="undefined"){throw new Error("Must provide columns when exending Model")}if(typeof c.primaryKeys=="undefined"){throw new Error("Must provide primaryKeys when exending Model")}var e=this.extend(c.instancePrototype);for(var b in c.columns){var a=c.columns[b]=c.columns[b].toUpperCase();if(!Model.isColumnType(a)){throw new Error(a+" is not a valide DABL/SQLite column type")}addGetterAndSetter(e.prototype,b,a)}for(var f in c){switch(f){case"connectionName":case"table":case"columns":case"primaryKeys":e["_"+f]=c[f];break;default:e[f]=c[f];break}}Model.models[c.table]=e;return e};Migration={};Migration.schema=Model.create({table:"schema_definitions",primaryKeys:["id"],columns:{id:"INTEGER",table_name:"TEXT",column_names:"TEXT",column_types:"TEXT"}});Migration.migrate=function(d){if(!d){d={}}if(d.refresh){for(var c in Model.models){Adapter.execute("DROP TABLE IF EXISTS "+c)}Migration.setupSchema(true)}else{Migration.setupSchema()}var f={};if(Migration.migrations){f=Migration.migrations}if(f[1]&&f[1].constructor===Object){var b=Migration.currentSchemaVersion();var a=Infinity;if(d.number!==null&&typeof d.number!="undefined"){a=d.number}else{if(typeof d==="number"){a=d}}var e=b;do{if(e===a){return}else{if(e<a){e+=1;if(f[e]!==null&&typeof f[e]!="undefined"){f[e].up()}else{break}}else{f[e].down();e-=1}}Migration.updateSchemaVersion(e)}while(f[e])}else{}};Migration.setupSchema=function(a){var b;Migration.createTable("schema_migrations",{version:"TEXT"});if(Adapter.count("SELECT * FROM schema_migrations")===0){b="INSERT INTO schema_migrations (version) VALUES(0)";Adapter.execute(b)}if(a&&Adapter.count("SELECT * FROM schema_migrations")===1){b="UPDATE schema_migrations set version = 0";Adapter.execute(b)}Migration.createTable("schema_definitions",{id:"INTEGER",table_name:"TEXT",column_names:"TEXT",column_types:"TEXT"})};Migration.writeSchema=function(c,h){if(c==="schema_definitions"||c==="schema_migrations"){return}var f=[];var b=[];for(var a in h){f.push(a);b.push(h[a])}var g=f.join();var d=f.join();var e=Migration.schema.findBy("table_name",c);if(e){e.column_names=g;e.column_types=d;e.save()}else{e=new Migration.schema;e.fromArray({table_name:c,column_names:g,column_types:d});e.save()}};Migration.readSchema=function(c){if(c==="schema_definitions"||c==="schema_migrations"){return null}var f=Migration.schema.findBy("table_name",c);var b=f.column_names.split(",");var h=f.column_types.split(",");var g={};for(var e=0,a=b.length;e<a;++e){var d=b[e];g[d]=h[e]}return g};Migration.currentSchemaVersion=function(){var a="SELECT version FROM schema_migrations LIMIT 1";return parseInt(Adapter.execute(a)[0].version,10)};Migration.updateSchemaVersion=function(a){var b="UPDATE schema_migrations SET version = "+a;Adapter.execute(b)};Migration.modifyColumn=function(b,a,c){if(!c){throw new Error("MIGRATION_EXCEPTION: Not a valid column modification")}var g=Migration.readSchema(b);var e={};for(var d in g){var f=g[d];switch(c.modification){case"remove":if(d!==a){e[d]=f}break;case"rename":if(d!==a){e[d]=f}else{e[c.newName]=f}break;case"change":if(d!==a){e[d]=f}else{e[d]=c.newType}break;default:throw ("MIGRATION_EXCEPTION: Not a valid column modification")}}Adapter.transaction(function(){var h=Adapter.execute("SELECT * FROM "+b);if(h.length>0){throw new Error("Modify column not quite ready yet...")}Migration.dropTable(b);Migration.createTable(b,e)})};Migration.createTable=function(a,b){if(!a||!b){return}var e="CREATE TABLE IF NOT EXISTS "+a;if(b){e+="(";for(var c in b){var d=b[c];if(c==="id"){e+="id INTEGER PRIMARY KEY AUTOINCREMENT, "}else{e+=(c+" "+d.toString().toUpperCase()+", ")}}e=e.substr(0,e.length-2);e+=")";Adapter.execute(e)}Migration.writeSchema(a,b)};Migration.dropTable=function(a){var c="DROP TABLE IF EXISTS "+a;Adapter.execute(c);var b=Migration.schema.findBy("table_name",a);b.destroy()};Migration.renameTable=function(b,a){var d="ALTER TABLE "+b+" RENAME TO "+a;Adapter.execute(d);var c=Migration.schema.findBy("table_name",b);c.table_name=a;c.save()};Migration.addColumn=function(c,b,a){var e="ALTER TABLE "+c+" ADD COLUMN "+b+" "+a.toUpperCase();Adapter.execute(e);var d=Migration.readSchema(c);d[b]=a;Migration.writeSchema(c,d)};Migration.removeColumn=function(b,a){Migration.modifyColumn(b,a,{modification:"remove"})};Migration.renameColumn=function(b,a,d){var c={modification:"rename",newName:d};Migration.modifyColumn(b,a,c)};Migration.changeColumn=function(b,a,d){var c={modification:"change",newType:d};Migration.modifyColumn(b,a,c)};Migration.addIndex=function(b,a){var c="CREATE INDEX IF NOT EXISTS "+b+"_"+a+"_index ON "+b+" ("+a+")";Adapter.execute(c)};Migration.removeIndex=function(b,a){var c="DROP INDEX IF EXISTS "+b+"_"+a+"_index";Adapter.execute(c)};