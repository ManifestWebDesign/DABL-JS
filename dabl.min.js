
/* Class.js */
(function(){var b=false,c=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;function e(g,h,i){var f;for(f in g){h[f]=typeof g[f]==="function"&&typeof i[f]==="function"&&c.test(g[f])?(function(j,k){return function(){var m=this._super,l;this._super=i[j];l=k.apply(this,arguments);this._super=m;return l}})(f,g[f]):g[f]}}var a=function(){};a.extend=function(i,j){if(typeof i==="undefined"){i={}}if(typeof j==="undefined"){j={}}var h,g;b=true;h=new this();b=false;function f(){if(!b&&this.init){this.init.apply(this,arguments)}}for(g in this){if(!(g in j)&&this.hasOwnProperty(g)){f[g]=this[g]}}e(i,h,this.prototype);e(j,f,this);f.prototype=h;f.prototype.constructor=f;return f};a.callAsync=a.prototype.callAsync=function d(i,l,h){var g=new Deferred(),k=g.promise();try{var f=i.call(this);if(f instanceof k.constructor){k=f}else{g.resolve(f)}}catch(j){g.reject({errors:[j]})}if(typeof l==="function"||typeof h==="function"){k.then(l,h)}return k};this.Class=a})();

/* Deferred.js */
(function(c,d){if(typeof c.Deferred!=="undefined"){return}if(d&&d.Deferred){c.Deferred=jQuery.Deferred;return}function b(f){return Object.prototype.toString.call(f)==="[object Array]"}function a(f,h){if(b(f)){for(var g=0;g<f.length;g++){h(f[g])}}else{h(f)}}function e(k){var g="pending",l=[],j=[],i=[],f=null,n={done:function(){for(var q=0;q<arguments.length;q++){if(!arguments[q]){continue}if(b(arguments[q])){var o=arguments[q];for(var p=0;p<o.length;p++){if(g==="resolved"){o[p].apply(this,f)}l.push(o[p])}}else{if(g==="resolved"){arguments[q].apply(this,f)}l.push(arguments[q])}}return this},fail:function(){for(var q=0;q<arguments.length;q++){if(!arguments[q]){continue}if(b(arguments[q])){var o=arguments[q];for(var p=0;p<o.length;p++){if(g==="rejected"){o[p].apply(this,f)}j.push(o[p])}}else{if(g==="rejected"){arguments[q].apply(this,f)}j.push(arguments[q])}}return this},always:function(){return this.done.apply(this,arguments).fail.apply(this,arguments)},progress:function(){for(var q=0;q<arguments.length;q++){if(!arguments[q]){continue}if(b(arguments[q])){var o=arguments[q];for(var p=0;p<o.length;p++){if(g==="pending"){i.push(o[p])}}}else{if(g==="pending"){i.push(arguments[q])}}}return this},then:function(){if(arguments.length>1&&arguments[1]){this.fail(arguments[1])}if(arguments.length>0&&arguments[0]){this.done(arguments[0])}if(arguments.length>2&&arguments[2]){this.progress(arguments[2])}return this},promise:function(p){if(p==null){return n}else{for(var o in n){p[o]=n[o]}return p}},state:function(){return g},debug:function(){console.log("[debug]",l,j,g)},isRejected:function(){return g==="rejected"},isResolved:function(){return g==="resolved"},pipe:function(p,o,q){return e(function(r){a(p,function(s){if(typeof s==="function"){m.done(function(){var t=s.apply(this,arguments);if(t&&typeof t==="function"){t.promise().then(r.resolve,r.reject,r.notify)}else{r.resolve(t)}})}else{m.done(r.resolve)}});a(o,function(s){if(typeof s==="function"){m.fail(function(){var t=s.apply(this,arguments);if(t&&typeof t==="function"){t.promise().then(r.resolve,r.reject,r.notify)}else{r.reject(t)}})}else{m.fail(r.reject)}})}).promise()}},m={resolveWith:function(q){if(g==="pending"){g="resolved";var o=f=(arguments.length>1)?arguments[1]:[];for(var p=0;p<l.length;p++){l[p].apply(q,o)}}return this},rejectWith:function(q){if(g==="pending"){g="rejected";var o=f=(arguments.length>1)?arguments[1]:[];for(var p=0;p<j.length;p++){j[p].apply(q,o)}}return this},notifyWith:function(q){if(g==="pending"){var o=f=(arguments.length>1)?arguments[1]:[];for(var p=0;p<i.length;p++){i[p].apply(q,o)}}return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},notify:function(){return this.notifyWith(this,arguments)}};var h=n.promise(m);if(k){k.apply(h,[h])}return h}e.when=function(){if(arguments.length<2){var f=arguments.length?arguments[0]:undefined;if(f&&(typeof f.isResolved==="function"&&typeof f.isRejected==="function")){return f.promise()}else{return e().resolve(f).promise()}}else{return(function(h){var m=e(),k=h.length,g=0,l=new Array(k);for(var j=0;j<h.length;j++){(function(i){h[i].done(function(){l[i]=(arguments.length<2)?arguments[0]:arguments;if(++g===k){m.resolve.apply(m,l)}}).fail(function(){m.reject(arguments)})})(j)}return m.promise()})(arguments)}};c.Deferred=e})(window,jQuery);

/* Model.js */
(function(){var d=this.Class.extend({_values:null,_originalValues:null,_isNew:true,_validationErrors:null,init:function d(i){this._validationErrors=[];this._values={};for(var m in this.constructor._fields){var l=this.constructor._fields[m];if(typeof l.value!=="undefined"){this[m]=b(l.value)}else{if(l.type===Array){this[m]=[]}else{this[m]=null}}}this.resetModified();if(i){this.fromJSON(i)}},toString:function(){return this.constructor._table+":"+JSON.stringify(this.toJSON())},copy:function(){var i=this.constructor,l=new i(this),m=i.getKey();if(m){l[m]=null}return l},isModified:function(i){if(i){return !c(this[i],this._originalValues[i])}for(var i in this.constructor._fields){if(this.isModified(i)){return true}}return false},getModified:function(){var i={};for(var l in this.constructor._fields){if(this.isModified(l)){i[l]=true}}return i},resetModified:function(){this._originalValues={};for(var i in this.constructor._fields){this._originalValues[i]=this[i]}return this},revert:function(){var i;for(var l in this.constructor._fields){i=this._originalValues[l];this[l]=typeof i==="undefined"?null:i}return this},fromJSON:function(i){for(var l in this.constructor._fields){if(!(l in i)){continue}this[l]=i[l]}return this},toJSON:function(){var n={},q,o;if(this._inGetValues){return null}this._inGetValues=true;for(q in this.constructor._fields){o=this[q];if(o instanceof Array){var p=[];for(var i=0,m=o.length;i<m;++i){if(o[i]!==null&&typeof o[i].toJSON==="function"){p[i]=o[i].toJSON()}else{p[i]=b(o[i])}}o=p}else{if(o!==null&&typeof o.toJSON==="function"){o=o.toJSON()}else{o=b(o)}}n[q]=o}delete this._inGetValues;return n},hasKeyValues:function(){var m=this.constructor._keys;if(m.length===0){return false}for(var l=0,i=m.length;l<i;++l){var n=m[l];if(this[n]===null){return false}}return true},getKeyValues:function(){var n={},m=this.constructor._keys;for(var l=0,i=m.length;l<i;++l){var o=m[l];n[o]=this[o]}return n},isNew:function(){return this._isNew},setNew:function(i){this._isNew=(i===true);return this},validate:function(){this._validationErrors=[];for(var m in this.constructor._fields){var l=this.constructor._fields[m];if(!l.required){continue}var i=this[m];if(!i||(i instanceof Array&&i.length===0)){this._validationErrors.push(m+" is required.")}}return this._validationErrors.length===0},getValidationErrors:function(){return this._validationErrors},save:function(l,i){if(this.isNew()){return this.insert(l,i)}else{return this.update(l,i)}},insert:function(l,i){return this.callAsync(function(){var m=this.constructor;if(!this.validate()){throw new Error("Cannot save "+m._table+" with validation errors:\n"+this.getValidationErrors().join("\n"))}if(this.isNew()&&m.hasField("created")&&!this.isModified("created")){this.created=new Date()}if((this.isNew()||this.isModified())&&m.hasField("updated")&&!this.isModified("updated")){this.updated=new Date()}return this.constructor._adapter.insert(this)},l,i)},update:function(i,m,l){if(typeof i==="function"){m=i;l=m}return this.callAsync(function(){var n=this.constructor;if(!this.validate()){throw new Error("Cannot save "+n._table+" with validation errors:\n"+this.getValidationErrors().join("\n"))}if(n._keys.length===0){throw new Error("Cannot update without primary keys")}if(this.isNew()&&n.hasField("created")&&!this.isModified("created")){this.created=new Date()}if((this.isNew()||this.isModified())&&n.hasField("updated")&&!this.isModified("updated")){this.updated=new Date()}if(typeof i==="object"){this.fromJSON(i)}return n._adapter.update(this)},m,l)},destroy:function(l,i){return this.callAsync(function(){return this.constructor._adapter.destroy(this)},l,i)}});d.models={};d._fields=d._keys=d._table=null;d._autoIncrement=false;d.FIELD_TYPE_TEXT="TEXT";d.FIELD_TYPE_NUMERIC="NUMERIC";d.FIELD_TYPE_INTEGER="INTEGER";d.FIELD_TYPE_DATE="DATE";d.FIELD_TYPE_TIME="TIME";d.FIELD_TYPE_TIMESTAMP="TIMESTAMP";d.FIELD_TYPES={TEXT:d.FIELD_TYPE_TEXT,NUMERIC:d.FIELD_TYPE_NUMERIC,INTEGER:d.FIELD_TYPE_INTEGER,DATE:d.FIELD_TYPE_DATE,TIME:d.FIELD_TYPE_TIME,TIMESTAMP:d.FIELD_TYPE_TIMESTAMP};d.TEXT_TYPES={TEXT:d.FIELD_TYPE_TEXT,DATE:d.FIELD_TYPE_DATE,TIME:d.FIELD_TYPE_TIME,TIMESTAMP:d.FIELD_TYPE_TIMESTAMP};d.INTEGER_TYPES={INTEGER:d.FIELD_TYPE_INTEGER};d.TEMPORAL_TYPES={DATE:d.FIELD_TYPE_DATE,TIME:d.FIELD_TYPE_TIME,TIMESTAMP:d.FIELD_TYPE_TIMESTAMP};d.NUMERIC_TYPES={INTEGER:d.FIELD_TYPE_INTEGER,NUMERIC:d.FIELD_TYPE_NUMERIC};d.isFieldType=function(i){return(i in d.FIELD_TYPES||this.isObjectType(i))};d.isTemporalType=function(i){return(i in this.TEMPORAL_TYPES)};d.isTextType=function(i){return(i in this.TEXT_TYPES)};d.isNumericType=function(i){return(i in this.NUMERIC_TYPES)};d.isIntegerType=function(i){return(i in this.INTEGER_TYPES)};d.isObjectType=function(i){return typeof i==="function"};d.coerceValue=function(s,p){var n=p.type;if(typeof s==="undefined"||s===null){if(n===Array){s=[]}else{return null}}var i=this.isTemporalType(n),t=this.isNumericType(n),o,q;if(t||i){if(""===s){return null}if(t){if(this.isIntegerType(n)){o=parseInt(s,10);if(isNaN(o)||o.toString()!==s.toString()){throw new Error(s+" is not a valid integer")}s=o}else{q=parseFloat(s,10);if(isNaN(q)||q.toString()!==s.toString()){throw new Error(s+" is not a valid float")}s=q}}else{if(i){if(!(s instanceof Date)){s=new Date(s);if(isNaN(s.getTime())){throw new Error(s+" is not a valid date")}}}}}else{if(n===Array){if(p.elementType){this.modifyArray(s,p.elementType);for(var r=0,m=s.length;r<m;++r){s[r]=this.coerceValue(s[r],{type:p.elementType})}}}else{if(this.isObjectType(n)){if(s!==null&&n.isModel&&s.constructor!==n){s=n.inflate(s)}}}}return s};d.modifyArray=function(m,i){var l=this;m.push=function(){for(var n=0,o=arguments.length;n<o;++n){arguments[n]=l.coerceValue(arguments[n],{type:i})}return Array.prototype.push.apply(this,arguments)};m.unshift=function(){for(var n=0,o=arguments.length;n<o;++n){arguments[n]=l.coerceValue(arguments[n],{type:i})}return Array.prototype.unshift.apply(this,arguments)}};d.getAdapter=function(){return this._adapter};d.setAdapter=function(i){this._adapter=i;return this};d.inflate=function(m){var n=this.getKey(),l=this.getAdapter(),i;if(n&&m[n]){i=l.cache(this._table,m[n]);if(i){return i}}i=new this(m).resetModified().setNew(false);if(n&&i[n]){l.cache(this._table,i[n],i)}return i};d.getTableName=function(){return this._table};d.getFields=function(){return b(this._fields)};d.getField=function(i){return b(this._fields[i])};d.getFieldType=function(i){return this._fields[i].type};d.hasField=function(i){return i in this._fields};d.getKeys=function(){return this._keys.slice(0)};d.getKey=function(){return this._keys.length===1?this._keys[0]:null};d.isAutoIncrement=function(){return this._autoIncrement};d.addField=function(p,n){var l,o,i=this;if(!n.type){n={type:n}}if(typeof n.type==="string"){n.type=n.type.toUpperCase()}switch(n.type){case String:n.type=i.FIELD_TYPE_TEXT;break;case Number:n.type=i.FIELD_TYPE_NUMERIC;break;case Date:n.type=i.FIELD_TYPE_TIMESTAMP;break;case"INT":n.type=i.FIELD_TYPE_INTEGER;break}if(n.key){this._keys.push(p)}if(n.computed){this._autoIncrement=true}if(!this.isFieldType(n.type)){throw new Error(n.type+" is not a valide field type")}this._fields[p]=n;if(!this.prototype.__defineGetter__&&!Object.defineProperty){return}l=function(){var q=this._values[p];return typeof q==="undefined"?null:q};o=function(q){this._values[p]=i.coerceValue(q,n)};try{if(Object.defineProperty){Object.defineProperty(this.prototype,p,{get:l,set:o,enumerable:true})}else{this.prototype.__defineGetter__(p,l);this.prototype.__defineSetter__(p,o)}}catch(m){}};d.extend=function(l,i){var m,o,n;if(typeof l==="undefined"){throw new Error("Must provide a table when exending Model")}if(!i.fields){throw new Error("Must provide fields when exending Model")}m=Class.extend.call(this,i.prototype);delete i.prototype;if(!this._table&&!this._fields){m._keys=[];m._fields={}}else{m._keys=b(this._keys);m._fields=b(this._fields)}m._table=l;for(n in i){switch(n){case"url":case"adapter":m["_"+n]=i[n];break;default:m[n]=i[n];break}}for(o in i.fields){m.addField(o,i.fields[o])}d.models[l]=m;return m};d.isModel=true;d.toString=function(){return this._table};var g=["countAll","findAll","find","destroyAll","updateAll"];for(var f=0,e=g.length;f<e;++f){var a=g[f];d[a]=(function(i){return function(){var o=Array.prototype.slice.call(arguments),m=this.getAdapter(),p=null,n=null,l=o.length-1;while(l>-1&&!(o[l] instanceof d)&&typeof o[l]==="function"){if(!p){p=o.pop();--l;continue}n=p;p=o.pop();break}o.unshift(this);return this.callAsync(function(){return m[i].apply(m,o)},p,n)}})(a)}var j=["findBy","retrieveByField","retrieveByPK","retrieveByPKs","findByPKs"];for(var k=0,h=j.length;k<h;++k){d[j[k]]=d.find}function b(n){if(n===null){return null}if(n instanceof d){return n.constructor(n)}if(n instanceof Array){return n.slice(0)}if(n instanceof Date){return new Date(n.getTime())}switch(typeof n){case"string":case"boolean":case"number":case"undefined":case"function":return n}var m={};for(var l in n){if(n.hasOwnProperty(l)){m[l]=n[l]}}return m}function c(l,i){if(l instanceof Date&&i instanceof Date){return l.getTime()===i.getTime()}if(typeof l==="object"){return JSON.stringify(l)===JSON.stringify(i)}return l===i}this.Model=d})();

/* Condition.js */
(function(){var a=this.Class.extend({_conds:null,_mode:null,init:function a(e,c,d,b){this._mode=a.MODE_SQL;this._conds=[];if(arguments.length!==0){this.and.apply(this,arguments)}},_processCondition:function(e,d,k,c){switch(arguments.length){case 0:return null;break;case 1:if(e instanceof Query.Statement){return e}if(e instanceof a){l=e.getQueryStatement();if(null===l){return null}l.setString("("+l._qString+")");return l}return null;case 2:k=d;d=a.EQUAL;case 3:c=a.QUOTE_RIGHT}var i=new Query.Statement,l,j,h=k instanceof Query,f=k instanceof Array,b;if(c===a.QUOTE_LEFT||c===a.QUOTE_BOTH){i.addParam(e);e="?"}if(d===a.CONTAINS){d=a.LIKE;k="%"+k+"%"}else{if(d===a.BEGINS_WITH){d=a.LIKE;k+="%"}else{if(d===a.ENDS_WITH){d=a.LIKE;k="%"+k}}}if(f||h){if(false===h||1!==k.getLimit()){switch(d){case a.BETWEEN:break;case a.IN:case a.EQUAL:d=a.IN;break;case a.NOT_IN:case a.NOT_EQUAL:case a.ALT_NOT_EQUAL:d=a.NOT_IN;break;default:throw new Error(d+" unknown for comparing an array.")}}if(h){if(!k.getTable()){throw new Error("right does not have a table, so it cannot be nested.")}l=k.getQuery();if(null===l){return null}k="("+l._qString+")";i.addParams(l._params);if(c!==a.QUOTE_LEFT){c=a.QUOTE_NONE}}else{if(f){b=k.length;if(2===b&&d===a.BETWEEN){i.setString(e+" "+d+" ? AND ?");i.addParams(k);return i}else{if(0===b){if(d===a.IN){i.setString("(0 = 1)");return i}else{if(d===a.NOT_IN){return null}}}else{if(c===a.QUOTE_RIGHT||c===a.QUOTE_BOTH){i.addParams(k);var g="(";for(j=0;j<b;++j){if(0<j){g+=","}g+="?"}k=g+")"}}}}}}else{if(null===k){if(d===a.NOT_EQUAL||d===a.ALT_NOT_EQUAL){d=a.IS_NOT_NULL}else{if(d===a.EQUAL){d=a.IS_NULL}}}if(d===a.IS_NULL||d===a.IS_NOT_NULL){k=null}else{if(c===a.QUOTE_RIGHT||c===a.QUOTE_BOTH){i.addParam(k);k="?"}}}i.setString(e+" "+d+(k===null?"":" "+k));return i},and:function(f,c,e,b){var d;if(f.constructor===Object){for(d in f){this.and(d,f[d])}return this}arguments.type="AND";this._conds.push(arguments);return this},addAnd:function(e,c,d,b){return this.and.apply(this,arguments)},add:function(e,c,d,b){return this.and.apply(this,arguments)},filter:function(e,c,d,b){return this.and.apply(this,arguments)},where:function(e,c,d,b){return this.and.apply(this,arguments)},or:function(f,c,e,b){var d;if(f.constructor===Object){for(d in f){this.or(d,f[d])}return this}arguments.type="OR";this._conds.push(arguments);return this},addOr:function(e,c,d,b){return this.or.apply(this,arguments)},orWhere:function(e,c,d,b){return this.or.apply(this,arguments)},andNot:function(b,c){return this.and(b,a.NOT_EQUAL,c)},andLike:function(b,c){return this.and(b,a.LIKE,c)},andNotLike:function(b,c){return this.and(b,a.NOT_LIKE,c)},andGreater:function(b,c){return this.and(b,a.GREATER_THAN,c)},andGreaterEqual:function(b,c){return this.and(b,a.GREATER_EQUAL,c)},andLess:function(b,c){return this.and(b,a.LESS_THAN,c)},andLessEqual:function(b,c){return this.and(b,a.LESS_EQUAL,c)},andNull:function(b){return this.and(b,null)},andNotNull:function(b){return this.and(b,a.NOT_EQUAL,null)},andBetween:function(b,d,c){return this.and(b,a.BETWEEN,[d,c])},andBeginsWith:function(b,c){return this.and(b,a.BEGINS_WITH,c)},andEndsWith:function(b,c){return this.and(b,a.ENDS_WITH,c)},andContains:function(b,c){return this.and(b,a.CONTAINS,c)},orNot:function(b,c){return this.or(b,a.NOT_EQUAL,c)},orLike:function(b,c){return this.or(b,a.LIKE,c)},orNotLike:function(b,c){return this.or(b,a.NOT_LIKE,c)},orGreater:function(b,c){return this.or(b,a.GREATER_THAN,c)},orGreaterEqual:function(b,c){return this.or(b,a.GREATER_EQUAL,c)},orLess:function(b,c){return this.or(b,a.LESS_THAN,c)},orLessEqual:function(b,c){return this.or(b,a.LESS_EQUAL,c)},orNull:function(b){return this.or(b,null)},orNotNull:function(b){return this.or(b,a.NOT_EQUAL,null)},orBetween:function(b,d,c){return this.or(b,a.BETWEEN,[d,c])},orBeginsWith:function(b,c){return this.or(b,a.BEGINS_WITH,c)},orEndsWith:function(b,c){return this.or(b,a.ENDS_WITH,c)},orContains:function(b,c){return this.or(b,a.CONTAINS,c)},getQueryStatement:function(h){if(0===this._conds.length){return null}var g=new Query.Statement(h),d="",c,f,e=this._conds,b=e.length;for(c=0;c<b;++c){f=this._processCondition.apply(this,e[c]);if(null===f){continue}d+="\n\t";if(0!==c){d+=((1===c&&e[0].type==="OR")?"OR":e[c].type)+" "}d+=f._qString;g.addParams(f._params)}g.setString(d);return g},toString:function(){return this.getQueryStatement().toString()},toArray:function(){var f={};if(0===this._conds.length){return{}}var c,e,d=this._conds,b=d.length;for(c=0;c<b;++c){var e=d[c];if(e.length===0){continue}if("AND"!==e.type){throw new Error("OR conditions not supported.")}if(e.length===2){f[e[0]]=e[1]}else{if(e.length===3&&e[1]===a.EQUAL){f[e[0]]=e[2]}else{throw new Error('Cannot export complex condition: "'+e.processed+'"')}}}return f}});a.EQUAL="=";a.NOT_EQUAL="<>";a.ALT_NOT_EQUAL="!=";a.GREATER_THAN=">";a.LESS_THAN="<";a.GREATER_EQUAL=">=";a.LESS_EQUAL="<=";a.LIKE="LIKE";a.BEGINS_WITH="BEGINS_WITH";a.ENDS_WITH="ENDS_WITH";a.CONTAINS="CONTAINS";a.NOT_LIKE="NOT LIKE";a.IN="IN";a.NOT_IN="NOT IN";a.IS_NULL="IS NULL";a.IS_NOT_NULL="IS NOT NULL";a.BETWEEN="BETWEEN";a.BINARY_AND="&";a.BINARY_OR="|";a.MODE_SQL="sql";a.MODE_ODATA="odata";a.OData={operators:{"=":"eq","<>":"ne","!=":"ne",">":"gt","<":"lt",">=":"ge","<=":"le",IN:"IN","NOT IN":"NOT IN","IS NULL":"eq NULL","IS NOT NULL":"neq NULL","&":"&","|":"|"},functions:{BEGINS_WITH:"startswith(@, ?)",ENDS_WITH:"endswith(@, ?)",CONTAINS:"substringof(?, @)",LIKE:"tolower(@) eq tolower(?)","NOT LIKE":"tolower(@) neq tolower(?)",BETWEEN:"@ ge ? and @ le ?"}};a.QUOTE_LEFT=1;a.QUOTE_RIGHT=2;a.QUOTE_BOTH=3;a.QUOTE_NONE=4;this.Condition=a})();

/* Query.js */
(function(){var a=this.Condition.extend({_action:"SELECT",_columns:null,_table:null,_tableAlias:null,_extraTables:null,_joins:null,_orders:null,_groups:null,_having:null,_limit:null,_offset:0,_distinct:false,init:function a(c,b){this._super();this._columns=[];this._joins=[];this._orders=[];this._groups=[];if(!c){return}if(c.constructor===Object){this.and(c)}else{if(c){this.setTable(c,b)}}},setDistinct:function(b){if(typeof b==="undefined"){b=true}this._distinct=b===true},setAction:function(b){switch(b){case"SELECT":case"DELETE":case"COUNT":break;default:throw new Error('"'+b+'" is not an allowed Query action.');break}this._action=b;return this},getAction:function(){return this._action},addColumn:function(b){this._columns.push(b);return this},setColumns:function(b){this._columns=b.slice(0);return this},getColumns:function(){return this._columns},setGroups:function(b){this._groups=b;return this},getGroups:function(){return this._groups},setTable:function(c,b){if(c instanceof a){if(!b){throw new Error("The nested query must have an alias.")}}if(b){this.setAlias(b)}this._table=c;return this},from:function(c,b){return this.setTable.apply(this,arguments)},getTable:function(){return this._table},setAlias:function(b){this._tableAlias=b;return this},getAlias:function(){return this._tableAlias},addTable:function(b,c){if(b instanceof a){if(!c){throw new Error("The nested query must have an alias.")}}else{if(typeof c==="undefined"){c=b}}if(c===this._tableAlias||c===this._table){throw new Error('The alias "'+c+'" is is already in use')}if(this._extraTables===null){this._extraTables={}}this._extraTables[c]=b;return this},addJoin:function(c,b,d){if(c instanceof a.Join){this._joins.push(c);return this}if(null===b){if(d===a.JOIN||d===a.INNER_JOIN){this.addTable(c);return this}b="1 = 1"}this._joins.push(new a.Join(c,b,d));return this},join:function(c,b,d){return this.addJoin(c,b,d)},innerJoin:function(c,b){return this.addJoin(c,b,a.INNER_JOIN)},leftJoin:function(c,b){return this.addJoin(c,b,a.LEFT_JOIN)},rightJoin:function(c,b){return this.addJoin(c,b,a.RIGHT_JOIN)},outerJoin:function(c,b){return this.addJoin(c,b,a.OUTER_JOIN)},getJoins:function(){return this._joins},setJoins:function(b){this._joins=b;return this},groupBy:function(b){this._groups.push(b);return this},setHaving:function(b){this._having=b;return this},getHaving:function(){return this._having},orderBy:function(c,b){this._orders.push(arguments);return this},limit:function(b,c){b=parseInt(b);if(isNaN(b)){throw new Error("Not a number")}this._limit=b;if(arguments.length>1){this.setOffset(c)}return this},getLimit:function(){return this._limit},offset:function(b){b=parseInt(b);if(isNaN(b)){throw new Error("Not a number.")}this._offset=b;return this},setPage:function(b){b=parseInt(b);if(isNaN(b)){throw new Error("Not a number.")}if(b<2){this._offset=null;return this}if(!this._limit){throw new Error("Cannot set page without first setting limit.")}this._offset=b*this._limit-this._limit;return this},hasAggregates:function(){if(this._groups.length!==0){return true}for(var d=0,b=this._columns.length;d<b;++d){if(this._columns[d].indexOf("(")!==-1){return true}}return false},needsComplexCount:function(){return this.hasAggregates()||null!==this._having||this._distinct},getQuery:function(f){if(typeof f==="undefined"){f=new SQLAdapter}var l=new a.Statement(f),c,j,e,n,i,b,k,m,h;c="";switch(this._action){default:case a.ACTION_COUNT:case a.ACTION_SELECT:j=this.getColumnsClause(f);l.addParams(j._params);c+="SELECT "+j._qString;break;case a.ACTION_DELETE:c+="DELETE";break}e=this.getTablesClause(f);l.addParams(e._params);c+="\nFROM "+e._qString;if(this._joins.length!==0){for(n=0,i=this._joins.length;n<i;++n){b=this._joins[n],k=b.getQueryStatement(f);c+="\n\t"+k._qString;l.addParams(k._params)}}m=this.getWhereClause();if(null!==m){c+="\nWHERE "+m._qString;l.addParams(m._params)}if(this._groups.length!==0){c+="\nGROUP BY "+this._groups.join(", ")}if(null!==this.getHaving()){h=this.getHaving().getQueryStatement();if(h){c+="\nHAVING "+h._qString;l.addParams(h._params)}}if(this._action!==a.ACTION_COUNT&&this._orders.length!==0){c+="\nORDER BY ";for(n=0,i=this._orders.length;n<i;++n){var g=this._orders[n][0];var d=this._orders[n][1];if(null!==d&&typeof d!=="undefined"){g=g+" "+d}if(0!==n){c+=", "}c+=g}}if(null!==this._limit){if(f){c=f.applyLimit(c,this._offset,this._limit)}else{c+="\nLIMIT "+(this._offset?this._offset+", ":"")+this._limit}}if(this._action===a.ACTION_COUNT&&this.needsComplexCount()){c="SELECT count(0)\nFROM ("+c+") a"}l.setString(c);return l},getTablesClause:function(e){var k=this._table,g,f,d,i,b,j,h,c;if(!k){throw new Error("No table specified.")}g=new a.Statement(e);f=this._tableAlias;if(k instanceof a){d=k.getQuery(e),b="("+d._qString+")"}else{d=null;b=k}switch(this._action){case a.ACTION_COUNT:case a.ACTION_SELECT:if(null!==d){g.addParams(d._params)}if(f){b=b+" AS "+f}if(this._extraTables!==null){for(i in this._extraTables){j=this._extraTables[i];if(j instanceof a){h=j.getQuery(e),c="("+h._qString+") AS "+i;g.addParams(h._params)}else{c=j;if(i!==j){c=c+" AS "+i}}b=b+", "+c}}g.setString(b);break;case a.ACTION_DELETE:if(null!==d){g.addParams(d._params)}if(f){b=b+" AS "+f}g.setString(b);break;default:break}return g},getColumnsClause:function(b){var k=this._table,c,h=new a.Statement(b),f=this._tableAlias,d=this._action,i,g,j,e;if(d===a.ACTION_DELETE){return h}if(!k){throw new Error("No table specified.")}if(d===a.ACTION_COUNT){if(!this.needsComplexCount()){h.setString("count(0)");return h}if(this._groups.length!==0){h.setString(this._groups.join(", "));return h}if(!this._distinct&&null===this.getHaving()&&this._columns.length!==0){j=[];for(i=0,g=this._columns.length;i<g;++i){c=this._columns[i];if(c.indexOf("(")===-1){continue}j.push(c)}if(j.length!==0){h.setString(j.join(", "));return h}}}if(this._columns.length!==0){e=this._columns.join(", ")}else{if(f){e=f+".*"}else{e=k+".*"}}if(this._distinct){e="DISTINCT "+e}h.setString(e);return h},getWhereClause:function(b){return this.getQueryStatement(b)},toString:function(){if(!this._table){this.setTable("{UNSPECIFIED-TABLE}")}return this.getQuery().toString()},getCountQuery:function(b){if(!this._table){throw new Error("No table specified.")}this.setAction(a.ACTION_COUNT);return this.getQuery(b)},getDeleteQuery:function(b){if(!this._table){throw new Error("No table specified.")}this.setAction(a.ACTION_DELETE);return this.getQuery(b)},getSelectQuery:function(b){if(!this._table){throw new Error("No table specified.")}this.setAction(a.ACTION_SELECT);return this.getQuery(b)},toArray:function(){var b=this._super();if(this._limit){b.limit=this._limit;if(this._offset){b.offset=this._offset;b.page=Math.floor(this._offset/this._limit)+1}}if(this._orders&&this._orders.length!==0){b.order_by=this._orders[0][0];if(this._orders[0][1]===a.DESC){b.dir=a.DESC}}return b}});a.ACTION_COUNT="COUNT";a.ACTION_DELETE="DELETE";a.ACTION_SELECT="SELECT";a.JOIN="JOIN";a.LEFT_JOIN="LEFT JOIN";a.RIGHT_JOIN="RIGHT JOIN";a.INNER_JOIN="INNER JOIN";a.OUTER_JOIN="OUTER JOIN";a.ASC="ASC";a.DESC="DESC";this.Query=a})();

/* QueryJoin.js */
(function(){var b=/^\w+\.\w+$/;var a=function a(d,c,e){if(arguments.length<3){e=Query.JOIN}if(!(d instanceof Query)&&!(c instanceof Condition)&&b.test(c)&&b.test(d)){this._isLikePropel=true;this._leftColumn=d;this._rightColumn=c;this._table=c.substring(0,c.indexOf("."));this._joinType=e;return}this.setTable(d).setOnClause(c).setJoinType(e)};a.prototype={_table:null,_alias:null,_onClause:null,_isLikePropel:false,_leftColumn:null,_rightColumn:null,_joinType:Query.JOIN,toString:function(){if(!this.getTable()){this.setTable("{UNSPECIFIED-TABLE}")}return this.getQueryStatement().toString()},setTable:function(d){var e=d.lastIndexOf(" "),c=e===-1?-1:d.toUpperCase().lastIndexOf(" AS ");if(c!==e-3){c=-1}if(e!==-1){this.setAlias(d.substr(e+1));d=d.substring(0,c===-1?e:c)}this._table=d;return this},setAlias:function(c){this._alias=c;return this},setOnClause:function(c){this._isLikePropel=false;this._onClause=c;return this},setJoinType:function(c){this._joinType=c;return this},getQueryStatement:function(h){var g,f=this._table,d=this._onClause,i=this._joinType,e=this._alias,c;if(f instanceof Query){g=f.getQuery(h);f="("+g._qString+")";g.setString("")}else{g=new Query.Statement(h)}if(e){f+=" AS "+e}if(this._isLikePropel){d=this._leftColumn+" = "+this._rightColumn}else{if(null===d){d="1 = 1"}else{if(d instanceof Condition){c=d.getQueryStatement();d=c._qString;g.addParams(c.getParams())}}}if(""!==d){d="ON ("+d+")"}g.setString(i+" "+f+" "+d);return g},getTable:function(){return this._table},getAlias:function(){return this._alias},getOnClause:function(){if(this._isLikePropel){return this._leftColumn+" = "+this._rightColumn}return this._onClause},getJoinType:function(){return this._joinType}};this.Query.Join=a})();

/* QueryStatement.js */
(function(){var a=function a(b){this._params=[];if(b){this._conn=b}};a.embedParams=function(f,i,g){if(g){i=g.prepareInput(i)}var h="?";if(f.split(h).length-1!==i.length){throw new Error("The number of occurances of "+h+" do not match the number of _params.")}if(i.length===0){return f}var c=f.length,d=h.length,b,e;for(b=i.length-1;b>=0;--b){e=i[b];c=f.lastIndexOf(h,c);if(c===-1){throw new Error("The number of occurances of "+h+" do not match the number of _params.")}f=f.substring(0,c)+e+f.substr(c+d)}return f};a.prototype={_qString:"",_params:null,_conn:null,setConnection:function(b){this._conn=b},getConnection:function(){return this._conn},setString:function(b){this._qString=b},getString:function(){return this._qString},addParams:function(b){this._params=this._params.concat(b)},setParams:function(b){this._params=b.slice(0)},addParam:function(b){this._params.push(b)},getParams:function(){return this._params.slice(0)},toString:function(){return Query.Statement.embedParams(this._qString,this._params.slice(0),this._conn)}};this.Query.Statement=a})();

/* Adapter.js */
(function(){function a(c){c=c+"";return c.length===2?c:"0"+c}this.Adapter=this.Class.extend({_cache:null,init:function b(){this._cache={}},cache:function(d,c,e){if(!this._cache[d]){this._cache[d]={}}if(arguments.length<3){if(!this._cache[d][c]){return null}return this._cache[d][c]}this._cache[d][c]=e;return this},emptyCache:function(c){delete this._cache[c]},formatDate:function(d,c){if(c&&c===Model.FIELD_TYPE_TIMESTAMP){return this.formatDateTime(d)}if(!(d instanceof Date)){d=new Date(d)}return d.getFullYear()+"-"+a(d.getMonth()+1)+"-"+a(d.getDate())},formatDateTime:function(c){if(!(c instanceof Date)){c=new Date(c)}return this.formatDate(c)+" "+a(c.getHours())+":"+a(c.getMinutes())+":"+a(c.getSeconds())},findQuery:function(f){var i=Array.prototype.slice.call(arguments),c=new Query().setTable(f.getTableName());i.shift();var g=i.length;if(g===0){return c}if(g===1){if(!isNaN(parseInt(i[0],10))){c.add(f.getKey(),i[0])}else{if(typeof i[0]==="object"){if(i[0] instanceof Query){c=i[0]}else{}}else{if(typeof i[0]==="string"){if(i[1] instanceof Array){}}}}}else{if(g===2&&typeof i[0]==="string"){c.add(i[0],i[1])}else{var d=f.getKeys();if(g===d.len){for(var j=0,k=d.length;j<k;++j){var e=d[j],h=i[j];if(h===null||typeof h==="undefined"){return null}c.add(e,h)}}else{throw new Error("Find called with "+g+" arguments")}}}return c},find:function(c){throw new Error("find not implemented for this adapter")},findAll:function(c){throw new Error("findAll not implemented for this adapter")},countAll:function(c,d){throw new Error("countAll not implemented for this adapter")},destroyAll:function(c,d){throw new Error("destroyAll not implemented for this adapter")},insert:function(c){throw new Error("insert not implemented for this adapter")},update:function(c){throw new Error("update not implemented for this adapter")},destroy:function(c){throw new Error("destroy not implemented for this adapter")}})})();

/* RESTAdapter.js */
(function(c){function e(g){g=g+"";return g.length===2?g:"0"+g}function b(g){return f(g,true).replace(/%26/gi,"&").replace(/%3D/gi,"=").replace(/%2B/gi,"+")}function f(h,g){return encodeURIComponent(h).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace((g?null:/%20/g),"+")}function d(k,n){this.template=k;this.defaults=n||{};var h=this.urlParams={},m=k.split(/\W/);for(var j=0,g=m.length;j<g;++j){var o=m[j];if(o&&k.match(new RegExp("[^\\\\]:"+o+"\\W"))){h[o]=true}}this.template=k.replace(/\\:/g,":")}d.prototype={url:function(l){var i=this,j=this.template,k,h;l=l||{};for(var g in this.urlParams){k=typeof l[g]!=="undefined"||l.hasOwnProperty(g)?l[g]:i.defaults[g];if(typeof k!=="undefined"&&k!==null){h=b(k);j=j.replace(new RegExp(":"+g+"(\\W)","g"),h+"$1")}else{j=j.replace(new RegExp("(/?):"+g+"(\\W)","g"),function(n,o,m){if(m.charAt(0)==="/"){return m}else{return o+m}})}}return j},urlGet:function(j){var g=this.url(j);j=j||{};g=g.replace(/\/?#$/,"");var i=[];for(var h in j){if(!this.urlParams[h]){i.push(f(h)+"="+f(j[h]))}}i.sort();g=g.replace(/\/*$/,"");return g+(i.length?"?"+i.join("&"):"")}};this.RESTAdapter=this.Adapter.extend({_routes:null,init:function a(){this._super();this._routes={}},_route:function(g){if(!g){throw new Error("Cannot create RESTful route for empty url.")}if(this._routes[g]){return this._routes[g]}return this._routes[g]=new d(g)},_save:function(o,g){var p,k=o.constructor,m,n=this._route(k._url),j={},h=new Deferred(),i=k.getKey(),q=this;for(p in k._fields){var l=k._fields[p];m=o[p];if(k.isTemporalType(l.type)){m=this.formatDate(m,l.type)}j[p]=m}c.ajax({url:n.url(j),type:"POST",data:JSON.stringify(j),contentType:"application/json;charset=utf-8",dataType:"json",headers:{"X-HTTP-Method-Override":g},success:function(s){if(!s||(s.errors&&s.errors.length)){h.reject(s);return}o.fromJSON(s).resetModified().setNew(false);if(i&&o[i]){q.cache(k._table,o[i],o)}h.resolve(o)},error:function(r,t,s){h.reject({xhr:r,status:t,errors:[s]})}});return h.promise()},formatDateTime:function(g){if(!(g instanceof Date)){g=new Date(g)}var h=-g.getTimezoneOffset()/60;h=(h>0?"+":"-")+e(Math.abs(h));return this.formatDate(g)+" "+e(g.getHours())+":"+e(g.getMinutes())+":"+e(g.getSeconds())+" "+h+"00"},insert:function(g){return this._save(g,"POST")},update:function(g){if(!g.isModified()){var h=new Deferred();h.resolve();return h.promise()}return this._save(g,"PUT")},destroy:function(g){var j=g.constructor,i=this._route(j._url),l=new Deferred(),k=j.getKey(),h=this;c.ajax({url:i.url(g.toJSON()),type:"POST",data:{},contentType:"application/json;charset=utf-8",dataType:"json",headers:{"X-HTTP-Method-Override":"DELETE"},success:function(m){if(m&&m.errors&&m.errors.length){l.reject(m);return}if(k&&g[k]){h.cache(j._table,g[k],null)}l.resolve(g)},error:function(m,o,n){l.reject({xhr:m,status:o,errors:[n]})}});return l.promise()},find:function(i,n){var j=i.getKey(),h=this._route(i._url),m={},l=new Deferred(),g=null,k;if(arguments.length===2&&(typeof n==="number"||typeof n==="string")){g=this.cache(i._table,n);if(g){l.resolve(g);return l.promise()}}k=this.findQuery.apply(this,arguments);k.limit(1);m=k.toArray();c.get(h.urlGet(m),function(o){if(!o||(o.errors&&o.errors.length)){l.reject(o);return}if(o instanceof Array){o=o.shift()}l.resolve(i.inflate(o))}).fail(function(o,q,p){l.reject({xhr:o,status:q,errors:[p]})});return l.promise()},findAll:function(h){var k=this.findQuery.apply(this,arguments);var g=this._route(h._url),j=k.toArray(),i=new Deferred();c.get(g.urlGet(j),function(n){if(!n||(n.errors&&n.errors.length)){i.reject(n);return}if(!(n instanceof Array)){n=[n]}var o=[];for(var m=0,l=n.length;m<l;++m){o.push(h.inflate(n[m]))}i.resolve(o)}).fail(function(l,n,m){i.reject({xhr:l,status:n,errors:[m]})});return i.promise()}})})(jQuery);

/* SQLAdapter.js */
(function(){var a=this.Adapter.extend({_db:null,init:function a(b){this._db=b;this._super()},execute:function(h,b){if(h instanceof Query){h=h.getQuery(this)}if(h instanceof Query.Statement){h.setConnection(this);return this.execute(h.getString(),h.getParams())}var c,l=[],k,e,d,f,g;if(b&&(d=b.length)!==0){for(e=0;e<d;++e){g=b[e];if(g instanceof Date){if(g.getSeconds()===0&&g.getMinutes()===0&&g.getHours()===0){b[e]=this.formatDate(g)}else{b[e]=this.formatDateTime(g)}}}c=this._db.execute(h,b)}else{c=this._db.execute(h)}l.rowsAffected=parseInt(this._db.rowsAffected)||0;if(null===c){return l}while(c.isValidRow()){k={};for(e=0,d=c.getFieldCount();e<d;++e){f=c.getFieldName(e);k[f]=c.field(e)}l.push(k);c.next()}c.close();return l},count:function(d,c){d="SELECT COUNT(0) AS rCount FROM ("+d+") AS a";var b=this.execute(d,c);return parseInt(b[0].rCount,10)||0},transaction:function(b){b.apply(this)},lastInsertId:function(){return this._db.lastInsertRowId},quoteIdentifier:function(b){return b},applyLimit:function(d,c,b){if(b>0){d=d+"\nLIMIT "+b+(c>0?" OFFSET "+c:"")}else{if(c>0){d=d+"\nLIMIT -1 OFFSET "+c}}return d},prepareInput:function(d){if(d instanceof Array){d=d.slice(0);for(var c=0,b=d.length;c<b;++c){d[c]=this.prepareInput(d[c])}return d}if(d===true||d===false){return d?1:0}if(d===null||typeof d==="undefined"){return"NULL"}if(parseInt(d,10)===d){return d}if(d instanceof Date){if(d.getSeconds()===0&&d.getMinutes()===0&&d.getHours()===0){d=this.formatDate(d)}else{d=this.formatDateTime(d)}}return this.quote(d)},quote:function(b){return"'"+b.replace("'","''")+"'"},find:function(b){var c=this.findQuery.apply(this,arguments).setLimit(1);return this.select(b,c).shift()||null},findAll:function(b){return this.select(b,this.findQuery.apply(this,arguments))},selectRS:function(b,c){c=c||new Query;if(!c.getTable()||b.getTableName()!==c.getTable()){c.setTable(b.getTableName())}return this.execute(c.getSelectQuery(this))},fromResult:function(d,c){var f=[],e,b;for(e=0,b=c.length;e<b;++e){f.push(d.inflate(c[e]))}return f},countAll:function(c,d){d=d instanceof Query?d:new Query(d);if(!d.getTable()||c.getTableName()!==d.getTable()){d.setTable(c.getTableName())}var b=this.execute(d.getCountQuery(this));return parseInt(b[0],10)||0},destroyAll:function(b,c){if(!c.getTable()||b.getTableName()!==c.getTable()){c.setTable(b.getTableName())}this.emptyCache(b._table);return this.execute(c.getDeleteQuery(this)).rowsAffected},select:function(b,c){c=c instanceof Query?c:new Query(c);return this.fromResult(b,this.selectRS(b,c))},updateAll:function(e,d,c){var k=this.quoteIdentifier(e.getTableName()),f=[],j=[],h=new Query.Statement(this),i,b,g=c.getWhereClause(this);for(i in d){f.push(this.quoteIdentifier(i)+" = ?");j.push(d[i])}if(f.length===0){return 0}b="UPDATE "+k+" SET "+f.join(", ")+" WHERE "+g.getString();h.setString(b);h.setParams(j);h.addParams(g.getParams());var l=this.execute(h);this.emptyCache(e._table);return l.rowsAffected||0},insert:function(l){var e=l.constructor,d=e.getKey(),f=[],k=[],h=[],g=new Query.Statement(this),b,m,j,n,c;for(m in e._fields){var i=e._fields[m];j=l[m];if(e.isTemporalType(i.type)){j=this.formatDate(j,i.type)}if(j===null){if(!l.isModified(m)){continue}}f.push(m);k.push(j);h.push("?")}b="INSERT INTO "+e.getTableName()+" ("+f.join(",")+") VALUES ("+h.join(",")+") ";g.setString(b);g.setParams(k);n=this.execute(g);if(d&&e.isAutoIncrement()){c=this.lastInsertId();if(null!==c){l[d]=c}}l.resetModified();l.setNew(false);if(d&&l[d]){this.cache(e._table,l[d],l)}return n.rowsAffected},update:function(n){var f={},c=new Query,g=n.constructor,d=g.getKeys(),b=n.getModified(),l,i,o,e,j,m;if(!n.isModified()){return 0}if(d.length===0){throw new Error("This table has no primary keys")}for(o in b){var k=g._fields[o];m=n[o];if(g.isTemporalType(k.type)){m=this.formatDate(m,k.type)}f[o]=m}for(l=0,i=d.length;l<i;++l){e=d[l];j=n[e];if(j===null){throw new Error("Cannot destroy using NULL primary key.")}c.and(e,j)}var h=this.updateAll(g,f,c);n.resetModified();return h},destroy:function(d){var f=d.constructor,e=f.getKeys(),i=new Query,c,b,h,g;if(e.length===0){throw new Error("This table has no primary keys")}for(c=0,b=e.length;c<b;++c){h=e[c];g=d[h];if(g===null){throw new Error("Cannot destroy using NULL primary key.")}i.and(h,g)}return this.destroyAll(f,i)}});a.Migration=this.Class.extend({adapter:null,schema:null,init:function(b){this.adapter=b;this.schema=Model.extend("schema_definitions",{adapter:b,fields:{id:{type:Model.FIELD_TYPE_INTEGER,computed:true,key:true},table_name:Model.FIELD_TYPE_TEXT,column_names:Model.FIELD_TYPE_INTEGER,column_types:Model.FIELD_TYPE_INTEGER}})},migrate:function(e){if(!e){e={}}var d,g={},c,b,f;if(e.refresh){for(d in Model.models){this.adapter.execute("DROP TABLE IF EXISTS "+d)}this.setupSchema(true)}else{this.setupSchema()}if(this.adapter.migrations){g=this.adapter.migrations}if(g[1]&&g[1].constructor===Object){c=this.currentSchemaVersion();b=Infinity;if(e.number!==null&&typeof e.number!=="undefined"){b=e.number}else{if(typeof e==="number"){b=e}}f=c;do{if(f===b){return}else{if(f<b){f+=1;if(g[f]!==null&&typeof g[f]!=="undefined"){g[f].up()}else{break}}else{g[f].down();f-=1}}this.updateSchemaVersion(f)}while(g[f])}else{}if(e&&e.refresh){this.loadFixtures()}},setupSchema:function(b){var c;this.createTable("schema_migrations",{version:Model.FIELD_TYPE_TEXT});if(this.adapter.count("SELECT * FROM schema_migrations")===0){c="INSERT INTO schema_migrations (version) VALUES(0)";this.adapter.execute(c)}if(b&&this.adapter.count("SELECT * FROM schema_migrations")===1){c="UPDATE schema_migrations set version = 0";this.adapter.execute(c)}this.createTable("schema_definitions",{id:Model.FIELD_TYPE_INTEGER,table_name:Model.FIELD_TYPE_TEXT,column_names:Model.FIELD_TYPE_INTEGER,column_types:Model.FIELD_TYPE_INTEGER})},writeSchema:function(d,i){if(d==="schema_definitions"||d==="schema_migrations"){return}var g=[],c=[],h,e,f;for(var b in i){g.push(b);c.push(i[b])}h=g.join();e=g.join();f=this.schema.findBy("table_name",d);if(f){f.column_names=h;f.column_types=e;f.save()}else{f=new this.schema;f.fromJSON({table_name:d,column_names:h,column_types:e});f.save()}},readSchema:function(d){if(d==="schema_definitions"||d==="schema_migrations"){return null}var g=this.schema.findBy("table_name",d),c=g.column_names.split(","),j=g.column_types.split(","),h={},e;for(var f=0,b=c.length;f<b;++f){e=c[f];h[e]=j[f]}return h},currentSchemaVersion:function(){var b="SELECT version FROM schema_migrations LIMIT 1";return parseInt(this.adapter.execute(b)[0].version,10)},updateSchemaVersion:function(b){var c="UPDATE schema_migrations SET version = "+b;return this.adapter.execute(c)},modifyColumn:function(c,b,d){if(!d){throw new Error("MIGRATION_EXCEPTION: Not a valid column modification")}var h=this.readSchema(c),f={},e,g;for(e in h){g=h[e];switch(d.modification){case"remove":if(e!==b){f[e]=g}break;case"rename":if(e!==b){f[e]=g}else{f[d.newName]=g}break;case"change":if(e!==b){f[e]=g}else{f[e]=d.newType}break;default:throw ("MIGRATION_EXCEPTION: Not a valid column modification")}}this.adapter.transaction(function(){var l=this.adapter.execute("SELECT * FROM "+c);if(l.length!==0){throw new Error("Modify column not quite ready yet...")}this.dropTable(c);this.createTable(c,f);for(var m=0,j=l.length;m<j;++m){var k=l[m];switch(d.modification){case"remove":delete k[b];Model.insert(c,k);break;case"rename":k[d.newName]=k[b];delete k[b];Model.insert(c,k);break;case"change":Model.insert(c,k);break;default:throw ("MIGRATION_EXCEPTION: Not a valid column modification")}}})},createTable:function(b,d){if(!b||!d){return}var g="CREATE TABLE IF NOT EXISTS "+b+"\n",e,f,c=0;g+="(";for(e in d){f=d[e];if(0!==c){g+=",\n"}g+=(e+" "+f);if(f===Model.FIELD_TYPE_INTEGER&&e==="id"){g+=" PRIMARY KEY AUTOINCREMENT"}++c}g+=")";this.adapter.execute(g);this.writeSchema(b,d)},dropTable:function(b){var d="DROP TABLE IF EXISTS "+b,c;this.adapter.execute(d);c=this.schema.findBy("table_name",b);c.destroy()},renameTable:function(c,b){var e="ALTER TABLE "+c+" RENAME TO "+b,d;this.adapter.execute(e);d=this.schema.findBy("table_name",c);d.table_name=b;d.save()},addColumn:function(d,c,b){var f="ALTER TABLE "+d+" ADD COLUMN "+c+" "+b,e;this.adapter.execute(f);e=this.readSchema(d);e[c]=b;this.writeSchema(d,e)},removeColumn:function(c,b){return this.modifyColumn(c,b,{modification:"remove"})},renameColumn:function(c,b,e){var d={modification:"rename",newName:e};return this.modifyColumn(c,b,d)},changeColumn:function(c,b,e){var d={modification:"change",newType:e};return this.modifyColumn(c,b,d)},addIndex:function(c,b,e){var d="CREATE"+(e?" UNIQUE ":" ")+"INDEX IF NOT EXISTS "+c+"_"+b+"_index ON "+c+" ("+b+")";return this.adapter.execute(d)},removeIndex:function(c,b){var d="DROP INDEX IF EXISTS "+c+"_"+b+"_index";return this.adapter.execute(d)},loadFixtures:function(){}});a.TiDebugDB=Class.extend({lastInsertRowId:null,rowsAffected:null,lastSQL:null,lastParams:null,execute:function(c,b){if(typeof console!=="undefined"){console.log(c,b)}this.lastSQL=c;this.lastParams=b;if(c.toUpperCase().indexOf("INSERT")===0){if(this.lastInsertRowId===null){this.lastInsertRowId=1}else{++this.lastInsertRowId}this.rowsAffected=1}if(c.toUpperCase().indexOf("DELETE")===0||c.toUpperCase().indexOf("UPDATE")===0){this.rowsAffected=1}return{sql:c,params:b,isValidRow:function(){return false},getRowCount:function(){return 0},getFieldCount:function(){return 0},getFieldName:function(){return""},field:function(){return""},next:function(){},close:function(){}}}});this.SQLAdapter=a})();
