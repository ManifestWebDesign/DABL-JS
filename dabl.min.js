
/* 00-Deferred.js */
(function(c,d){if(d&&d.Deferred){c.Deferred=jQuery.Deferred;return}function b(f){return Object.prototype.toString.call(f)==="[object Array]"}function a(f,h){if(b(f)){for(var g=0;g<f.length;g++){h(f[g])}}else{h(f)}}function e(k){var g="pending",l=[],j=[],i=[],f=null,n={done:function(){for(var q=0;q<arguments.length;q++){if(!arguments[q]){continue}if(b(arguments[q])){var o=arguments[q];for(var p=0;p<o.length;p++){if(g==="resolved"){o[p].apply(this,f)}l.push(o[p])}}else{if(g==="resolved"){arguments[q].apply(this,f)}l.push(arguments[q])}}return this},fail:function(){for(var q=0;q<arguments.length;q++){if(!arguments[q]){continue}if(b(arguments[q])){var o=arguments[q];for(var p=0;p<o.length;p++){if(g==="rejected"){o[p].apply(this,f)}j.push(o[p])}}else{if(g==="rejected"){arguments[q].apply(this,f)}j.push(arguments[q])}}return this},always:function(){return this.done.apply(this,arguments).fail.apply(this,arguments)},progress:function(){for(var q=0;q<arguments.length;q++){if(!arguments[q]){continue}if(b(arguments[q])){var o=arguments[q];for(var p=0;p<o.length;p++){if(g==="pending"){i.push(o[p])}}}else{if(g==="pending"){i.push(arguments[q])}}}return this},then:function(){if(arguments.length>1&&arguments[1]){this.fail(arguments[1])}if(arguments.length>0&&arguments[0]){this.done(arguments[0])}if(arguments.length>2&&arguments[2]){this.progress(arguments[2])}return this},promise:function(p){if(p==null){return n}else{for(var o in n){p[o]=n[o]}return p}},state:function(){return g},debug:function(){console.log("[debug]",l,j,g)},isRejected:function(){return g==="rejected"},isResolved:function(){return g==="resolved"},pipe:function(p,o,q){return e(function(r){a(p,function(s){if(typeof s==="function"){m.done(function(){var t=s.apply(this,arguments);if(t&&typeof t==="function"){t.promise().then(r.resolve,r.reject,r.notify)}else{r.resolve(t)}})}else{m.done(r.resolve)}});a(o,function(s){if(typeof s==="function"){m.fail(function(){var t=s.apply(this,arguments);if(t&&typeof t==="function"){t.promise().then(r.resolve,r.reject,r.notify)}else{r.reject(t)}})}else{m.fail(r.reject)}})}).promise()}},m={resolveWith:function(q){if(g==="pending"){g="resolved";var o=f=(arguments.length>1)?arguments[1]:[];for(var p=0;p<l.length;p++){l[p].apply(q,o)}}return this},rejectWith:function(q){if(g==="pending"){g="rejected";var o=f=(arguments.length>1)?arguments[1]:[];for(var p=0;p<j.length;p++){j[p].apply(q,o)}}return this},notifyWith:function(q){if(g==="pending"){var o=f=(arguments.length>1)?arguments[1]:[];for(var p=0;p<i.length;p++){i[p].apply(q,o)}}return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},notify:function(){return this.notifyWith(this,arguments)}};var h=n.promise(m);if(k){k.apply(h,[h])}return h}e.when=function(){if(arguments.length<2){var f=arguments.length?arguments[0]:undefined;if(f&&(typeof f.isResolved==="function"&&typeof f.isRejected==="function")){return f.promise()}else{return e().resolve(f).promise()}}else{return(function(h){var m=e(),k=h.length,g=0,l=new Array(k);for(var j=0;j<h.length;j++){(function(i){h[i].done(function(){l[i]=(arguments.length<2)?arguments[0]:arguments;if(++g===k){m.resolve.apply(m,l)}}).fail(function(){m.reject(arguments)})})(j)}return m.promise()})(arguments)}};c.Deferred=e})(window,jQuery);

/* 01-Class.js */
(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(h){if(typeof h==="undefined"){h={}}var f,g=this.prototype,e,c;a=true;f=new this();a=false;for(e in h){f[e]=typeof h[e]==="function"&&typeof g[e]==="function"&&b.test(h[e])?(function(i,j){return function(){var l=this._super,k;this._super=g[i];k=j.apply(this,arguments);this._super=l;return k}})(e,h[e]):h[e]}function d(){if(!a&&this.init){this.init.apply(this,arguments)}}for(c in this){if(this.hasOwnProperty(c)){d[c]=this[c]}}d.prototype=f;d.prototype.constructor=d;d.extend=arguments.callee;return d}})();

/* 02-Adapter.js */
(function(){function a(c){c=c+"";return c.length===2?c:"0"+c}var b=Class.extend({_cache:null,init:function b(){this._cache={}},cache:function(d,c,e){if(!this._cache[d]){this._cache[d]={}}if(arguments.length<3){if(!this._cache[d][c]){return null}return this._cache[d][c]}this._cache[d][c]=e;return this},emptyCache:function(c){delete this._cache[c]},formatDate:function(d,c){if(c&&c===Model.FIELD_TYPE_TIMESTAMP){return this.formatDateTime(d)}if(!(d instanceof Date)){d=new Date(d)}return d.getFullYear()+"-"+a(d.getMonth()+1)+"-"+a(d.getDate())},formatDateTime:function(c){if(!(c instanceof Date)){c=new Date(c)}return this.formatDate(c)+" "+a(c.getHours())+":"+a(c.getMinutes())+":"+a(c.getSeconds())},findQuery:function(f){var i=Array.prototype.slice.call(arguments),c=new Query().setTable(f.getTableName());i.shift();var g=i.length;if(g===0){return c}if(g===1){if(!isNaN(parseInt(i[0],10))){c.add(f.getPrimaryKey(),i[0])}else{if(typeof i[0]==="object"){if(i[0] instanceof Query){c=i[0]}else{}}else{if(typeof i[0]==="string"){if(i[1] instanceof Array){}}}}}else{if(g===2&&typeof i[0]==="string"){c.add(i[0],i[1])}else{var d=f.getPrimaryKeys();if(g===d.len){for(var j=0,k=d.length;j<k;++j){var e=d[j],h=i[j];if(h===null||typeof h==="undefined"){return null}c.add(e,h)}}else{throw new Error("Find called with "+g+" arguments")}}}return c},find:function(c){throw new Error("find not implemented for this adapter")},findAll:function(c){throw new Error("findAll not implemented for this adapter")},countAll:function(c,d){throw new Error("countAll not implemented for this adapter")},destroyAll:function(c,d){throw new Error("destroyAll not implemented for this adapter")},insert:function(c){throw new Error("insert not implemented for this adapter")},update:function(c){throw new Error("update not implemented for this adapter")},destroy:function(c){throw new Error("destroy not implemented for this adapter")}});this.Adapter=b})();

/* 03-Query.js */
(function(){function e(i,h,g,f){this._conds=[];if(arguments.length!==0){this.addAnd.apply(this,arguments)}}e.QUOTE_LEFT=1;e.QUOTE_RIGHT=2;e.QUOTE_BOTH=3;e.QUOTE_NONE=4;e.prototype={_conds:null,_processCondition:function(i,o,h,g){switch(arguments.length){case 0:return null;break;case 1:if(i instanceof c){return i}case 2:h=a.EQUAL;case 3:g=e.QUOTE_RIGHT}var m=new c,p,n,l=o instanceof a,j=o instanceof Array,f;if(i instanceof e){p=i.getQueryStatement();if(null===p){return null}p.setString("("+p._qString+")");return p}if(g===e.QUOTE_LEFT||g===e.QUOTE_BOTH){m.addParam(i);i="?"}if(j||l){if(false===l||1!==o.getLimit()){switch(h){case a.IN:case a.EQUAL:h=a.IN;break;case a.NOT_IN:case a.NOT_EQUAL:case a.ALT_NOT_EQUAL:h=a.NOT_IN;break;default:throw new Error(h+" unknown for comparing an array.")}}if(l){if(!o.getTable()){throw new Error("right does not have a table, so it cannot be nested.")}p=o.getQuery();if(null===p){return null}o="("+p._qString+")";m.addParams(p._params);if(g!==e.QUOTE_LEFT){g=e.QUOTE_NONE}}else{if(j){f=o.length;if(2===f&&h===a.BETWEEN){m.setString(i+" "+h+" ? AND ?");m.addParams(o);return m}else{if(0===f){if(h===a.IN){m.setString("(0 = 1)");return m}else{if(h===a.NOT_IN){return null}}}else{if(g===e.QUOTE_RIGHT||g===e.QUOTE_BOTH){m.addParams(o);var k="(";for(n=0;n<f;++n){if(0<n){k+=","}k+="?"}o=k+")"}}}}}}else{if(null===o){if(h===a.NOT_EQUAL||h===a.ALT_NOT_EQUAL){h=a.IS_NOT_NULL}else{if(h===a.EQUAL){h=a.IS_NULL}}}if(h===a.IS_NULL||h===a.IS_NOT_NULL){o=null}else{if(g===e.QUOTE_RIGHT||g===e.QUOTE_BOTH){m.addParam(o);o="?"}}}m.setString(i+" "+h+" "+o);return m},add:function(i,h,g,f){return this.addAnd.apply(this,arguments)},and:function(i,h,g,f){return this.addAnd.apply(this,arguments)},filter:function(i,g,h,f){if(arguments.length===2){var h=arguments[1],g=a.EQUAL}else{var h=arguments[2],g=arguments[1]}arguments[1]=h;arguments[2]=g;return this.addAnd.apply(this,arguments)},where:function(i,g,h,f){return this.filter.apply(this,arguments)},addAnd:function(j,i,g,f){var h;if(j.constructor===Object){for(h in j){this.addAnd(h,j[h])}return this}arguments.processed=this._processCondition.apply(this,arguments);if(null!==arguments.processed){arguments.type="AND";this._conds.push(arguments)}return this},or:function(i,h,g,f){return this.addOr.apply(this,arguments)},addOr:function(j,i,g,f){var h;if(j.constructor===Object){for(h in j){this.addOr(h,j[h])}return this}arguments.processed=this._processCondition.apply(this,arguments);if(null!==arguments.processed){arguments.type="OR";this._conds.push(arguments)}return this},andNot:function(f,g){return this.addAnd(f,g,a.NOT_EQUAL)},andLike:function(f,g){return this.addAnd(f,g,a.LIKE)},andNotLike:function(f,g){return this.addAnd(f,g,a.NOT_LIKE)},andGreater:function(f,g){return this.addAnd(f,g,a.GREATER_THAN)},andGreaterEqual:function(f,g){return this.addAnd(f,g,a.GREATER_EQUAL)},andLess:function(f,g){return this.addAnd(f,g,a.LESS_THAN)},andLessEqual:function(f,g){return this.addAnd(f,g,a.LESS_EQUAL)},andNull:function(f){return this.addAnd(f,null)},andNotNull:function(f){return this.addAnd(f,null,a.NOT_EQUAL)},andBetween:function(f,h,g){return this.addAnd(f,array(h,g),a.BETWEEN)},andBeginsWith:function(f,g){return this.addAnd(f,g,a.BEGINS_WITH)},andEndsWith:function(f,g){return this.addAnd(f,g,a.ENDS_WITH)},andContains:function(f,g){return this.addAnd(f,g,a.CONTAINS)},orNot:function(f,g){return this.addOr(f,g,a.NOT_EQUAL)},orLike:function(f,g){return this.addOr(f,g,a.LIKE)},orNotLike:function(f,g){return this.addOr(f,g,a.NOT_LIKE)},orGreater:function(f,g){return this.addOr(f,g,a.GREATER_THAN)},orGreaterEqual:function(f,g){return this.addOr(f,g,a.GREATER_EQUAL)},orLess:function(f,g){return this.addOr(f,g,a.LESS_THAN)},orLessEqual:function(f,g){return this.addOr(f,g,a.LESS_EQUAL)},orNull:function(f){return this.addOr(f,null)},orNotNull:function(f){return this.addOr(f,null,a.NOT_EQUAL)},orBetween:function(f,h,g){return this.addOr(f,array(h,g),a.BETWEEN)},orBeginsWith:function(f,g){return this.addOr(f,g,a.BEGINS_WITH)},orEndsWith:function(f,g){return this.addOr(f,g,a.ENDS_WITH)},orContains:function(f,g){return this.addOr(f,g,a.CONTAINS)},getQueryStatement:function(l){if(0===this._conds.length){return null}var k=new c(l),h="",g,j,i=this._conds,f=i.length;for(g=0;g<f;++g){j=i[g].processed;if(null===j){continue}h+="\n\t";if(0!==g){h+=((1===g&&i[0].type==="OR")?"OR":i[g].type)+" "}h+=j._qString;k.addParams(j._params)}k.setString(h);return k},toString:function(){return this.getQueryStatement().toString()},toArray:function(){var j={};if(0===this._conds.length){return{}}var g,i,h=this._conds,f=h.length;for(g=0;g<f;++g){var i=h[g];if(null===i.processed){continue}if("AND"!==i.type){throw new Error("OR conditions not supported.")}if(i.length!==2){throw new Error("Only simple equals Conditions can be exported.")}j[i[0]]=i[1]}return j}};function a(h,g){this._columns=[];this._joins=[];this._orders=[];this._groups=[];this._where=new e;if(typeof h==="object"&&!(h instanceof a)){for(var f in h){this.addAnd(f,h[f])}}if(h){this.setTable(h,g)}return this}a.ACTION_COUNT="COUNT";a.ACTION_DELETE="DELETE";a.ACTION_SELECT="SELECT";a.EQUAL="=";a.NOT_EQUAL="<>";a.ALT_NOT_EQUAL="!=";a.GREATER_THAN=">";a.LESS_THAN="<";a.GREATER_EQUAL=">=";a.LESS_EQUAL="<=";a.LIKE="LIKE";a.BEGINS_WITH="BEGINS_WITH";a.ENDS_WITH="ENDS_WITH";a.CONTAINS="CONTAINS";a.NOT_LIKE="NOT LIKE";a.CUSTOM="CUSTOM";a.DISTINCT="DISTINCT";a.IN="IN";a.NOT_IN="NOT IN";a.ALL="ALL";a.IS_NULL="IS NULL";a.IS_NOT_NULL="IS NOT NULL";a.BETWEEN="BETWEEN";a.CUSTOM_EQUAL="CUSTOM_EQUAL";a.ILIKE="ILIKE";a.NOT_ILIKE="NOT ILIKE";a.JOIN="JOIN";a.LEFT_JOIN="LEFT JOIN";a.RIGHT_JOIN="RIGHT JOIN";a.INNER_JOIN="INNER JOIN";a.OUTER_JOIN="OUTER JOIN";a.BINARY_AND="&";a.BINARY_OR="|";a.ASC="ASC";a.DESC="DESC";a.prototype={_action:a.ACTION_SELECT,_columns:null,_table:null,_tableAlias:null,_extraTables:null,_joins:null,_where:null,_orders:null,_groups:null,_having:null,_limit:null,_offset:0,_distinct:false,setDistinct:function(f){if(typeof f==="undefined"){f=true}this._distinct=f===true},setAction:function(f){this._action=f;return this},getAction:function(){return this._action},addColumn:function(f){this._columns.push(f);return this},setColumns:function(f){this._columns=f.slice(0);return this},getColumns:function(){return this._columns},setGroups:function(f){this._groups=f;return this},getGroups:function(){return this._groups},setTable:function(g,f){if(g instanceof a){if(!f){throw new Error("The nested query must have an alias.")}}if(f){this.setAlias(f)}this._table=g;return this},getTable:function(){return this._table},setAlias:function(f){this._tableAlias=f;return this},getAlias:function(){return this._tableAlias},addTable:function(f,g){if(f instanceof a){if(!g){throw new Error("The nested query must have an alias.")}}else{if(typeof g==="undefined"){g=f}}if(this._extraTables===null){this._extraTables={}}this._extraTables[g]=f;return this},setWhere:function(f){this._where=f;return this},getWhere:function(){return this._where},addJoin:function(g,f,h){if(g instanceof b){this._joins.push(g);return this}if(null===f){if(h===a.JOIN||h===a.INNER_JOIN){this.addTable(g);return this}f="1 = 1"}this._joins.push(new b(g,f,h));return this},join:function(g,f,h){return this.addJoin(g,f,h)},innerJoin:function(g,f){return this.addJoin(g,f,a.INNER_JOIN)},leftJoin:function(g,f){return this.addJoin(g,f,a.LEFT_JOIN)},rightJoin:function(g,f){return this.addJoin(g,f,a.RIGHT_JOIN)},outerJoin:function(g,f){return this.addJoin(g,f,a.OUTER_JOIN)},getJoins:function(){return this._joins},setJoins:function(f){this._joins=f;return this},addAnd:function(h,i,g,f){this._where.addAnd.apply(this._where,arguments);return this},add:function(h,i,g,f){return this.addAnd.apply(this,arguments)},and:function(i,h,g,f){return this.addAnd.apply(this,arguments)},filter:function(i,g,h,f){this._where.filter.apply(this._where,arguments);return this},where:function(i,g,h,f){return this.filter.apply(this,arguments)},or:function(i,h,g,f){return this.addOr.apply(this,arguments)},addOr:function(h,i,g,f){this._where.addOr.apply(this._where,arguments);return this},andNot:function(f,g){this._where.andNot(f,g);return this},andLike:function(f,g){this._where.andLike(f,g);return this},andNotLike:function(f,g){this._where.andNotLike(f,g);return this},andGreater:function(f,g){this._where.andGreater(f,g);return this},andGreaterEqual:function(f,g){this._where.andGreaterEqual(f,g);return this},andLess:function(f,g){this._where.andLess(f,g);return this},andLessEqual:function(f,g){this._where.andLessEqual(f,g);return this},andNull:function(f){this._where.andNull(f);return this},andNotNull:function(f){this._where.andNotNull(f);return this},andBetween:function(f,h,g){this._where.andBetween(f,h,g);return this},andBeginsWith:function(f,g){this._where.andBeginsWith(f,g);return this},andEndsWith:function(f,g){this._where.andEndsWith(f,g);return this},andContains:function(f,g){this._where.andContains(f,g);return this},orNot:function(f,g){this._where.orNot(f,g);return this},orLike:function(f,g){this._where.orLike(f,g);return this},orNotLike:function(f,g){this._where.orNotLike(f,g);return this},orGreater:function(f,g){this._where.orGreater(f,g);return this},orGreaterEqual:function(f,g){this._where.orGreaterEqual(f,g);return this},orLess:function(f,g){this._where.orLess(f,g);return this},orLessEqual:function(f,g){this._where.orLessEqual(f,g);return this},orNull:function(f){this._where.orNull(f);return this},orNotNull:function(f){this._where.orNotNull(f);return this},orBetween:function(f,h,g){this._where.orBetween(f,h,g);return this},orBeginsWith:function(f,g){this._where.orBeginsWith(f,g);return this},orEndsWith:function(f,g){this._where.orEndsWith(f,g);return this},orContains:function(f,g){this._where.orContains(f,g);return this},groupBy:function(f){this._groups.push(f);return this},setHaving:function(f){this._having=f;return this},getHaving:function(){return this._having},orderBy:function(g,f){this._orders.push(arguments);return this},setLimit:function(f,g){f=parseInt(f);if(isNaN(f)){throw new Error("Not a number")}this._limit=f;if(g){this.setOffset(g)}return this},getLimit:function(){return this._limit},setOffset:function(f){f=parseInt(f);if(isNaN(f)){throw new Error("Not a number.")}this._offset=f;return this},setPage:function(f){f=parseInt(f);if(isNaN(f)){throw new Error("Not a number.")}if(f<2){this._offset=null;return this}if(!this._limit){throw new Error("Cannot set page without first setting limit.")}this._offset=f*this._limit-this._limit;return this},hasAggregates:function(){if(this._groups.length!==0){return true}for(var g=0,f=this._columns.length;g<f;++g){if(this._columns[g].indexOf("(")!==-1){return true}}return false},needsComplexCount:function(){return this.hasAggregates()||null!==this._having||this._distinct},getQuery:function(j){if(typeof j==="undefined"){j=new SQLAdapter}var p=new c(j),g,n,i,r,m,f,o,q,l;g="";switch(this._action){default:case a.ACTION_COUNT:case a.ACTION_SELECT:n=this.getColumnsClause(j);p.addParams(n._params);g+="SELECT "+n._qString;break;case a.ACTION_DELETE:g+="DELETE";break}i=this.getTablesClause(j);p.addParams(i._params);g+="\nFROM "+i._qString;if(this._joins.length!==0){for(r=0,m=this._joins.length;r<m;++r){f=this._joins[r],o=f.getQueryStatement(j);g+="\n\t"+o._qString;p.addParams(o._params)}}q=this.getWhereClause();if(null!==q){g+="\nWHERE "+q._qString;p.addParams(q._params)}if(this._groups.length!==0){g+="\nGROUP BY "+this._groups.join(", ")}if(null!==this.getHaving()){l=this.getHaving().getQueryStatement();if(l){g+="\nHAVING "+l._qString;p.addParams(l._params)}}if(this._action!==a.ACTION_COUNT&&this._orders.length!==0){g+="\nORDER BY ";for(r=0,m=this._orders.length;r<m;++r){var k=this._orders[r][0];var h=this._orders[r][1];if(null!==h&&typeof h!=="undefined"){k=k+" "+h}if(0!==r){g+=", "}g+=k}}if(null!==this._limit){if(j){g=j.applyLimit(g,this._offset,this._limit)}else{g+="\nLIMIT "+(this._offset?this._offset+", ":"")+this._limit}}if(this._action===a.ACTION_COUNT&&this.needsComplexCount()){g="SELECT count(0)\nFROM ("+g+") a"}p.setString(g);return p},getTablesClause:function(i){var o=this.getTable(),k,j,h,m,f,n,l,g;if(!o){throw new Error("No table specified.")}k=new c(i),j=this.getAlias();if(o instanceof a){h=o.getQuery(i),f="("+h._qString+")"}else{h=null;f=o}switch(this._action){case a.ACTION_COUNT:case a.ACTION_SELECT:if(null!==h){k.addParams(h._params)}if(j){f=f+" AS "+j}if(this._extraTables!==null){for(m in this._extraTables){n=this._extraTables[m];if(n instanceof a){l=n.getQuery(i),g="("+l._qString+") AS "+m;k.addParams(l._params)}else{g=n;if(m!==n){g=g+" AS "+m}}f=f+", "+g}}k.setString(f);break;case a.ACTION_DELETE:if(null!==h){k.addParams(h._params)}if(j){f=f+" AS "+j}k.setString(f);break;default:break}return k},getColumnsClause:function(f){var o=this.getTable(),g,l=new c(f),j=this.getAlias(),h=this._action,m,k,n,i;if(h===a.ACTION_DELETE){return l}if(!o){throw new Error("No table specified.")}if(h===a.ACTION_COUNT){if(!this.needsComplexCount()){l.setString("count(0)");return l}if(this._groups.length!==0){l.setString(this._groups.join(", "));return l}if(!this._distinct&&null===this.getHaving()&&this._columns.length!==0){n=[];for(m=0,k=this._columns.length;m<k;++m){g=this._columns[m];if(g.indexOf("(")===-1){continue}n.push(g)}if(n.length!==0){l.setString(n.join(", "));return l}}}if(this._columns.length!==0){i=this._columns.join(", ")}else{if(j){i=j+".*"}else{i=o+".*"}}if(this._distinct){i="DISTINCT "+i}l.setString(i);return l},getWhereClause:function(f){return this._where.getQueryStatement(f)},toString:function(){if(!this.getTable()){this.setTable("{UNSPECIFIED-TABLE}")}return this.getQuery().toString()},getCountQuery:function(f){if(!this.getTable()){throw new Error("No table specified.")}this.setAction(a.ACTION_COUNT);return this.getQuery(f)},getDeleteQuery:function(f){if(!this.getTable()){throw new Error("No table specified.")}this.setAction(a.ACTION_DELETE);return this.getQuery(f)},getSelectQuery:function(f){if(!this.getTable()){throw new Error("No table specified.")}this.setAction(a.ACTION_SELECT);return this.getQuery(f)},toArray:function(){var f=this._where.toArray();if(this._limit){f.limit=this._limit;if(this._offset){f.offset=this._offset;f.page=Math.floor(this._offset/this._limit)+1}}if(this._orders&&this._orders.length!==0){f.order_by=this._orders[0][0];if(this._orders[0][1]===a.DESC){f.dir=a.DESC}}return f}};var d=/^\w+\.\w+$/;function b(g,f,h){if(arguments.length<3){h=a.JOIN}if(!(g instanceof a)&&!(f instanceof e)&&d.test(f)&&d.test(g)){this._isLikePropel=true;this._leftColumn=g;this._rightColumn=f;this._table=f.substring(0,f.indexOf("."));this._joinType=h;return}this.setTable(g).setOnClause(f).setJoinType(h)}b.prototype={_table:null,_alias:null,_onClause:null,_isLikePropel:false,_leftColumn:null,_rightColumn:null,_joinType:a.JOIN,toString:function(){if(!this.getTable()){this.setTable("{UNSPECIFIED-TABLE}")}return this.getQueryStatement().toString()},setTable:function(g){var h=g.lastIndexOf(" "),f=h===-1?-1:g.toUpperCase().lastIndexOf(" AS ");if(f!==h-3){f=-1}if(h!==-1){this.setAlias(g.substr(h+1));g=g.substring(0,f===-1?h:f)}this._table=g;return this},setAlias:function(f){this._alias=f;return this},setOnClause:function(f){this._isLikePropel=false;this._onClause=f;return this},setJoinType:function(f){this._joinType=f;return this},getQueryStatement:function(k){var j,i=this._table,g=this._onClause,l=this._joinType,h=this._alias,f;if(i instanceof a){j=i.getQuery(k);i="("+j._qString+")";j.setString("")}else{j=new c(k)}if(h){i+=" AS "+h}if(this._isLikePropel){g=this._leftColumn+" = "+this._rightColumn}else{if(null===g){g="1 = 1"}else{if(g instanceof e){f=g.getQueryStatement();g=f._qString;j.addParams(f.getParams())}}}if(""!==g){g="ON ("+g+")"}j.setString(l+" "+i+" "+g);return j},getTable:function(){return this._table},getAlias:function(){return this._alias},getOnClause:function(){if(this._isLikePropel){return this._leftColumn+" = "+this._rightColumn}return this._onClause},getJoinType:function(){return this._joinType}};function c(f){this._params=[];if(f){this._conn=f}}c.embedParams=function(j,m,k){if(k){m=k.prepareInput(m)}var l="?";if(j.split(l).length-1!==m.length){throw new Error("The number of occurances of "+l+" do not match the number of _params.")}if(m.length===0){return j}var g=j.length,h=l.length,f,i;for(f=m.length-1;f>=0;--f){i=m[f];g=j.lastIndexOf(l,g);if(g===-1){throw new Error("The number of occurances of "+l+" do not match the number of _params.")}j=j.substring(0,g)+i+j.substr(g+h)}return j};c.prototype={_qString:"",_params:null,_conn:null,setConnection:function(f){this._conn=f},getConnection:function(){return this._conn},setString:function(f){this._qString=f},getString:function(){return this._qString},addParams:function(f){this._params=this._params.concat(f)},setParams:function(f){this._params=f.slice(0)},addParam:function(f){this._params.push(f)},getParams:function(){return this._params.slice(0)},toString:function(){return c.embedParams(this._qString,this._params.slice(0),this._conn)}};this.Condition=e;this.Query=a;this.QueryStatement=c;this.QueryJoin=b})();

/* 04-RESTAdapter.js */
(function(c){function f(h){h=h+"";return h.length===2?h:"0"+h}function b(h){return g(h,true).replace(/%26/gi,"&").replace(/%3D/gi,"=").replace(/%2B/gi,"+")}function g(i,h){return encodeURIComponent(i).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace((h?null:/%20/g),"+")}function e(m,o){this.template=m;this.defaults=o||{};var j=this.urlParams={},n=m.split(/\W/);for(var k=0,h=n.length;k<h;++k){var p=n[k];if(p&&m.match(new RegExp("[^\\\\]:"+p+"\\W"))){j[p]=true}}this.template=m.replace(/\\:/g,":")}e.prototype={url:function(m){var j=this,k=this.template,l,i;m=m||{};for(var h in this.urlParams){l=typeof m[h]!=="undefined"||m.hasOwnProperty(h)?m[h]:j.defaults[h];if(typeof l!=="undefined"&&l!==null){i=b(l);k=k.replace(new RegExp(":"+h+"(\\W)","g"),i+"$1")}else{k=k.replace(new RegExp("(/?):"+h+"(\\W)","g"),function(o,p,n){if(n.charAt(0)==="/"){return n}else{return p+n}})}}return k},urlGet:function(k){var h=this.url(k);k=k||{};h=h.replace(/\/?#$/,"");var j=[];for(var i in k){if(!this.urlParams[i]){j.push(g(i)+"="+g(k[i]))}}j.sort();h=h.replace(/\/*$/,"");return h+(j.length?"?"+j.join("&"):"")}};var d=Adapter.extend({init:function a(){this._super()},routes:{},route:function(h){if(!h){throw new Error("Cannot create RESTful route for empty url.")}if(this.routes[h]){return this.routes[h]}return this.routes[h]=new e(h)},formatDateTime:function(h){if(!(h instanceof Date)){h=new Date(h)}var i=-h.getTimezoneOffset()/60;i=(i>0?"+":"-")+f(Math.abs(i));return this.formatDate(h)+" "+f(h.getHours())+":"+f(h.getMinutes())+":"+f(h.getSeconds())+" "+i+"00"},insert:function(o){var p,k=o.constructor,m,n=this.route(k._url),j={},h=new Deferred(),i=k.getPrimaryKey(),q=this;for(p in k._fields){var l=k._fields[p];m=o[p];if(k.isTemporalType(l.type)){m=this.formatDate(m,l.type)}if(m===null){m=""}j[p]=m}c.post(n.url(o),j,function(s){if(!s||(s.errors&&s.errors.length)){h.reject(s);return}o.setValues(s);o.resetModified();o.setNew(false);if(i&&o[i]){q.cache(k._table,o[i],o)}h.resolve(o)},"json").fail(function(r,t,s){h.reject({xhr:r,status:t,errors:[s]})});return h.promise()},update:function(p){var k={},h=p.getModified(),l=p.constructor,o=this.route(l._url),q,i=l.getPrimaryKeys(),n,j=new Deferred();if(!p.isModified()){j.resolve();return j.promise()}if(i.length===0){throw new Error("This table has no primary keys")}if(p[i[0]]===null||p[i[0]]==="undefined"){j.reject({errors:["No "+i[0]+" provided"]});return j.promise()}for(q in h){var m=l._fields[q];n=p[q];if(l.isTemporalType(m.type)){n=this.formatDate(n,m.type)}if(n===null){n=""}k[q]=n}k._method="PUT";c.post(o.url(p),k,function(s){if(!s||(s.errors&&s.errors.length)){j.reject(s);return}p.setValues(s);p.resetModified();j.resolve(p)},"json").fail(function(r,t,s){j.reject({xhr:r,status:t,errors:[s]})});return j.promise()},destroy:function(h){var l=h.constructor,k=l.getPrimaryKeys(),j=this.route(l._url),o=new Deferred(),m=l.getPrimaryKey(),i=this;if(k.length===0){throw new Error("This table has no primary keys")}if(k.length>1){throw new Error("Cannot save using REST if there is more than one primary key!")}if(h[k[0]]===null||h[k[0]]==="undefined"){o.reject({errors:["No "+k[0]+" provided"]});return o.promise()}var n={};n._method="DELETE";c.post(j.url(h),n,function(p){if(!p||(p.errors&&p.errors.length)){o.reject(p);return}o.resolve(p);if(m&&h[m]){i.cache(l._table,h[m],null)}},"json").fail(function(p,r,q){o.reject({xhr:p,status:r,errors:[q]})});return o.promise()},find:function(k,o){var l=k.getPrimaryKey(),i=this.route(k._url),n={},m=new Deferred(),h=null,j=false;if(o===null||typeof o==="undefined"){m.reject({errors:["No "+l+" provided"]});return m.promise()}if(!isNaN(parseInt(o,10))){j=true;h=this.cache(k._table,o);if(h){m.resolve(h)}return m.promise()}n[l]=o;c.get(i.urlGet(n),function(p){if(!p||(p.errors&&p.errors.length)){m.reject(p);return}if(p!==null){h=new k;h.setValues(p);h.setNew(false);h.resetModified()}if(j){this.cache(k._table,o,h)}m.resolve(h)}).fail(function(p,r,q){m.reject({xhr:p,status:r,errors:[q]})});return m.promise()},findAll:function(k){var o=this.findQuery.apply(this,arguments);var j=this.route(k._url),n=o.toArray(),m=new Deferred(),h,l=k.getPrimaryKey(),i=this;c.get(j.urlGet(n),function(s){if(!s||(s.errors&&s.errors.length)){m.reject(s);return}var t=[];if(s instanceof Array){for(var q=0,p=s.length;q<p;++q){if(l&&s[q][l]){h=i.cache(k._table,s[q][l]);if(h){t.push(h);continue}}h=new k().setValues(s[q]);if(l&&h[l]){i.cache(k._table,h[l],h)}t.push(h)}}m.resolve(t)}).fail(function(p,r,q){m.reject({xhr:p,status:r,errors:[q]})});return m.promise()}});this.RESTAdapter=d})(jQuery);

/* 04-SQLAdapter.js */
(function(){var a=Adapter.extend({_db:null,init:function a(b){this._db=b;this._super()},execute:function(h,b){if(h instanceof Query){h=h.getQuery(this)}if(h instanceof QueryStatement){h.setConnection(this);return this.execute(h.getString(),h.getParams())}var c,l=[],k,e,d,f,g;if(b&&(d=b.length)!==0){for(e=0;e<d;++e){g=b[e];if(g instanceof Date){if(g.getSeconds()===0&&g.getMinutes()===0&&g.getHours()===0){b[e]=this.formatDate(g)}else{b[e]=this.formatDateTime(g)}}}c=this._db.execute(h,b)}else{c=this._db.execute(h)}l.rowsAffected=parseInt(this._db.rowsAffected)||0;if(null===c){return l}while(c.isValidRow()){k={};for(e=0,d=c.getFieldCount();e<d;++e){f=c.getFieldName(e);k[f]=c.field(e)}l.push(k);c.next()}c.close();return l},count:function(d,c){d="SELECT COUNT(0) AS rCount FROM ("+d+") AS a";var b=this.execute(d,c);return parseInt(b[0].rCount,10)||0},transaction:function(b){b.apply(this)},lastInsertId:function(){return this._db.lastInsertRowId},quoteIdentifier:function(b){return b},applyLimit:function(d,c,b){if(b>0){d=d+"\nLIMIT "+b+(c>0?" OFFSET "+c:"")}else{if(c>0){d=d+"\nLIMIT -1 OFFSET "+c}}return d},prepareInput:function(d){if(d instanceof Array){d=d.slice(0);for(var c=0,b=d.length;c<b;++c){d[c]=this.prepareInput(d[c])}return d}if(d===true||d===false){return d?1:0}if(d===null||typeof d==="undefined"){return"NULL"}if(parseInt(d,10)===d){return d}if(d instanceof Date){if(d.getSeconds()===0&&d.getMinutes()===0&&d.getHours()===0){d=this.formatDate(d)}else{d=this.formatDateTime(d)}}return this.quote(d)},quote:function(b){return"'"+b.replace("'","''")+"'"},find:function(b){var c=this.findQuery.apply(this,arguments).setLimit(1);return this.select(b,c).shift()||null},findAll:function(b){return this.select(b,this.findQuery.apply(this,arguments))},selectRS:function(b,c){c=c||new Query;if(!c.getTable()||b.getTableName()!==c.getTable()){c.setTable(b.getTableName())}return this.execute(c.getSelectQuery(this))},fromResult:function(e,k){var h=[],d,f,b,j,g,c=e.getPrimaryKey();for(d=0,f=k.length;d<f;++d){b,j=k[d];if(c&&j[c]){b=this.cache(e._table,j[c]);if(b){h.push(b);continue}}b=new e;for(g in j){b[g]=j[g]}b.setNew(false);h.push(b)}return h},countAll:function(c,d){d=d instanceof Query?d:new Query(d);if(!d.getTable()||c.getTableName()!==d.getTable()){d.setTable(c.getTableName())}var b=this.execute(d.getCountQuery(this));return parseInt(b[0],10)||0},destroyAll:function(b,c){if(!c.getTable()||b.getTableName()!==c.getTable()){c.setTable(b.getTableName())}this.emptyCache(b._table);return this.execute(c.getDeleteQuery(this)).rowsAffected},select:function(b,c){c=c instanceof Query?c:new Query(c);return this.fromResult(b,this.selectRS(b,c))},updateAll:function(e,d,c){var k=this.quoteIdentifier(e.getTableName()),f=[],j=[],h=new QueryStatement(this),i,b,g=c.getWhereClause(this);for(i in d){f.push(this.quoteIdentifier(i)+" = ?");j.push(d[i])}if(f.length===0){return 0}b="UPDATE "+k+" SET "+f.join(", ")+" WHERE "+g.getString();h.setString(b);h.setParams(j);h.addParams(g.getParams());var l=this.execute(h);this.emptyCache(e._table);return l.rowsAffected||0},insert:function(l){var e=l.constructor,d=e.getPrimaryKey(),f=[],k=[],h=[],g=new QueryStatement(this),b,m,j,n,c;for(m in e._fields){var i=e._fields[m];j=l[m];if(e.isTemporalType(i.type)){j=this.formatDate(j,i.type)}if(j===null){if(!l.isModified(m)){continue}}f.push(m);k.push(j);h.push("?")}b="INSERT INTO "+e.getTableName()+" ("+f.join(",")+") VALUES ("+h.join(",")+") ";g.setString(b);g.setParams(k);n=this.execute(g);if(d&&e.isAutoIncrement()){c=this.lastInsertId();if(null!==c){l[d]=c}}l.resetModified();l.setNew(false);if(d&&l[d]){this.cache(e._table,l[d],l)}return n.rowsAffected},update:function(n){var f={},c=new Query,g=n.constructor,d=g.getPrimaryKeys(),b=n.getModified(),l,i,o,e,j,m;if(!n.isModified()){return 0}if(d.length===0){throw new Error("This table has no primary keys")}for(o in b){var k=g._fields[o];m=n[o];if(g.isTemporalType(k.type)){m=this.formatDate(m,k.type)}f[o]=m}for(l=0,i=d.length;l<i;++l){e=d[l];j=n[e];if(j===null){throw new Error("Cannot destroy using NULL primary key.")}c.addAnd(e,j)}var h=this.updateAll(g,f,c);n.resetModified();return h},destroy:function(d){var f=d.constructor,e=f.getPrimaryKeys(),i=new Query,c,b,h,g;if(e.length===0){throw new Error("This table has no primary keys")}for(c=0,b=e.length;c<b;++c){h=e[c];g=d[h];if(g===null){throw new Error("Cannot destroy using NULL primary key.")}i.addAnd(h,g)}return this.destroyAll(f,i)}});this.SQLAdapter=a})();

/* 05-AsyncSQLAdapter.js */
(function(){var e=["find","findAll","countAll","destroyAll","updateAll","insert","update","destroy"];var d={init:function c(g){this._super(g)}};for(var a=0,b=e.length;a<b;++a){var f=e[a];d[f]=function(){var g=new Deferred();try{g.resolve(this._super.apply(this,arguments))}catch(h){g.reject({errors:[h]})}return g.promise()}}var c=SQLAdapter.extend(d);this.AsyncSQLAdapter=c})();

/* 06-Model.js */
(function(){var d=Class.extend({_values:null,_originalValues:null,_isNew:true,_validationErrors:null,init:function d(i){this._validationErrors=[];this._values={};for(var m in this.constructor._fields){var l=this.constructor._fields[m];if(typeof l.value!=="undefined"){this[m]=b(l.value)}else{if(l.type===Array){this[m]=[]}}}this.resetModified();if(i){this.setValues(i)}},toString:function(){return this.constructor.name+":"+this.getPrimaryKeyValues().join("-")},get:function(i){return this[i]},set:function(l,i){this[l]=i;return this},copy:function(){var n=new this.constructor,m=this.constructor._keys,l,i,o;n.setValues(this.getValues());for(l=0,i=m.length;l<i;++l){o=m[l];n[o]=null}return n},isModified:function(i){if(i){return this[i]!==this._originalValues[i]}for(var i in this.constructor._fields){if(this[i]!==this._originalValues[i]){return true}}return false},getModified:function(){var i={};for(var l in this.constructor._fields){if(this[l]!==this._originalValues[l]){i[l]=true}}return i},resetModified:function(){this._originalValues={};for(var i in this.constructor._fields){this._originalValues[i]=this[i]}return this},revert:function(){if(this._values){this._values=b(this._originalValues)}else{for(var i in this._originalValues){this[i]=this._originalValues[i]}}return this},setValues:function(i){for(var l in this.constructor._fields){if(!(l in i)){continue}this[l]=i[l]}return this},getValues:function(){var n={},p,o;for(p in this.constructor._fields){o=this[p];if(!this._inGetValues&&o instanceof d){this._inGetValues=true;o=o.getValues();delete this._inGetValues}if(o instanceof Array){for(var i=0,m=o.length;i<m;++i){if(!this._inGetValues&&o[i] instanceof d){this._inGetValues=true;o[i]=o[i].getValues();delete this._inGetValues}}}n[p]=o}return n},hasPrimaryKeyValues:function(){var m=this.constructor._keys,l,i,n;if(m.length===0){return false}for(l=0,i=m.length;l<i;++l){n=m[l];if(this[n]===null){return false}}return true},getPrimaryKeyValues:function(){var m=[],n=this.constructor._keys,l,i,o;for(l=0,i=n.length;l<i;++l){o=n[l];m.push(this[o])}return m},isNew:function(){return this._isNew},setNew:function(i){this._isNew=(i===true);return this},validate:function(){this._validationErrors=[];return true},getValidationErrors:function(){return this._validationErrors},save:function(){var i=this.constructor;if(!this.validate()){throw new Error("Cannot save "+i.getClassName()+" with validation errors.")}if(i._keys.length===0){throw new Error("Cannot save without primary keys")}if(this.isNew()&&i.hasField("created")&&!this.isModified("created")){this.created=new Date()}if((this.isNew()||this.isModified())&&i.hasField("updated")&&!this.isModified("updated")){this.updated=new Date()}if(this.isNew()){return this.insert()}else{return this.update()}},insert:function(){return this.constructor._adapter.insert(this)},update:function(i){if(typeof i==="object"){this.setValues(i)}return this.constructor._adapter.update(this)},destroy:function(){return this.constructor._adapter.destroy(this)}});d.FIELD_TYPE_TEXT="TEXT";d.FIELD_TYPE_NUMERIC="NUMERIC";d.FIELD_TYPE_INTEGER="INTEGER";d.FIELD_TYPE_DATE="DATE";d.FIELD_TYPE_TIME="TIME";d.FIELD_TYPE_TIMESTAMP="TIMESTAMP";d.FIELD_TYPES={TEXT:d.FIELD_TYPE_TEXT,NUMERIC:d.FIELD_TYPE_NUMERIC,INTEGER:d.FIELD_TYPE_INTEGER,DATE:d.FIELD_TYPE_DATE,TIME:d.FIELD_TYPE_TIME,TIMESTAMP:d.FIELD_TYPE_TIMESTAMP};d.TEXT_TYPES={TEXT:d.FIELD_TYPE_TEXT,DATE:d.FIELD_TYPE_DATE,TIME:d.FIELD_TYPE_TIME,TIMESTAMP:d.FIELD_TYPE_TIMESTAMP};d.INTEGER_TYPES={INTEGER:d.FIELD_TYPE_INTEGER};d.TEMPORAL_TYPES={DATE:d.FIELD_TYPE_DATE,TIME:d.FIELD_TYPE_TIME,TIMESTAMP:d.FIELD_TYPE_TIMESTAMP};d.NUMERIC_TYPES={INTEGER:d.FIELD_TYPE_INTEGER,NUMERIC:d.FIELD_TYPE_NUMERIC};d.isFieldType=function(i){return(i in d.FIELD_TYPES||this.isObjectType(i))};d.isTemporalType=function(i){return(i in this.TEMPORAL_TYPES)};d.isTextType=function(i){return(i in this.TEXT_TYPES)};d.isNumericType=function(i){return(i in this.NUMERIC_TYPES)};d.isIntegerType=function(i){return(i in this.INTEGER_TYPES)};d.isObjectType=function(i){return typeof i==="function"};d.coerceTemporalValue=function(p,n){var i,o,m;if(p.constructor===Array){for(i=0,m=p.length;i<m;++i){p[i]=this.coerceTemporalValue(p[i],n)}return p}o=new Date(p);if(isNaN(o.getTime())){throw new Error(p+" is not a valid date")}return o};d.coerceValue=function(u,s,q){if(!q){q=this.getField(u)}var n=q.type;s=typeof s==="undefined"?null:s;var i=this.isTemporalType(n),t=this.isNumericType(n),o,r;if(t||i){if(""===s){s=null}else{if(null!==s){if(t){if(this.isIntegerType(n)){o=parseInt(s,10);if(o.toString()!==s.toString()){throw new Error(s+" is not a valid integer")}s=o}else{r=parseFloat(s,10);if(r.toString()!==s.toString()){throw new Error(s+" is not a valid float")}}}else{if(i){s=this.coerceTemporalValue(s,n)}}}}}else{if(n===Array){if(s===null){s=[]}else{if(q.elementType&&s instanceof Array){for(var p=0,m=s.length;p<m;++p){if(s[p]!==null&&!(s[p] instanceof q.elementType)){s[p]=c(s[p],q.elementType)}}}}}else{if(this.isObjectType(n)){if(s!==null&&!(s instanceof n)){s=c(s,n)}}}}return s};function c(l,i){if(i._table&&typeof i==="function"){return new i(l)}return l}function b(n){if(n===null){return null}if(n instanceof Array){return n.slice(0)}switch(typeof n){case"string":case"boolean":case"number":case"undefined":case"function":return n}var m={};for(var l in n){if(n.hasOwnProperty(l)){m[l]=n[l]}}return m}d._fields=d._keys=d._table=null;d._autoIncrement=false;d.getAdapter=function(){return this._adapter};d.setAdapter=function(i){this._adapter=i;return this};d.getTableName=function(){return this._table};d.getFields=function(){return b(this._fields)};d.getField=function(i){return this._fields[i]};d.getFieldType=function(i){return this._fields[i].type};d.hasField=function(l){for(var i in this._fields){if(i===l){return true}}return false};d.getPrimaryKeys=function(){return this._keys.slice(0)};d.getPrimaryKey=function(){return this._keys.length===1?this._keys[0]:null};d.isAutoIncrement=function(){return this._autoIncrement};var g=["countAll","findAll","find","destroyAll","updateAll"];for(var f=0,e=g.length;f<e;++f){var a=g[f];d[a]=(function(i){return function(){var m=Array.prototype.slice.call(arguments);m.unshift(this);var l=this.getAdapter();return l[i].apply(l,m)}})(a)}var k=["findBy","retrieveByField","retrieveByPK","retrieveByPKs","findByPKs"];for(var j=0,h=k.length;j<h;++j){d[k[j]]=d.find}d.addField=function(o,m){var l,n,i=this;if(!m.type){m={type:m}}if(typeof m.type==="string"){m.type=m.type.toUpperCase()}switch(m.type){case String:m.type=i.FIELD_TYPE_TEXT;break;case Number:m.type=i.FIELD_TYPE_NUMERIC;break;case Date:m.type=i.FIELD_TYPE_TIMESTAMP;break;case"INT":m.type=i.FIELD_TYPE_INTEGER;break}if(m.key){this._keys.push(o)}if(m.computed){this._autoIncrement=true}if(!this.isFieldType(m.type)){throw new Error(m.type+" is not a valide field type")}this._fields[o]=m;if(!this.prototype.__defineGetter__&&!Object.defineProperty){return}l=function(){var p=this._values[o];return typeof p==="undefined"?null:p};n=function(p){this._values[o]=i.coerceValue(o,p,m)};if(Object.defineProperty){Object.defineProperty(this.prototype,o,{get:l,set:n,enumerable:true})}else{this.prototype.__defineGetter__(o,l);this.prototype.__defineSetter__(o,n)}};d.models={};d.create=function(l,i){var m,o,n;if(typeof l==="undefined"){throw new Error("Must provide a table when exending Model")}if(!i.fields){throw new Error("Must provide fields when exending Model")}m=this.extend(i.prototype);delete i.prototype;m._keys=[];m._fields={};m._table=l;for(n in i){switch(n){case"url":case"adapter":case"table":m["_"+n]=i[n];break;default:m[n]=i[n];break}}for(o in i.fields){m.addField(o,i.fields[o])}d.models[l]=m;return m};this.Model=d})();

/* 07-Migration.js */
(function(){var a={};a.schema=Model.create("schema_definitions",{fields:{id:{type:Model.FIELD_TYPE_INTEGER,computed:true,key:true},table_name:Model.FIELD_TYPE_TEXT,column_names:Model.FIELD_TYPE_INTEGER,column_types:Model.FIELD_TYPE_INTEGER}});a.migrate=function(e){if(!e){e={}}var d,g={},c,b,f;if(e.refresh){for(d in Model.models){SQLAdapter.execute("DROP TABLE IF EXISTS "+d)}a.setupSchema(true)}else{a.setupSchema()}if(a.migrations){g=a.migrations}if(g[1]&&g[1].constructor===Object){c=a.currentSchemaVersion();b=Infinity;if(e.number!==null&&typeof e.number!=="undefined"){b=e.number}else{if(typeof e==="number"){b=e}}f=c;do{if(f===b){return}else{if(f<b){f+=1;if(g[f]!==null&&typeof g[f]!=="undefined"){g[f].up()}else{break}}else{g[f].down();f-=1}}a.updateSchemaVersion(f)}while(g[f])}else{}};a.setupSchema=function(b){var c;a.createTable("schema_migrations",{version:Model.FIELD_TYPE_TEXT});if(SQLAdapter.count("SELECT * FROM schema_migrations")===0){c="INSERT INTO schema_migrations (version) VALUES(0)";SQLAdapter.execute(c)}if(b&&SQLAdapter.count("SELECT * FROM schema_migrations")===1){c="UPDATE schema_migrations set version = 0";SQLAdapter.execute(c)}a.createTable("schema_definitions",{id:Model.FIELD_TYPE_INTEGER,table_name:Model.FIELD_TYPE_TEXT,column_names:Model.FIELD_TYPE_INTEGER,column_types:Model.FIELD_TYPE_INTEGER})};a.writeSchema=function(d,i){if(d==="schema_definitions"||d==="schema_migrations"){return}var g=[],c=[],b,h,e,f;for(b in i){g.push(b);c.push(i[b])}h=g.join();e=g.join();f=a.schema.findBy("table_name",d);if(f){f.column_names=h;f.column_types=e;f.save()}else{f=new a.schema;f.setValues({table_name:d,column_names:h,column_types:e});f.save()}};a.readSchema=function(d){if(d==="schema_definitions"||d==="schema_migrations"){return null}var g=a.schema.findBy("table_name",d),c=g.column_names.split(","),j=g.column_types.split(","),h={},f,b=c.length,e;for(f=0;f<b;++f){e=c[f];h[e]=j[f]}return h};a.currentSchemaVersion=function(){var b="SELECT version FROM schema_migrations LIMIT 1";return parseInt(SQLAdapter.execute(b)[0].version,10)};a.updateSchemaVersion=function(b){var c="UPDATE schema_migrations SET version = "+b;SQLAdapter.execute(c)};a.modifyColumn=function(c,b,d){if(!d){throw new Error("MIGRATION_EXCEPTION: Not a valid column modification")}var h=a.readSchema(c),f={},e,g;for(e in h){g=h[e];switch(d.modification){case"remove":if(e!==b){f[e]=g}break;case"rename":if(e!==b){f[e]=g}else{f[d.newName]=g}break;case"change":if(e!==b){f[e]=g}else{f[e]=d.newType}break;default:throw ("MIGRATION_EXCEPTION: Not a valid column modification")}}SQLAdapter.transaction(function(){var l=SQLAdapter.execute("SELECT * FROM "+c);if(l.length!==0){throw new Error("Modify column not quite ready yet...")}a.dropTable(c);a.createTable(c,f);for(var m=0,j=l.length;m<j;++m){var k=l[m];switch(d.modification){case"remove":delete k[b];Model.insert(c,k,SQLAdapter.getConnection());break;case"rename":k[d.newName]=k[b];delete k[b];Model.insert(c,k,SQLAdapter.getConnection());break;case"change":Model.insert(c,k,SQLAdapter.getConnection());break;default:throw ("MIGRATION_EXCEPTION: Not a valid column modification")}}})};a.createTable=function(b,d){if(!b||!d){return}var g="CREATE TABLE IF NOT EXISTS "+b+"\n",e,f,c=0;g+="(";for(e in d){f=d[e];if(0!==c){g+=",\n"}g+=(e+" "+f);if(f===Model.FIELD_TYPE_INTEGER&&e==="id"){g+=" PRIMARY KEY AUTOINCREMENT"}++c}g+=")";SQLAdapter.execute(g);a.writeSchema(b,d)};a.dropTable=function(b){var d="DROP TABLE IF EXISTS "+b,c;SQLAdapter.execute(d);c=a.schema.findBy("table_name",b);c.destroy()};a.renameTable=function(c,b){var e="ALTER TABLE "+c+" RENAME TO "+b,d;SQLAdapter.execute(e);d=a.schema.findBy("table_name",c);d.table_name=b;d.save()};a.addColumn=function(d,c,b){var f="ALTER TABLE "+d+" ADD COLUMN "+c+" "+b,e;SQLAdapter.execute(f);e=a.readSchema(d);e[c]=b;a.writeSchema(d,e)};a.removeColumn=function(c,b){a.modifyColumn(c,b,{modification:"remove"})};a.renameColumn=function(c,b,e){var d={modification:"rename",newName:e};a.modifyColumn(c,b,d)};a.changeColumn=function(c,b,e){var d={modification:"change",newType:e};a.modifyColumn(c,b,d)};a.addIndex=function(c,b,e){var d="CREATE"+(e?" UNIQUE ":" ")+"INDEX IF NOT EXISTS "+c+"_"+b+"_index ON "+c+" ("+b+")";SQLAdapter.execute(d)};a.removeIndex=function(c,b){var d="DROP INDEX IF EXISTS "+c+"_"+b+"_index";SQLAdapter.execute(d)};this.Migration=a})();
