!function(a,b){b["true"]=a;var c=dabl.Model,d=dabl.Query,e=dabl.Adapter.extend({_db:null,init:function(a){this._db=a,this._super()},execute:function(a,b){if(a instanceof d&&(a=a.getQuery(this)),a instanceof d.Statement)return a.setConnection(this),this.execute(a.getString(),a.getParams());var c,e,f,g,h,i,j=[];if(b&&0!==(g=b.length)){for(f=0;g>f;++f)i=b[f],i instanceof Date&&(b[f]=0===i.getSeconds()&&0===i.getMinutes()&&0===i.getHours()?this.formatDate(i):this.formatDateTime(i));c=this._db.execute(a,b)}else c=this._db.execute(a);if(j.rowsAffected=parseInt(this._db.rowsAffected)||0,null===c)return j;for(;c.isValidRow();){for(e={},f=0,g=c.getFieldCount();g>f;++f)h=c.getFieldName(f),e[h]=c.field(f);j.push(e),c.next()}return c.close(),j},count:function(a,b){a="SELECT COUNT(0) AS rCount FROM ("+a+") AS a";var c=this.execute(a,b);return parseInt(c[0].rCount,10)||0},transaction:function(a){a.apply(this)},lastInsertId:function(){return this._db.lastInsertRowId},quoteIdentifier:function(a){return a},applyLimit:function(a,b,c){return c>0?a=a+"\nLIMIT "+c+(b>0?" OFFSET "+b:""):b>0&&(a=a+"\nLIMIT -1 OFFSET "+b),a},prepareInput:function(a){if(a instanceof Array){a=a.slice(0);for(var b=0,c=a.length;c>b;++b)a[b]=this.prepareInput(a[b]);return a}return a===!0||a===!1?a?1:0:null===a||"undefined"==typeof a?"NULL":parseInt(a,10)===a?a:(a instanceof Date&&(a=0===a.getSeconds()&&0===a.getMinutes()&&0===a.getHours()?this.formatDate(a):this.formatDateTime(a)),this.quote(a))},quote:function(a){return"'"+a.replace("'","''")+"'"},find:function(a){var b=this.findQuery.apply(this,arguments).setLimit(1);return this.select(a,b).shift()||null},findAll:function(a){return this.select(a,this.findQuery.apply(this,arguments))},selectRS:function(a,b){return b=b||new d,b.getTable()&&a.getTableName()===b.getTable()||b.setTable(a.getTableName()),this.execute(b.getSelectQuery(this))},fromResult:function(a,b){return a.inflateArray(b)},countAll:function(a,b){b=b instanceof d?b:new d(b),b.getTable()&&a.getTableName()===b.getTable()||b.setTable(a.getTableName());var c=this.execute(b.getCountQuery(this));return parseInt(c[0],10)||0},removeAll:function(a,b){return b.getTable()&&a.getTableName()===b.getTable()||b.setTable(a.getTableName()),this.emptyCache(a._table),this.execute(b.getDeleteQuery(this)).rowsAffected},select:function(a,b){return b=b instanceof d?b:new d(b),this.fromResult(a,this.selectRS(a,b))},updateAll:function(a,b,c){var e,f,g=this.quoteIdentifier(a.getTableName()),h=[],i=[],j=new d.Statement(this),k=c.getWhereClause(this);for(e in b)h.push(this.quoteIdentifier(e)+" = ?"),i.push(b[e]);if(0===h.length)return 0;f="UPDATE "+g+" SET "+h.join(", ")+" WHERE "+k.getString(),j.setString(f),j.setParams(i),j.addParams(k.getParams());var l=this.execute(j);return this.emptyCache(a._table),l.rowsAffected||0},insert:function(a){var b,c,e,f,g,h=a.constructor,i=h.getKey(),j=[],k=[],l=[],m=new d.Statement(this);for(c in h._fields){var n=h._fields[c];e=a[c],h.isTemporalType(n.type)&&(e=this.formatDate(e,n.type)),(null!==e||a.isModified(c))&&(j.push(c),k.push(e),l.push("?"))}return b="INSERT INTO "+h.getTableName()+" ("+j.join(",")+") VALUES ("+l.join(",")+") ",m.setString(b),m.setParams(k),f=this.execute(m),i&&h.isAutoIncrement()&&(g=this.lastInsertId(),null!==g&&(a[i]=g)),a.resetModified(),a.setNew(!1),i&&a[i]&&this.cache(h._table,a[i],a),f.rowsAffected},update:function(a){var b,c,e,f,g,h,i={},j=new d,k=a.constructor,l=k.getKeys(),m=a.getModified();if(!a.isModified())return 0;if(0===l.length)throw new Error("This table has no primary keys");for(e in m){var n=k._fields[e];h=a[e],k.isTemporalType(n.type)&&(h=this.formatDate(h,n.type)),i[e]=h}for(b=0,c=l.length;c>b;++b){if(f=l[b],g=a[f],null===g)throw new Error("Cannot remove using NULL primary key.");j.and(f,g)}var o=this.updateAll(k,i,j);return a.resetModified(),o},remove:function(a){var b,c,e,f,g=a.constructor,h=g.getKeys(),i=new d;if(0===h.length)throw new Error("This table has no primary keys");for(b=0,c=h.length;c>b;++b){if(e=h[b],f=a[e],null===f)throw new Error("Cannot remove using NULL primary key.");i.and(e,f)}return this.removeAll(g,i)}});e.Migration=dabl.Class.extend({adapter:null,schema:null,init:function(a){this.adapter=a,this.schema=c.extend("schema_definitions",{adapter:a,fields:{id:{type:c.FIELD_TYPE_INTEGER,computed:!0,key:!0},table_name:c.FIELD_TYPE_TEXT,column_names:c.FIELD_TYPE_INTEGER,column_types:c.FIELD_TYPE_INTEGER}})},migrate:function(a){a||(a={});var b,d,e,f,g={};if(a.refresh){for(b in c.models)this.adapter.execute("DROP TABLE IF EXISTS "+b);this.setupSchema(!0)}else this.setupSchema();if(this.adapter.migrations&&(g=this.adapter.migrations),g[1]&&g[1].constructor===Object){d=this.currentSchemaVersion(),e=1/0,null!==a.number&&"undefined"!=typeof a.number?e=a.number:"number"==typeof a&&(e=a),f=d;do{if(f===e)return;if(e>f){if(f+=1,null===g[f]||"undefined"==typeof g[f])break;g[f].up()}else g[f].down(),f-=1;this.updateSchemaVersion(f)}while(g[f])}a&&a.refresh&&this.loadFixtures()},setupSchema:function(a){var b;this.createTable("schema_migrations",{version:c.FIELD_TYPE_TEXT}),0===this.adapter.count("SELECT * FROM schema_migrations")&&(b="INSERT INTO schema_migrations (version) VALUES(0)",this.adapter.execute(b)),a&&1===this.adapter.count("SELECT * FROM schema_migrations")&&(b="UPDATE schema_migrations set version = 0",this.adapter.execute(b)),this.createTable("schema_definitions",{id:c.FIELD_TYPE_INTEGER,table_name:c.FIELD_TYPE_TEXT,column_names:c.FIELD_TYPE_INTEGER,column_types:c.FIELD_TYPE_INTEGER})},writeSchema:function(a,b){if("schema_definitions"!==a&&"schema_migrations"!==a){var c,d,e,f=[],g=[];for(var h in b)f.push(h),g.push(b[h]);c=f.join(),d=f.join(),e=this.schema.findBy("table_name",a),e?(e.column_names=c,e.column_types=d,e.save()):(e=new this.schema,e.fromJSON({table_name:a,column_names:c,column_types:d}),e.save())}},readSchema:function(a){if("schema_definitions"===a||"schema_migrations"===a)return null;for(var b,c=this.schema.findBy("table_name",a),d=c.column_names.split(","),e=c.column_types.split(","),f={},g=0,h=d.length;h>g;++g)b=d[g],f[b]=e[g];return f},currentSchemaVersion:function(){var a="SELECT version FROM schema_migrations LIMIT 1";return parseInt(this.adapter.execute(a)[0].version,10)},updateSchemaVersion:function(a){var b="UPDATE schema_migrations SET version = "+a;return this.adapter.execute(b)},modifyColumn:function(a,b,d){if(!d)throw new Error("MIGRATION_EXCEPTION: Not a valid column modification");var e,f,g=this.readSchema(a),h={};for(e in g)switch(f=g[e],d.modification){case"remove":e!==b&&(h[e]=f);break;case"rename":e!==b?h[e]=f:h[d.newName]=f;break;case"change":h[e]=e!==b?f:d.newType;break;default:throw"MIGRATION_EXCEPTION: Not a valid column modification"}this.adapter.transaction(function(){var e=this.adapter.execute("SELECT * FROM "+a);if(0!==e.length)throw new Error("Modify column not quite ready yet...");this.dropTable(a),this.createTable(a,h);for(var f=0,g=e.length;g>f;++f){var i=e[f];switch(d.modification){case"remove":delete i[b],c.insert(a,i);break;case"rename":i[d.newName]=i[b],delete i[b],c.insert(a,i);break;case"change":c.insert(a,i);break;default:throw"MIGRATION_EXCEPTION: Not a valid column modification"}}})},createTable:function(a,b){if(a&&b){var d,e,f="CREATE TABLE IF NOT EXISTS "+a+"\n",g=0;f+="(";for(d in b)e=b[d],0!==g&&(f+=",\n"),f+=d+" "+e,e===c.FIELD_TYPE_INTEGER&&"id"===d&&(f+=" PRIMARY KEY AUTOINCREMENT"),++g;f+=")",this.adapter.execute(f),this.writeSchema(a,b)}},dropTable:function(a){var b,c="DROP TABLE IF EXISTS "+a;this.adapter.execute(c),b=this.schema.findBy("table_name",a),b.remove()},renameTable:function(a,b){var c,d="ALTER TABLE "+a+" RENAME TO "+b;this.adapter.execute(d),c=this.schema.findBy("table_name",a),c.table_name=b,c.save()},addColumn:function(a,b,c){var d,e="ALTER TABLE "+a+" ADD COLUMN "+b+" "+c;this.adapter.execute(e),d=this.readSchema(a),d[b]=c,this.writeSchema(a,d)},removeColumn:function(a,b){return this.modifyColumn(a,b,{modification:"remove"})},renameColumn:function(a,b,c){var d={modification:"rename",newName:c};return this.modifyColumn(a,b,d)},changeColumn:function(a,b,c){var d={modification:"change",newType:c};return this.modifyColumn(a,b,d)},addIndex:function(a,b,c){var d="CREATE"+(c?" UNIQUE ":" ")+"INDEX IF NOT EXISTS "+a+"_"+b+"_index ON "+a+" ("+b+")";return this.adapter.execute(d)},removeIndex:function(a,b){var c="DROP INDEX IF EXISTS "+a+"_"+b+"_index";return this.adapter.execute(c)},loadFixtures:function(){}}),e.TiDebugDB=dabl.Class.extend({lastInsertRowId:null,rowsAffected:null,lastSQL:null,lastParams:null,execute:function(a,b){return"undefined"!=typeof console&&console.log(a,b),this.lastSQL=a,this.lastParams=b,0===a.toUpperCase().indexOf("INSERT")&&(null===this.lastInsertRowId?this.lastInsertRowId=1:++this.lastInsertRowId,this.rowsAffected=1),(0===a.toUpperCase().indexOf("DELETE")||0===a.toUpperCase().indexOf("UPDATE"))&&(this.rowsAffected=1),{sql:a,params:b,isValidRow:function(){return!1},getRowCount:function(){return 0},getFieldCount:function(){return 0},getFieldName:function(){return""},field:function(){return""},next:function(){},close:function(){}}}}),dabl.SQLAdapter=e}({},function(){return this}());