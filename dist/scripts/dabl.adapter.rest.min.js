!function(a,b){function c(a){return d(a,!0).replace(/%26/gi,"&").replace(/%3D/gi,"=").replace(/%2B/gi,"+")}function d(a,b){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(b?null:/%20/g,"+")}function e(a,b){this.template=a,this.defaults=b||{};for(var c=this.urlParams={},d=a.split(/\W/),e=0,f=d.length;e<f;++e){var g=d[e];!new RegExp("^\\d+$").test(g)&&g&&new RegExp("(^|[^\\\\]):"+g+"(\\W|$)").test(a)&&(c[g]=!0)}this.template=a.replace(/\\:/g,":")}e.prototype={url:function(a){var b,d,e=this,f=this.template;a=a||{};for(var g in this.urlParams)b=void 0!==a[g]||a.hasOwnProperty(g)?a[g]:e.defaults[g],void 0!==b&&null!==b?(d=c(b),f=f.replace(new RegExp(":"+g+"(\\W|$)","g"),d+"$1")):(f=f.replace(new RegExp("(/?):"+g+"(\\W|$)","g"),function(a,b,c){return"/"===c.charAt(0)?c:b+c}),f=("/"===f.charAt(0)&&"."===f.charAt(1)?"/":"")+f.replace("/.","."));return f},urlGet:function(a){var b=this.url(a);a=a||{};var c={};for(var d in a)a.hasOwnProperty(d)&&!this.urlParams[d]&&(c[d]=a[d]);var e=dabl.serialize(c);return(b=b.replace(/\/*$/,""))+(e.length?"?"+e:"")}};var f=dabl.Adapter.extend({_routes:{},_urlBase:"",init:function(a){this._super(),a&&(this._urlBase=a)},_getRoute:function(a){if(!a)throw new Error("Cannot create RESTful route for empty url.");return this._routes[a]?this._routes[a]:this._routes[a]=new e(this._urlBase+a)},_getErrorCallback:function(a){return function(b,c,d){var e;try{e=b.responseText?JSON.parse(b.responseText):null}catch(a){e=null}var f=d||"Request failed.";e&&(e.error?f=e.error:e.errors&&(f=e.errors.join("\n"))),a.reject(f,e,b)}},_isValidResponseObject:function(a,b){var c=b.getKey();return!(null===a||void 0===a||"object"!=typeof a||a.error||a.errors&&0!==a.errors.length||c&&void 0===a[c])},_save:function(a,b){var c,d,e=a.constructor,f=this._getRoute(e._url),g={},h=e.getKey(),i=this,j=dabl.Deferred(),k=this._getErrorCallback(j);for(c in e._fields){var l=e._fields[c];d=a[c],e.isTemporalType(l.type)&&(d=this.formatDate(d,l.type)),g[c]=d}return jQuery.ajax({url:f.url(g),type:"POST",data:JSON.stringify(g),contentType:"application/json;charset=utf-8",dataType:"json",headers:{"X-HTTP-Method-Override":b},success:function(b,c,d){if(!i._isValidResponseObject(b,e))return void k(d,c,"Invalid response.");a.fromJSON(b).resetModified().setNew(!1),h&&void 0!==a[h]&&i.cache(e._table,a[h],a),j.resolve(a)},error:k}),j.promise()},formatDateTime:function(a){if(!a)return null;a instanceof Date||(a=dabl.constructDate(a));var b=-a.getTimezoneOffset()/60;return b=(b>0?"+":"-")+dabl.sPad(Math.abs(b)),a.getFullYear()+"-"+dabl.sPad(a.getMonth()+1)+"-"+dabl.sPad(a.getDate())+" "+dabl.sPad(a.getHours())+":"+dabl.sPad(a.getMinutes())+":"+dabl.sPad(a.getSeconds())+" "+b+"00"},insert:function(a){return this._save(a,"POST")},update:function(a){if(!a.isModified()){var b=dabl.Deferred();return b.resolve(a),b.promise()}return this._save(a,"PUT")},remove:function(a){var b=a.constructor,c=this._getRoute(b._url),d=b.getKey(),e=this,f=dabl.Deferred(),g=this._getErrorCallback(f);return jQuery.ajax({url:c.url(a.toJSON()),type:"POST",data:{},contentType:"application/json;charset=utf-8",dataType:"json",headers:{"X-HTTP-Method-Override":"DELETE"},success:function(c,h,i){if(c&&(c.error||c.errors&&c.errors.length))return void g(i,h,"Invalid response.");d&&a[d]&&e.cache(b._table,a[d],null),f.resolve(a)},error:g}),f.promise()},find:function(a,b){var c,d=this._getRoute(a._url),e={},f=null,g=dabl.Deferred(),h=this._getErrorCallback(g),i=this,j=a.getKey();if(!j||2!==arguments.length||"number"!=typeof b&&"string"!=typeof b)c=this.findQuery.apply(this,arguments),c.limit(1),e=c.getSimpleJSON();else{if(f=this.cache(a._table,b))return g.resolve(f),g.promise();e={},e[j]=b}return jQuery.get(d.urlGet(e),function(b,c,d){if(!i._isValidResponseObject(b,a))return void h(d,c,"Invalid response.");b instanceof Array&&(b=b.shift()),g.resolve(a.inflate(b))}).fail(h),g.promise()},findAll:function(a){var b=this.findQuery.apply(this,arguments),c=this._getRoute(a._url),d=b.getSimpleJSON(),e=dabl.Deferred(),f=this._getErrorCallback(e);return jQuery.get(c.urlGet(d),function(b,c,d){if(null===b||void 0===b||"object"!=typeof b||b.error||b.errors&&b.errors.length)return void f(d,c,"Invalid response.");b instanceof Array||(b=[b]),e.resolve(a.inflateArray(b))}).fail(f),e.promise()},countAll:function(a){var b=this.findQuery.apply(this,arguments).setAction(dabl.Query.ACTION_COUNT),c=this._getRoute(a._url),d=b.getSimpleJSON(),e=dabl.Deferred(),f=this._getErrorCallback(e);return jQuery.get(c.urlGet(d),function(a,b,c){if(null===a||void 0===a||isNaN(parseInt(a.total,10))||"object"!=typeof a||a.error||a.errors&&a.errors.length)return void f(c,b,"Invalid response.");e.resolve(parseInt(a.total,10))}).fail(f),e.promise()}});dabl.RESTAdapter=f,dabl.RESTAdapter.Route=e,b.true=a}({},function(){return this}());